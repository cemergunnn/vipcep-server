// DOSYA ADI: server.js (T√ºm √∂zellikler tamamlandƒ±)

const WebSocket = require('ws');
const express = require('express');
const http = require('http');
const cors = require('cors');
const path = require('path');
const crypto = require('crypto');
const session = require('express-session');
const { Pool } = require('pg');

// Database connection
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

// Express setup
const app = express();
const server = http.createServer(app);
const PORT = process.env.PORT || 8080;

// Security configuration
const SECURITY_CONFIG = {
    SUPER_ADMIN_PATH: '/panel-admin',
    NORMAL_ADMIN_PATH: '/desk-admin',
    CUSTOMER_PATH: '/app-customer',
    SESSION_SECRET: process.env.SESSION_SECRET || crypto.randomBytes(32).toString('hex'),
    TOTP_ISSUER: 'VIPCEP System',
    TOTP_WINDOW: 2
};

// Middleware
app.use(session({
    secret: SECURITY_CONFIG.SESSION_SECRET,
    resave: false, // Daha verimli oturum y√∂netimi i√ßin false olarak ayarlandƒ±
    saveUninitialized: false, // Sadece giri≈ü yapƒ±ldƒ±ƒüƒ±nda oturum olu≈ütur
    cookie: { 
        secure: process.env.NODE_ENV === 'production', // Production'da true olmalƒ±
        httpOnly: true, 
        maxAge: 24 * 60 * 60 * 1000 // Varsayƒ±lan oturum s√ºresi: 1 g√ºn
    }
}));

app.use(cors());
app.use(express.json());
// Statik dosyalar i√ßin express.static middleware'i en ba≈üa ta≈üƒ±mak daha iyidir.
// Proje k√∂k dizinindeki dosyalarƒ± sunar (√∂rn: cash.mp3, css/style.css vb.)
app.use(express.static(__dirname));


// WebSocket server
const wss = new WebSocket.Server({ server });

// Global variables
const clients = new Map();
const activeHeartbeats = new Map();
const activeCallAdmins = new Map();
const activeCalls = new Map();
const adminCallbacks = new Map();
const adminLocks = new Map();
let currentAnnouncement = null;
const HEARTBEAT_INTERVAL = 60000;

// ================== HELPER FUNCTIONS ==================

function anonymizeCustomerName(fullName) {
    if (!fullName || typeof fullName !== 'string') {
        return 'Anonim';
    }
    const parts = fullName.trim().split(' ');
    if (parts.length === 1) {
        return parts[0];
    }
    const firstName = parts[0];
    const lastInitial = parts[parts.length - 1].charAt(0).toUpperCase();
    return `${firstName} ${lastInitial}.`;
}

function broadcastSystemStateToSuperAdmins() {
    const activeCallDetails = [];
    for (const [adminId, callInfo] of activeCallAdmins.entries()) {
        const adminClient = Array.from(clients.values()).find(c => c.uniqueId === adminId);
        const customerClient = clients.get(callInfo.customerId);
        activeCallDetails.push({
            adminName: adminClient ? adminClient.name : adminId,
            customerName: customerClient ? customerClient.name : callInfo.customerId,
            startTime: callInfo.callStartTime
        });
    }

    const state = {
        activeCalls: activeCallDetails,
        onlineAdmins: Array.from(clients.values()).filter(c => c.userType === 'admin').length,
        onlineCustomers: Array.from(clients.values()).filter(c => c.userType === 'customer').length,
    };
    
    const message = JSON.stringify({
        type: 'system-state-update',
        state: state
    });

    clients.forEach(client => {
        if (client.userType === 'super-admin' && client.ws && client.ws.readyState === WebSocket.OPEN) {
            client.ws.send(message);
        }
    });
}

async function broadcastEarningsUpdateToAdmin(adminUsername, sourceInfo = null) {
    try {
        const result = await pool.query('SELECT total_earned FROM admin_earnings WHERE username = $1', [adminUsername]);
        const newEarnings = result.rows[0]?.total_earned || 0;

        const adminClient = Array.from(clients.values()).find(c => c.id === adminUsername && c.userType === 'admin');
        if (adminClient && adminClient.ws && adminClient.ws.readyState === WebSocket.OPEN) {
            adminClient.ws.send(JSON.stringify({
                type: 'admin-earning-update',
                newEarnings: newEarnings,
                sourceInfo: sourceInfo 
            }));
        }
    } catch (error) {
        console.error(`Kazan√ß g√ºncellemesi g√∂nderilemedi (${adminUsername}):`, error);
    }
}


function findActiveCall(userId1, userId2) {
    if (!userId1 || !userId2) return null;
    const key1 = `${userId1}-${userId2}`;
    const key2 = `${userId2}-${userId1}`;
    return activeCalls.get(key1) || activeCalls.get(key2);
}

// ... (Diƒüer helper fonksiyonlarƒ±nƒ±zda deƒüi≈üiklik yok) ...

// ================== AUTHENTICATION FUNCTIONS ==================
// ... (Bu b√∂l√ºmdeki fonksiyonlarda deƒüi≈üiklik yok) ...

// ================== DATABASE FUNCTIONS ==================
// ... (Bu b√∂l√ºmdeki fonksiyonlarda deƒüi≈üiklik yok) ...

// ================== HEARTBEAT FUNCTIONS ==================
// ... (Bu b√∂l√ºmdeki fonksiyonlarda deƒüi≈üiklik yok, i√ßindeki broadcastEarningsUpdateToAdmin √ßaƒürƒ±sƒ± hari√ß) ...

// ================== MIDDLEWARE FOR AUTH ==================

const requireNormalAdminLogin = (req, res, next) => {
    if (req.session && req.session.normalAdmin) {
        return next();
    } else {
        res.redirect('/');
    }
};

const requireSuperAdminLogin = (req, res, next) => {
    if (req.session && req.session.superAdmin) {
        return next();
    } else {
        res.redirect('/');
    }
};


// ================== ROUTES ==================

// YENƒ∞: G√ºncellenmi≈ü Ana Giri≈ü Sayfasƒ±
app.get('/', (req, res) => {
    if (req.session.superAdmin) {
        return res.redirect(SECURITY_CONFIG.SUPER_ADMIN_PATH);
    }
    if (req.session.normalAdmin) {
        return res.redirect(SECURITY_CONFIG.NORMAL_ADMIN_PATH);
    }

    // Artƒ±k `index.html` dosyasƒ± olmadƒ±ƒüƒ± i√ßin HTML'i burada olu≈üturuyoruz
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>üîê VIPCEP G√ºvenli Giri≈ü</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: system-ui; background: linear-gradient(135deg, #1e293b, #334155); color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
                .login-container { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); max-width: 400px; width: 100%; }
                .form-group { margin-bottom: 20px; }
                .form-input { width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 16px; box-sizing: border-box; }
                .form-input::placeholder { color: rgba(255,255,255,0.6); }
                .form-input:focus { outline: none; border-color: #dc2626; }
                .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; transition: all 0.3s ease; }
                .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
                .btn:disabled { opacity: 0.6; cursor: not-allowed; }
                .btn-customer { background: linear-gradient(135deg, #059669, #047857); }
                .title { text-align: center; margin-bottom: 30px; color: #dc2626; font-size: 24px; font-weight: bold; }
                .twofa-section { display: none; }
                .twofa-section.active { display: block; }
                .twofa-code { text-align: center; font-size: 18px; letter-spacing: 3px; font-family: monospace; }
                .back-btn { background: linear-gradient(135deg, #64748b, #475569); }
                .error-msg { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-size: 14px; }
                .success-msg { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); color: #86efac; padding: 10px; border-radius: 6px; margin: 10px 0; text-align: center; font-size: 14px; }
                .loading { opacity: 0.7; pointer-events: none; }
                .twofa-info { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #93c5fd; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 13px; text-align: center; }
                .remember-me { display: flex; align-items: center; gap: 8px; font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="login-container">
                <div class="title">üîê VIPCEP</div>

                <div id="step1">
                    <div class="form-group">
                        <input type="text" id="username" class="form-input" placeholder="üë§ Kullanƒ±cƒ± Adƒ±">
                    </div>
                    <div class="form-group">
                        <input type="password" id="password" class="form-input" placeholder="üîë ≈ûifre">
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMeAdmin">
                        <label for="rememberMeAdmin">Beni Hatƒ±rla (30 G√ºn)</label>
                    </div>
                    <button class="btn" id="superAdminBtn" onclick="startSuperLogin()">üî¥ SUPER ADMƒ∞N Gƒ∞Rƒ∞≈ûƒ∞</button>
                    <button class="btn" onclick="normalAdminLogin()">üü° ADMƒ∞N Gƒ∞Rƒ∞≈ûƒ∞</button>
                    <button class="btn btn-customer" onclick="window.location.href='${SECURITY_CONFIG.CUSTOMER_PATH}'">üü¢ M√ú≈ûTERƒ∞ UYGULAMASI</button>
                </div>

                <div id="step2" class="twofa-section">
                     </div>

                <div id="messageArea"></div>
            </div>

            <script>
                let currentStep = 1;
                let currentUsername = '';
                let currentPassword = '';

                // ... (showMessage, setLoading, goToStep2, goBackToStep1 fonksiyonlarƒ± deƒüi≈ümedi)

                async function startSuperLogin() { /* ... Bu fonksiyon deƒüi≈ümedi */ }
                async function verify2FA() { /* ... Bu fonksiyon deƒüi≈ümedi */ }

                async function normalAdminLogin() {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const rememberMe = document.getElementById('rememberMeAdmin').checked; // YENƒ∞
                    if (!username || !password) return showMessage('Kullanƒ±cƒ± adƒ± ve ≈üifre gerekli!');

                    setLoading(true);

                    try {
                        const response = await fetch('/auth/admin-login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password, rememberMe }) // YENƒ∞: Beni hatƒ±rla bilgisi g√∂nderiliyor
                        });
                        const result = await response.json();
                        if (result.success) {
                            showMessage('Giri≈ü ba≈üarƒ±lƒ±!', 'success');
                            setTimeout(() => {
                                window.location.href = result.redirectUrl;
                            }, 1000);
                        } else {
                            showMessage(result.error || 'Giri≈ü ba≈üarƒ±sƒ±z!');
                        }
                    } catch (error) {
                        showMessage('Baƒülantƒ± hatasƒ±!');
                    }

                    setLoading(false);
                }
                
                // ... (Diƒüer script kodlarƒ± deƒüi≈ümedi)
            </script>
        </body>
        </html>
    `);
});

// YENƒ∞: G√ºncellenmi≈ü Admin Giri≈ü Rotasƒ±
app.post('/auth/admin-login', async (req, res) => {
    const { username, password, rememberMe } = req.body; // rememberMe eklendi
    const clientIP = req.ip || req.connection.remoteAddress;

    try {
        const rateStatus = await checkRateLimit(clientIP, 'admin');
        if (!rateStatus.allowed) {
            return res.status(429).json({ success: false, error: '√áok fazla ba≈üarƒ±sƒ±z deneme!' });
        }

        const admin = await authenticateAdmin(username, password);
        if (admin && admin.role === 'normal') {
            // Oturum bilgilerini ata
            req.session.normalAdmin = { id: admin.id, username: admin.username, loginTime: new Date() };
            
            // "Beni Hatƒ±rla" se√ßiliyse, oturumun √∂mr√ºn√º uzat
            if (rememberMe) {
                req.session.cookie.maxAge = 30 * 24 * 60 * 60 * 1000; // 30 G√ºn
            }
            
            res.json({ success: true, redirectUrl: SECURITY_CONFIG.NORMAL_ADMIN_PATH });
        } else {
            await recordFailedLogin(clientIP, 'admin');
            res.status(401).json({ success: false, error: 'Ge√ßersiz kullanƒ±cƒ± adƒ± veya ≈üifre!' });
        }
    } catch (error) {
        res.status(500).json({ success: false, error: 'Sistem hatasƒ±!' });
    }
});


// ... (Diƒüer t√ºm rotalarƒ±nƒ±z ve WebSocket mantƒ±ƒüƒ±nƒ±z √∂nceden g√ºncellendiƒüi gibi kalƒ±r) ...


// ================== SERVER STARTUP ==================
// ... (Sunucu ba≈ülatma kodunuzda deƒüi≈üiklik yok) ...

startServer().catch(error => {
    console.log('‚ùå Server ba≈ülatma hatasƒ±:', error.message);
    process.exit(1);
});
