<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Müşteri Uygulaması</title>
    <style>
            :root {
                --primary-color: #2563eb;    /* Logo mavisi */
                --primary-dark: #1e40af;     /* Koyu mavi */
                --primary-light: #dbeafe;    /* Açık mavi */
                --star-color: #f59e0b;
            }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 100%;
            max-width: 380px;
            position: relative;
        }
        
        .app-header {
            background: linear-gradient(135deg, #2563eb, #16a34a);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-connected { 
            background: #22c55e; 
        }
        .status-disconnected { 
            background: #ef4444; 
        }
        
        .logo {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 10px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .app-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .app-content {
            padding: 20px;
        }

        /* KVKK Onay Ekranı */
        .kvkk-screen {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .kvkk-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            text-align: center;
        }

        .kvkk-content {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #2563eb;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.5;
            color: #374151;
            max-height: 450px;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .kvkk-content h4 {
            color: #1e293b;
            margin: 15px 0 8px 0;
            font-size: 15px;
        }

        .kvkk-content h4:first-child {
            margin-top: 0;
        }

        .kvkk-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .kvkk-checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f0fdf4;
            border-radius: 8px;
            border: 2px solid #bbf7d0;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .kvkk-checkbox-container:hover {
            border-color: #2563eb;
            background: #dcfce7;
        }

        .kvkk-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .kvkk-checkbox-label {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            cursor: pointer;
            user-select: none;
        }

        .kvkk-buttons {
            display: flex;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .user-id-input {
            text-align: center;
            font-weight: bold;
            font-size: 24px;
            letter-spacing: 2px;
            font-family: monospace;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #2563eb, #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-kvkk-accept {
            background: linear-gradient(135deg, #2563eb, #16a34a);
            color: white;
            flex: 1;
        }

        .btn-kvkk-decline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            flex: 1;
        }
        
        .user-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 3px solid var(--primary-color);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 14px;
        }
        
        .credits-value {
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .call-status {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .call-timer {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-color);
            margin: 20px 0;
            font-family: monospace;
        }
        
        .hidden {
            display: none !important;
        }
        
        .footer {
            background: #f8fafc;
            padding: 15px;
            text-align: center;
            font-size: 11px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Usta Listesi Stilleri */
        .admin-list-container { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .admin-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .admin-card.available:hover { border-color: #16a34a; background: #f0fdf4; }
        .admin-card.busy { opacity: 0.7; background: #f1f5f9; }
        .admin-avatar img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .admin-details { flex-grow: 1; }
        .admin-name { font-weight: 700; color: #1e293b; }
        .admin-specialization { font-size: 13px; color: #64748b; margin: 2px 0; }
        .admin-rating { font-size: 13px; color: var(--star-color); font-weight: 600; }
        .admin-actions { display: flex; flex-direction: column; gap: 8px; }
        .btn-small { padding: 8px 12px; font-size: 12px; font-weight: 600; border-radius: 8px; flex-shrink: 0; }
        .btn-call { background: #16a34a; color: white; }
        .btn-callback { background: #f59e0b; color: white; }
        .btn-details { background: #64748b; color: white; }

        /* Modal Stilleri */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 15px;
        }
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 15px; }
        .modal-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .modal-title { font-size: 18px; font-weight: 700; color: #1e293b; }
        .modal-subtitle { font-size: 14px; color: #64748b; }
        .modal-body { padding: 20px; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; }

        /* Yorum Stilleri */
        .reviews-list .review-item { padding: 15px; border-bottom: 1px solid #e5e7eb; }
        .review-item:last-child { border-bottom: none; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .review-author { font-weight: 600; font-size: 14px; }
        .review-rating { color: var(--star-color); }
        .review-comment { font-size: 14px; color: #4b5563; line-height: 1.5; }
        .review-tip { font-size: 13px; font-weight: 600; color: #16a34a; margin-top: 8px; }

        /* Değerlendirme Modal Stilleri */
        .rating-stars { display: flex; justify-content: center; gap: 10px; font-size: 32px; color: #d1d5db; margin: 20px 0; }
        .rating-stars .star { cursor: pointer; transition: color 0.2s; }
        .rating-stars .star:hover, .rating-stars .star.selected { color: var(--star-color); }
        .review-textarea { width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; margin-bottom: 15px; font-family: inherit; }
        .tip-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .tip-btn { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 10px; border-radius: 8px; cursor: pointer; }
        .tip-btn.selected { background: #16a34a; color: white; border-color: #16a34a; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="connection-status">
                <div class="status-dot status-disconnected" id="connectionDot"></div>
                <span id="connectionText">Bağlanıyor...</span>
            </div>
            <div class="logo">
                <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
            </div>
            <div class="app-title">USTAMA SOR</div>
            <div class="app-subtitle">Teknik Servis Danışmanlığı</div>
        </div>
        
        <div id="kvkkScreen" class="kvkk-screen">
            <div class="kvkk-title">📋 Kişisel Verilerin Korunması Hakkında Bilgilendirme</div>
            <div class="kvkk-content">
                <h4>1. Veri İşleme ve Gizlilik</h4>
                <p>Bu hizmet kapsamında kullanıcıların sesli görüşmeleri kayıt altına alınmamaktadır. Görüşme içerikleri tarafımızca saklanmaz, üçüncü kişilerle paylaşılmaz.</p>
                <h4>2. Anonim Kullanım</h4>
                <p>Sistemi kullanmak için kimlik, ad-soyad, telefon numarası, e-posta gibi herhangi bir kişisel bilgi talep edilmez veya saklanmaz. Kullanıcılar tamamen anonim olarak hizmetten yararlanır.</p>
                <h4>3. KVKK Uyarısı</h4>
                <p>6698 sayılı Kişisel Verilerin Korunması Kanunu kapsamında, sistem yalnızca teknik gerekli anonim bilgileri (tarayıcı tipi, bağlantı süresi) geçici işler. Bu veriler kimliğinizi tespit etmez ve kısa süre saklanır.</p>
                <h4>4. Kullanıcı Sorumluluğu</h4>
                <p>Bu hizmet, teknik destek amacıyla sunulur. Görüşme esnasında kullanıcı tarafından iletilen her türlü bilgi, belge veya kişisel veri paylaşımı tamamen kullanıcının kendi sorumluluğundadır.</p>
                <h4>5. Onay</h4>
                <p>Bu metni onaylayarak:</p>
                <ul>
                    <li>Ses kayıtlarının tutulmayacağını,</li>
                    <li>Kimliğimin tespitine imkân verecek herhangi bir bilginin talep edilmediğini,</li>
                    <li>Görüşme sırasında kendi isteğimle paylaşacağım bilgilerden yalnızca kendimin sorumlu olacağımı</li>
                </ul>
                <p>kabul ve beyan ediyorum.</p>
            </div>
            <div class="kvkk-checkbox-container">
                <input type="checkbox" id="kvkkCheckbox" class="kvkk-checkbox">
                <label for="kvkkCheckbox" class="kvkk-checkbox-label">Okudum, anladım, onaylıyorum</label>
            </div>
            <div class="kvkk-buttons">
                <button class="btn btn-kvkk-decline" onclick="declineKVKK()">Reddet</button>
                <button class="btn btn-kvkk-accept" id="kvkkAcceptBtn" disabled onclick="acceptKVKK()">Onaylıyorum</button>
            </div>
        </div>

        <div class="app-content hidden" id="appContent">
            <div id="loginScreen">
                <div class="form-group">
                    <label class="form-label">4 Haneli ID Kodunuz</label>
                    <input type="text" class="form-input user-id-input" id="userIdInput" placeholder="0000" maxlength="4" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Ad Soyad</label>
                    <input type="text" class="form-input" id="userNameInput" placeholder="Adınız ve Soyadınız">
                </div>
                <button class="btn btn-login" id="loginButton" onclick="loginUser()">Giriş Yap</button>
                <div id="loginMessage"></div>
            </div>
            
            <div id="mainApp" class="hidden">
                <div class="user-info">
                    <div class="info-grid">
                        <div class="info-item"><div class="info-label">Kullanıcı</div><div class="info-value" id="displayUserName">-</div></div>
                        <div class="info-item"><div class="info-label">ID</div><div class="info-value" id="displayUserId">-</div></div>
                        <div class="info-item"><div class="info-label">Kredi Bakiye</div><div class="info-value credits-value" id="displayUserCredits">-</div></div>
                        <div class="info-item"><div class="info-label">Durum</div><div class="info-value" id="displayUserStatus">Hazır</div></div>
                    </div>
                </div>

                <div id="callSection">
                    <h3 style="font-size: 16px; color: #374151; margin-bottom: 15px; text-align: center;">Görüşmek İstediğiniz Ustayı Seçin</h3>
                    <div class="admin-list-container" id="adminList">
                        <!-- Usta kartları buraya gelecek -->
                    </div>
                </div>
                
                <div id="connectingState" class="hidden call-status">
                    <h3 style="font-size: 18px; color: var(--primary-color);">Bağlanılıyor...</h3>
                    <p style="color: #64748b;">Lütfen bekleyin.</p>
                </div>
                <div id="connectedState" class="hidden call-status">
                    <h3 style="font-size: 18px; color: #16a34a;">Görüşme Aktif</h3>
                    <div class="call-timer" id="callTimer">00:00</div>
                    <button class="btn btn-logout" onclick="endCall()">Görüşmeyi Bitir</button>
                </div>
                 <div id="incomingState" class="hidden call-status">
                    <!-- Gelen arama içeriği JS ile eklenecek -->
                </div>


                <button class="btn btn-logout" onclick="logoutUser()" style="margin-top: 20px;">Çıkış Yap</button>
            </div>
        </div>
        
        <div class="footer">VIPCEP Teknik Servis © 2025</div>
    </div>
    
    <div id="modalContainer"></div>

    <audio id="localAudio" muted></audio>
    <audio id="remoteAudio" autoplay></audio>
    
    <script>
        // Global Değişkenler
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let callState = 'idle'; // idle, connecting, connected, incoming
        let isLoggedIn = false;
        let userInfo = { id: '', name: '', credits: 0 };
        let availableAdmins = [];
        let lastCalledAdminId = null;
        let lastCallId = null; // Değerlendirme için
        let incomingCallInfo = null;
        let ringAudioContext = null;
        let ringOscillator = null;

        const serverUrl = window.location.hostname === 'localhost' ? 'ws://localhost:8080' : 'wss://vipcep-server-production.up.railway.app';
        const baseUrl = window.location.hostname === 'localhost' ? 'http://localhost:8080' : 'https://vipcep-server-production.up.railway.app';
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        // Başlangıç
        window.onload = function() {
            connectToServer();
            setupEventListeners();
            checkKVKKApproval();
        };

        function setupEventListeners() {
            const kvkkCheckbox = document.getElementById('kvkkCheckbox');
            const kvkkAcceptBtn = document.getElementById('kvkkAcceptBtn');
            kvkkCheckbox.addEventListener('change', () => {
                kvkkAcceptBtn.disabled = !kvkkCheckbox.checked;
            });

            document.getElementById('userIdInput').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }
        
        // KVKK İşlemleri
        function checkKVKKApproval() {
            if (localStorage.getItem('vipcep_kvkk_approved') === 'true') {
                document.getElementById('kvkkScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            } else {
                document.getElementById('kvkkScreen').classList.remove('hidden');
                 document.getElementById('appContent').classList.add('hidden');
            }
        }

        function acceptKVKK() {
            localStorage.setItem('vipcep_kvkk_approved', 'true');
            checkKVKKApproval();
        }
        
        function declineKVKK() {
            alert('Hizmeti kullanmak için koşulları kabul etmelisiniz.');
        }

        // Sunucu Bağlantısı
        function connectToServer() {
            updateConnectionStatus(false, 'Bağlanıyor...');
            socket = new WebSocket(serverUrl);
            socket.onopen = () => {
                updateConnectionStatus(true, 'Bağlı');
                if (isLoggedIn) registerUser();
            };
            socket.onclose = () => {
                updateConnectionStatus(false, 'Bağlantı kesildi');
                setTimeout(connectToServer, 3000);
            };
            socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            socket.onerror = () => updateConnectionStatus(false, 'Hata');
        }

        function updateConnectionStatus(connected, text) {
            const dot = document.getElementById('connectionDot');
            const statusText = document.getElementById('connectionText');
            dot.className = `status-dot ${connected ? 'status-connected' : 'status-disconnected'}`;
            statusText.textContent = text;
        }

        // Sunucu Mesajları
        function handleServerMessage(message) {
            console.log('📨 Sunucudan mesaj:', message.type);
            switch (message.type) {
                case 'login-response': handleLoginResponse(message); break;
                case 'admin-list-update': updateAdminList(message.admins || []); break;
                case 'call-rejected':
                case 'call-failed':
                    stopRingTone();
                    alert(message.reason || 'Arama başarısız oldu.');
                    setState('idle');
                    break;
                case 'call-accepted':
                    stopRingTone();
                    setState('connecting');
                    setupPeerConnection(false); // Offer bekle
                    break;
                case 'admin-call-request': handleIncomingAdminCall(message); break;
                case 'call-ended': handleCallEnded(message); break;
                case 'offer': handleWebRTCMessage(message); break;
                case 'answer': handleWebRTCMessage(message); break;
                case 'ice-candidate': handleWebRTCMessage(message); break;
                case 'announcement-broadcast': displayAnnouncement(message.announcement); break;
                case 'announcement-deleted':
                    const banner = document.getElementById('announcementBanner');
                    if (banner) banner.remove();
                    break;
                case 'credit-update':
                    if (message.credits !== undefined) {
                        userInfo.credits = message.credits;
                        updateUserDisplay();
                    }
                    break;
            }
        }

        // Giriş İşlemleri
        function loginUser() {
            const userId = document.getElementById('userIdInput').value.trim();
            const userName = document.getElementById('userNameInput').value.trim();
            if (!userId || !userName) return alert('ID ve Ad Soyad alanları zorunludur.');
            
            socket.send(JSON.stringify({ type: 'login-request', userId, userName }));
        }

        function handleLoginResponse(message) {
            if (message.success) {
                isLoggedIn = true;
                userInfo = { id: message.user.id, name: message.user.name, credits: message.user.credits };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                updateUserDisplay();
                registerUser();
            } else {
                alert(`Giriş başarısız: ${message.reason}`);
            }
        }
        
        function registerUser() {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'register', userId: userInfo.id, name: userInfo.name, userType: 'customer' }));
            }
        }

        function updateUserDisplay() {
            document.getElementById('displayUserName').textContent = userInfo.name;
            document.getElementById('displayUserId').textContent = userInfo.id;
            document.getElementById('displayUserCredits').textContent = `${userInfo.credits} dk`;
        }

        // Usta Listesi ve Profili
        function updateAdminList(admins) {
            availableAdmins = admins;
            const container = document.getElementById('adminList');
            if (admins.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#6b728b;">Şu anda online usta bulunmuyor.</p>';
                return;
            }
            container.innerHTML = admins.map(admin => `
                <div class="admin-card ${admin.status}">
                    <div class="admin-avatar">
                        <img src="${admin.profile_picture_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=Usta'}" alt="${admin.name}">
                    </div>
                    <div class="admin-details">
                        <div class="admin-name">${admin.name}</div>
                        <div class="admin-specialization">${admin.specialization || 'Genel Teknik Destek'}</div>
                        <div class="admin-rating">${generateStars(admin.average_rating)} (${parseFloat(admin.average_rating).toFixed(1)})</div>
                    </div>
                    <div class="admin-actions">
                        <button class="btn-small btn-details" onclick="openAdminProfileModal('${admin.id}')">Detay</button>
                        ${admin.status === 'available'
                            ? `<button class="btn-small btn-call" onclick="makeCall('${admin.id}')">Ara</button>`
                            : `<button class="btn-small btn-callback" onclick="makeCallbackRequest('${admin.id}')">Sıraya Gir</button>`
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.round(rating);
            for (let i = 0; i < 5; i++) stars += i < fullStars ? '★' : '☆';
            return stars;
        }

        async function openAdminProfileModal(adminId) {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `<div class="modal-overlay" id="profileModal"><div class="modal">Yükleniyor...</div></div>`;
            try {
                const response = await fetch(`${baseUrl}/api/admins/${adminId}/profile`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                const profile = result.profile;
                modalContainer.innerHTML = `
                    <div class="modal-overlay" id="profileModal" onclick="closeModal('profileModal')">
                        <div class="modal" onclick="event.stopPropagation()">
                            <button class="modal-close" onclick="closeModal('profileModal')">×</button>
                            <div class="modal-header">
                                <img src="${profile.profile_picture_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=Usta'}" class="modal-avatar">
                                <div>
                                    <h3 class="modal-title">${profile.username}</h3>
                                    <p class="modal-subtitle">${profile.specialization || 'Genel Destek'}</p>
                                    <div class="admin-rating">${generateStars(profile.average_rating)} (${profile.average_rating})</div>
                                </div>
                            </div>
                            <div class="modal-body">
                                <h4>Hakkında</h4>
                                <p style="font-size: 14px; color: #4b5563; line-height: 1.6; margin-bottom: 20px;">${profile.bio || 'Hakkında bilgi bulunmuyor.'}</p>
                                <h4>Değerlendirmeler (${profile.reviews.length})</h4>
                                <div class="reviews-list" style="max-height: 200px; overflow-y: auto;">
                                    ${profile.reviews.length > 0 ? profile.reviews.map(r => `
                                        <div class="review-item">
                                            <div class="review-header">
                                                <span class="review-author">${r.customer_name || 'Anonim'}</span>
                                                <span class="review-rating">${generateStars(r.rating)}</span>
                                            </div>
                                            <p class="review-comment">${r.comment || '<i>Yorum yok.</i>'}</p>
                                            ${r.tip_amount > 0 ? `<p class="review-tip">💰 ${r.tip_amount} kredi destek gönderdi!</p>` : ''}
                                        </div>`).join('') : '<p style="text-align:center; padding: 20px; color:#6b728b;">Henüz yorum yapılmamış.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
            } catch(e) {
                modalContainer.innerHTML = `<div class="modal-overlay" id="profileModal"><div class="modal">Hata: ${e.message}</div></div>`;
            }
        }

        // Arama İşlemleri
        function makeCall(adminId) {
            if (userInfo.credits <= 0) return alert('Krediniz bitti.');
            lastCalledAdminId = adminId;
            setState('connecting');
            startRingTone();
            socket.send(JSON.stringify({ type: 'direct-call-request', targetAdminId: adminId, userId: userInfo.id, userName: userInfo.name, credits: userInfo.credits }));
            setupPeerConnection(true); // Offer gönder
        }

        function makeCallbackRequest(adminId) {
            socket.send(JSON.stringify({ type: 'callback-request', targetAdminId: adminId, userId: userInfo.id, userName: userInfo.name }));
            alert('Usta meşgul. Müsait olduğunda sizi arayacak. Lütfen bekleyin.');
        }

        function handleIncomingAdminCall(message) {
            if (callState !== 'idle') return; // Zaten meşgulse yeni arama kabul etme
            incomingCallInfo = { adminId: message.adminId, adminName: message.adminName };
            setState('incoming');
            startRingTone();
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                <div class="modal-overlay" id="incomingCallModal">
                    <div class="modal" style="text-align: center;">
                        <h3>📞 Gelen Arama</h3>
                        <p style="margin: 20px 0;"><strong>${message.adminName}</strong> sizi arıyor...</p>
                        <button class="btn btn-login" onclick="acceptIncomingCall()">Kabul Et</button>
                        <button class="btn btn-logout" onclick="rejectIncomingCall()">Reddet</button>
                    </div>
                </div>`;
        }
        
        function rejectIncomingCall() {
            closeModal('incomingCallModal');
            stopRingTone();
            setState('idle');
            // Sunucuya bilgi gönderilebilir (opsiyonel)
        }

        function acceptIncomingCall() {
            closeModal('incomingCallModal');
            stopRingTone();
            if (!incomingCallInfo) return;
            lastCalledAdminId = incomingCallInfo.adminId;
            socket.send(JSON.stringify({ type: 'accept-incoming-call', adminId: lastCalledAdminId, userId: userInfo.id }));
            setupPeerConnection(false); // Offer bekle
            setState('connecting');
        }

        function handleCallEnded(message) {
            stopRingTone();
            cleanupCall();
            setState('idle');
            if (message.adminId) {
                 setTimeout(() => openReviewModal(message), 500);
            }
        }

        // WebRTC İşlemleri
        async function setupPeerConnection(createOffer) {
            if(peerConnection) cleanupCall();
            peerConnection = new RTCPeerConnection(rtcConfig);
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            } catch (err) {
                console.error("Mikrofon hatası:", err);
                alert("Görüşme için mikrofon izni vermeniz gerekmektedir.");
                setState('idle');
                return;
            }

            peerConnection.ontrack = event => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
                setState('connected');
            };
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate, targetId: lastCalledAdminId }));
                }
            };
            peerConnection.onconnectionstatechange = () => {
                const state = peerConnection.connectionState;
                console.log("Bağlantı durumu:", state);
                if (state === 'connected') {
                    stopRingTone();
                    setState('connected');
                }
                 if (state === 'failed' || state === 'disconnected' || state === 'closed') {
                    handleCallEnded({reason: 'Bağlantı koptu'});
                }
            };

            if (createOffer) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.send(JSON.stringify({ type: 'offer', offer, targetId: lastCalledAdminId }));
            }
        }

        async function handleWebRTCMessage({ type, offer, answer, candidate }) {
            try {
                if (!peerConnection && type === 'offer') {
                    await setupPeerConnection(false);
                }
                 if (type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const ans = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(ans);
                    socket.send(JSON.stringify({ type: 'answer', answer: ans, targetId: lastCalledAdminId }));
                } else if (type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                } else if (type === 'ice-candidate' && candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                console.error("WebRTC Mesaj Hatası:", error);
            }
        }

        function cleanupCall() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            peerConnection = null;
            localStream = null;
        }

        // Değerlendirme Modalı
        function openReviewModal(callEndMessage) {
            lastCallId = callEndMessage.callId;
            lastCalledAdminId = callEndMessage.adminId;
            const admin = availableAdmins.find(a => a.id === lastCalledAdminId) || { name: lastCalledAdminId };
            const modalContent = `
                <div class="modal-overlay" id="reviewModal">
                    <div class="modal">
                         <div class="modal-header">
                            <img src="${admin.profile_picture_url || 'https://placehold.co/100x100/e2e8f0/64748b?text=Usta'}" class="modal-avatar">
                            <div>
                                <h3 class="modal-title">Görüşmeyi Değerlendir</h3>
                                <p class="modal-subtitle">${admin.name} ile görüşmeniz tamamlandı.</p>
                            </div>
                        </div>
                        <div class="modal-body">
                             <div style="text-align:center; margin-bottom:15px;">
                                <strong>Süre:</strong> ${new Date((callEndMessage.duration || 0) * 1000).toISOString().substr(14, 5)} | 
                                <strong>Harcanan:</strong> ${callEndMessage.creditsUsed || 0} kredi
                            </div>
                            <div class="rating-stars" id="ratingStars">
                                ${[1,2,3,4,5].map(i => `<span class="star" data-value="${i}" onclick="selectRating(${i})">☆</span>`).join('')}
                            </div>
                            <textarea id="reviewComment" class="review-textarea" placeholder="Yorumunuz..."></textarea>
                            <p style="text-align:center; font-weight: 500; margin-bottom: 10px;">Memnun kaldınız mı? Destek olun:</p>
                            <div class="tip-buttons" id="tipButtons">
                                <button class="tip-btn" data-tip="10" onclick="selectTip(10)">10 Kredi</button>
                                <button class="tip-btn" data-tip="30" onclick="selectTip(30)">30 Kredi</button>
                                <button class="tip-btn" data-tip="50" onclick="selectTip(50)">50 Kredi</button>
                            </div>
                            <button class="btn btn-login" onclick="submitReview()">Gönder</button>
                            <button class="btn" style="background:#6c757d" onclick="closeModal('reviewModal')">Atla</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modalContainer').innerHTML = modalContent;
        }

        function selectRating(rating) {
            document.querySelectorAll('#ratingStars .star').forEach(star => {
                star.innerHTML = parseInt(star.dataset.value) <= rating ? '★' : '☆';
                star.classList.toggle('selected', parseInt(star.dataset.value) <= rating);
            });
        }
        function selectTip(amount) {
            document.querySelectorAll('#tipButtons .tip-btn').forEach(btn => {
                const isSelected = btn.classList.contains('selected');
                const currentValue = parseInt(btn.dataset.tip);
                if (currentValue === amount) {
                    btn.classList.toggle('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
        async function submitReview() {
            const rating = document.querySelectorAll('#ratingStars .star.selected').length;
            if (rating === 0) return alert('Lütfen puan verin.');
            
            const comment = document.getElementById('reviewComment').value;
            const selectedTipBtn = document.querySelector('#tipButtons .tip-btn.selected');
            const tipAmount = selectedTipBtn ? parseInt(selectedTipBtn.dataset.tip) : 0;
            
            if (tipAmount > userInfo.credits) {
                return alert("Bahşiş için yeterli krediniz bulunmuyor.");
            }

            try {
                const response = await fetch(`${baseUrl}/api/admins/${lastCalledAdminId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: userInfo.id, customerName: userInfo.name, rating, comment, tipAmount, callId: lastCallId })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Değerlendirmeniz için teşekkürler!');
                    if(result.newCredits !== undefined) {
                        userInfo.credits = result.newCredits;
                        updateUserDisplay();
                    }
                    closeModal('reviewModal');
                } else {
                    throw new Error(result.error);
                }
            } catch (e) {
                alert(`Hata: ${e.message}`);
            }
        }

        // Yardımcı Fonksiyonlar
        function setState(newState) {
            const callSection = document.getElementById('callSection');
            const connectingState = document.getElementById('connectingState');
            const connectedState = document.getElementById('connectedState');
            const incomingState = document.getElementById('incomingState');

            callSection.style.display = 'none';
            connectingState.style.display = 'none';
            connectedState.style.display = 'none';
            incomingState.style.display = 'none';

            if (newState === 'idle') callSection.style.display = 'block';
            else if (newState === 'connecting') connectingState.style.display = 'block';
            else if (newState === 'connected') connectedState.style.display = 'block';
            else if (newState === 'incoming') incomingState.style.display = 'block';
            
            callState = newState;
        }
        
        function startRingTone() {
            stopRingTone(); // Önceki sesi durdur
            try {
                ringAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                ringOscillator = ringAudioContext.createOscillator();
                const gainNode = ringAudioContext.createGain();
                ringOscillator.connect(gainNode);
                gainNode.connect(ringAudioContext.destination);
                ringOscillator.type = 'sine';
                ringOscillator.frequency.setValueAtTime(440, ringAudioContext.currentTime); // A4 note
                gainNode.gain.setValueAtTime(0.1, ringAudioContext.currentTime);
                ringOscillator.start();
            } catch (e) {
                console.error("Zil sesi çalınamadı:", e);
            }
        }

        function stopRingTone() {
            if (ringOscillator) {
                ringOscillator.stop();
                ringOscillator = null;
            }
            if (ringAudioContext) {
                 ringAudioContext.close().catch(e => {});
                 ringAudioContext = null;
            }
        }

        function closeModal(id) { document.getElementById(id)?.parentElement.remove(); }

        function logoutUser() {
             isLoggedIn = false;
             userInfo = { id: '', name: '', credits: 0 };
             document.getElementById('loginScreen').classList.remove('hidden');
             document.getElementById('mainApp').classList.add('hidden');
             if(socket) socket.close();
        }
        
        function displayAnnouncement(announcement) {
            let banner = document.getElementById('announcementBanner');
            if (banner) banner.remove();
            
            banner = document.createElement('div');
            banner.id = 'announcementBanner';
            banner.innerHTML = `📢 ${announcement.text}`;
            Object.assign(banner.style, {
                position: 'fixed', top: '10px', left: '50%', transform: 'translateX(-50%)',
                background: 'rgba(251, 191, 36, 0.9)', color: '#78350f', padding: '10px 20px',
                borderRadius: '20px', boxShadow: '0 4px 15px rgba(0,0,0,0.2)', zIndex: '2000',
                maxWidth: '90%', textAlign: 'center', fontSize: '14px', fontWeight: '600'
            });
            document.body.appendChild(banner);

            setTimeout(() => banner.remove(), 8000);
        }

    </script>
</body>
</html>

