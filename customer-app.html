<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>VIPCEP Müşteri Uygulaması</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #e9f5ff; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); text-align: center; }
    h1 { color: #0056b3; }
    .status-info, .credit-info, .call-action { margin-top: 20px; padding: 10px; border-radius: 5px; }
    .status-info { background-color: #d1ecf1; color: #0c5460; }
    .credit-info { background-color: #cce5ff; color: #004085; }
    #start-call { padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; color: white; background-color: #007bff; }
    #end-call { background-color: #dc3545; padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; color: white; display: none; }
    #status { font-weight: bold; }
    #queue-position { color: #ffc107; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VIPCEP Müşteri Uygulaması</h1>
    
    <div class="credit-info">
      <p>Mevcut Krediniz: <span id="credit-balance">Yükleniyor...</span> dakika</p>
    </div>

    <div class="status-info">
      <p>Durum: <span id="status">Bağlanıyor...</span></p>
      <p id="queue-message" style="display:none;">Sıradaki Yeriniz: <span id="queue-position"></span></p>
    </div>

    <div class="call-action">
      <button id="start-call">Uzman ile Görüşme Başlat</button>
      <button id="end-call">Görüşmeyi Sonlandır</button>
    </div>
    
    <script>
      const ws = new WebSocket("ws://localhost:3000"); // Proje Railway'de ise Railway URL'si ile değiştirin
      let localStream;
      let peerConnection;
      let adminId;

      ws.onopen = () => {
        console.log("WebSocket connected.");
        ws.send(JSON.stringify({ type: "register_customer", user_id: "customer1" }));
        document.getElementById("status").innerText = "Bağlandı, Hazır";
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case "call_initiated":
            document.getElementById("status").innerText = "Görüşme Başlıyor...";
            document.getElementById("queue-message").style.display = "none";
            document.getElementById("start-call").style.display = "none";
            document.getElementById("end-call").style.display = "block";
            adminId = data.to;
            
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: "webrtc_offer", to: adminId, offer: offer }));
            break;

          case "webrtc_answer":
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            break;
            
          case "webrtc_ice_candidate":
            if (peerConnection) {
              await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
            break;

          case "call_queued":
            document.getElementById("status").innerText = "Sıraya Alındınız";
            document.getElementById("queue-position").innerText = data.queue_position;
            document.getElementById("queue-message").style.display = "block";
            break;

          case "credit_update":
            document.getElementById("credit-balance").innerText = data.credits;
            document.getElementById("status").innerText = "Görüşme Sona Erdi";
            document.getElementById("start-call").style.display = "block";
            document.getElementById("end-call").style.display = "none";
            break;
        }
      };

      document.getElementById("start-call").onclick = () => {
        document.getElementById("status").innerText = "Arama İsteği Gönderiliyor...";
        ws.send(JSON.stringify({ type: "call_request", user_id: ws.client_id }));
      };

      document.getElementById("end-call").onclick = () => {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
        }
        document.getElementById("status").innerText = "Görüşme Sona Erdi";
        document.getElementById("end-call").style.display = "none";

        ws.send(JSON.stringify({
          type: "call_end",
          duration: 120, // Örnek süre
          customer_id: ws.client_id,
          admin_id: adminId,
        }));
      };

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            ws.send(JSON.stringify({ type: "webrtc_ice_candidate", to: adminId, candidate: event.candidate }));
          }
        };
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          remoteAudio.play();
        };
      }
    </script>
  </div>
</body>
</html>
