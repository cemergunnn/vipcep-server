<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Müşteri Uygulaması</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; background: #dc2626; color: white; padding: 15px; border-radius: 8px; }
        .header h1 { margin: 0; font-size: 1.5em; }
        .panel { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { margin: 0 0 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #dc2626; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        .volume-slider { width: 100%; margin: 10px 0; }
        .hidden { display: none; }
        .queue-info { text-align: center; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="connection-status">Bağlanıyor...</div>
            <h1>USTAMA SOR</h1>
            <p>Teknik Servis Danışmanlığı</p>
        </div>

        <div class="panel">
            <div class="card" id="kvkk-consent">
                <h2>📋 Kişisel Verilerin Korunması Hakkında Bilgilendirme</h2>
                <div>
                    <p><strong>1. Veri İşleme ve Gizlilik</strong><br>
                    Bu hizmet kapsamında kullanıcıların sesli görüşmeleri kayıt altına alınmamaktadır. Görüşme içerikleri tarafımızca saklanmaz, üçüncü kişilerle paylaşılmaz.</p>
                    <p><strong>2. Anonim Kullanım</strong><br>
                    Sistemi kullanmak için kimlik, ad-soyad, telefon numarası, e-posta gibi herhangi bir kişisel bilgi talep edilmez veya saklanmaz. Kullanıcılar tamamen anonim olarak hizmetten yararlanır.</p>
                    <p><strong>3. KVKK Uyarısı</strong><br>
                    6698 sayılı Kişisel Verilerin Korunması Kanunu kapsamında, sistem yalnızca teknik gerekli anonim bilgileri (tarayıcı tipi, bağlantı süresi) geçici işler. Bu veriler kimliğinizi tespit etmez ve kısa süre saklanır.</p>
                    <p><strong>4. Kullanıcı Sorumluluğu</strong><br>
                    Bu hizmet, teknik destek amacıyla sunulur. Görüşme esnasında kullanıcı tarafından iletilen her türlü bilgi, belge veya kişisel veri paylaşımı tamamen kullanıcının kendi sorumluluğundadır.</p>
                    <p><strong>5. Onay</strong><br>
                    Bu metni onaylayarak:<br>
                    - Ses kayıtlarının tutulmayacağını,<br>
                    - Kimliğimin tespitine imkân verecek herhangi bir bilginin talep edilmediğini,<br>
                    - Görüşme sırasında kendi isteğimle paylaşacağım bilgilerden yalnızca kendimin sorumlu olacağımı<br>
                    kabul ve beyan ediyorum.</p>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="rejectKVKK()">Reddet</button>
                    <button class="btn btn-primary" onclick="approveKVKK()">Onaylıyorum</button>
                </div>
            </div>

            <div class="card hidden" id="login-form">
                <div class="form-group">
                    <label>4 Haneli ID Kodunuz</label>
                    <input type="text" id="user-id" maxlength="4">
                </div>
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="user-name">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="remember-me"> 🔒 Beni Hatırla</label>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="login()">Giriş Yap</button>
                    <button class="btn btn-secondary" onclick="requestCredits()">💳 Kredi Talebi</button>
                </div>
            </div>

            <div class="card hidden" id="user-info">
                <h2>Kullanıcı Bilgileri</h2>
                <div>
                    <div>Kullanıcı: <span id="user-name-display">-</span></div>
                    <div>ID: <span id="user-id-display">-</span></div>
                    <div>Kredi Bakiye: <span id="credits-display">-</span></div>
                    <div>Durum: <span id="status-display">Hazır</span></div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="callTechnician()">Ustam'ı Ara</button>
                    <button class="btn btn-secondary" onclick="requestCredits()">WhatsApp Kredi Talebi</button>
                    <button class="btn btn-secondary" onclick="logout()">Çıkış Yap</button>
                </div>
            </div>

            <div class="card hidden" id="queue-waiting">
                <h2>🎯 SIRADA BEKLİYORSUNUZ</h2>
                <div class="queue-info">
                    <div>Sıranız: <span id="queue-position">-</span></div>
                    <div>Tahmini bekleme: ~3-5 dk</div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="cancelCall()">Aramayı İptal Et</button>
                </div>
            </div>

            <div class="card hidden" id="incoming-call">
                <h2>📞 GELEN ARAMA</h2>
                <div>🔧 USTAM ARIYOR</div>
                <div>Aramayı kabul ediyor musunuz?</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="acceptCall()">Kabul Et</button>
                    <button class="btn btn-secondary" onclick="rejectCall()">Reddet</button>
                </div>
            </div>

            <div class="card hidden" id="call-connecting">
                <h2>🔗 Bağlanıyor...</h2>
                <div>Ses bağlantısı kuruluyor</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="cancelCall()">İptal Et</button>
                </div>
            </div>

            <div class="card hidden" id="active-call">
                <h2>📊 Görüşme Aktif</h2>
                <div>Görüşme Süresi: <span id="call-duration">00:00</span></div>
                <div>
                    <label>Ses Seviyesi:</label>
                    <input type="range" class="volume-slider" min="0" max="100" value="70" oninput="adjustVolume(this.value)">
                    <span>70%</span>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="toggleMic()">🎤 Mikrofon</button>
                    <button class="btn btn-secondary" onclick="toggleSpeaker()">🔊 Hoparlör</button>
                    <button class="btn btn-secondary" onclick="toggleNoiseCancellation()">🚫 Gürültü</button>
                    <button class="btn btn-primary" onclick="endCall()">Görüşmeyi Sonlandır</button>
                </div>
            </div>
        </div>

        <div class="card">
            <p>VIPCEP Teknik Servis © 2025</p>
            <p>Mobil Cihaz Teknik Danışmanlığı</p>
        </div>

        <div class="card hidden" id="call-ended">
            <h2>💳 Görüşme Sona Erdi</h2>
            <div>
                <div>Görüşme Süresi: <span id="end-duration">00:00</span></div>
                <div>Kullanılan Kredi: <span id="end-credits">0 dakika</span></div>
                <div>Kalan Krediniz: <span id="end-remaining-credits">0 dakika</span></div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="closeCallEnded()">✔ Tamam</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentUser = null;
        let currentCall = null;
        let callTimer = null;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${location.host}`);
            
            ws.onopen = () => {
                document.getElementById('connection-status').textContent = 'Bağlandı';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                switch (message.type) {
                    case 'login-response':
                        if (message.success) {
                            currentUser = message.user;
                            document.getElementById('kvkk-consent').classList.add('hidden');
                            document.getElementById('login-form').classList.add('hidden');
                            document.getElementById('user-info').classList.remove('hidden');
                            document.getElementById('user-name-display').textContent = currentUser.name;
                            document.getElementById('user-id-display').textContent = currentUser.id;
                            document.getElementById('credits-display').textContent = currentUser.credits;
                        } else {
                            alert(`Giriş başarısız: ${message.reason}`);
                        }
                        break;
                    
                    case 'queue-position':
                        if (message.position > 0) {
                            document.getElementById('user-info').classList.add('hidden');
                            document.getElementById('queue-waiting').classList.remove('hidden');
                            document.getElementById('queue-position').textContent = message.position;
                        } else {
                            document.getElementById('queue-waiting').classList.add('hidden');
                            document.getElementById('user-info').classList.remove('hidden');
                        }
                        break;
                    
                    case 'call-accepted':
                        currentCall = { callId: message.callId, targetId: message.acceptedAdminId };
                        document.getElementById('queue-waiting').classList.add('hidden');
                        document.getElementById('incoming-call').classList.remove('hidden');
                        break;
                    
                    case 'call-rejected':
                        document.getElementById('queue-waiting').classList.add('hidden');
                        document.getElementById('user-info').classList.remove('hidden');
                        alert(`Arama reddedildi: ${message.reason}`);
                        break;
                    
                    case 'call-ended':
                        endActiveCall(message);
                        break;
                }
            };

            ws.onclose = () => {
                document.getElementById('connection-status').textContent = 'Bağlantı kesildi';
                setTimeout(connectWebSocket, 5000);
            };
        }

        function approveKVKK() {
            document.getElementById('kvkk-consent').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function rejectKVKK() {
            window.location.href = '/';
        }

        function login() {
            const userId = document.getElementById('user-id').value;
            const userName = document.getElementById('user-name').value;
            
            ws.send(JSON.stringify({
                type: 'login',
                userType: 'customer',
                userId: userId,
                userName: userName
            }));
        }

        function callTechnician() {
            if (currentUser.credits <= 0) {
                alert('Yeterli krediniz yok. Lütfen kredi talebinde bulunun.');
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'call-request',
                userId: currentUser.id,
                userName: currentUser.name,
                credits: currentUser.credits
            }));
        }

        function acceptCall() {
            document.getElementById('incoming-call').classList.add('hidden');
            document.getElementById('call-connecting').classList.remove('hidden');
            // Implement WebRTC connection
            setTimeout(() => {
                document.getElementById('call-connecting').classList.add('hidden');
                document.getElementById('active-call').classList.remove('hidden');
                startCallTimer();
            }, 2000);
        }

        function rejectCall() {
            ws.send(JSON.stringify({
                type: 'call-cancelled',
                userId: currentUser.id
            }));
            document.getElementById('incoming-call').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        function cancelCall() {
            ws.send(JSON.stringify({
                type: 'call-cancelled',
                userId: currentUser.id
            }));
            document.getElementById('queue-waiting').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        function endCall() {
            if (currentCall) {
                ws.send(JSON.stringify({
                    type: 'end-call',
                    targetId: currentCall.targetId,
                    duration: parseInt(document.getElementById('call-duration').textContent.split(':').reduce((m, s) => parseInt(m) * 60 + parseInt(s), 0))
                }));
            }
        }

        function endActiveCall(message) {
            clearInterval(callTimer);
            document.getElementById('active-call').classList.add('hidden');
            document.getElementById('call-ended').classList.remove('hidden');
            document.getElementById('end-duration').textContent = message.duration ? `${Math.floor(message.duration / 60)}:${(message.duration % 60).toString().padStart(2, '0')}` : '00:00';
            document.getElementById('end-credits').textContent = `${message.creditsUsed} dakika`;
            document.getElementById('end-remaining-credits').textContent = `${currentUser.credits - message.creditsUsed} dakika`;
            currentUser.credits -= message.creditsUsed;
            currentCall = null;
        }

        function closeCallEnded() {
            document.getElementById('call-ended').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        function requestCredits() {
            window.open('https://wa.me/+905374792403?text=Kredi%20talebi', '_blank');
        }

        function adjustVolume(value) {
            document.querySelector('.volume-slider + span').textContent = `${value}%`;
        }

        function toggleMic() {
            // Implement microphone toggle
        }

        function toggleSpeaker() {
            // Implement speaker toggle
        }

        function toggleNoiseCancellation() {
            // Implement noise cancellation
        }

        function logout() {
            ws.close();
            window.location.href = '/';
        }

        function startCallTimer() {
            let seconds = 0;
            callTimer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('call-duration').textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        connectWebSocket();
    </script>
</body>
</html>
