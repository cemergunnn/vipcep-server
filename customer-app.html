<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>VIPCEP Müşteri Paneli</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Temel stiller ve responsive yapı burada */
        body { font-family: Arial, sans-serif; background: #e0f2fe; margin:0; }
        .container { max-width: 600px; margin: 0 auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 2px 32px rgba(34,197,94,0.08);}
        h1 { color: #2563eb; }
        .credits { color: #059669; font-weight: bold; font-size: 24px; }
        .user-info { margin-bottom: 18px; }
        .btn { background: #2563eb; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:disabled { opacity: 0.7; }
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-left: 4px solid #22c55e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>VIPCEP Müşteri Paneli</h1>
        <div class="user-info">
            <div>Adınız: <span id="userName">-</span></div>
            <div>ID: <span id="userId">-</span></div>
            <div>Kredi: <span class="credits" id="userCredits">-</span> dakika</div>
        </div>
        <button class="btn" id="callBtn" onclick="startCall()">Teknik Destek ile Görüşme Başlat</button>
        <div id="callStatus"></div>
    </div>
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Part 2'de JS fonksiyonları başlayacak -->    <script>
        // Kullanıcı bilgisi ve kredi bilgisini API'den çekme
        let userId = localStorage.getItem('customer_id') || "";
        let userName = "";
        let userCredits = 0;

        async function fetchUser() {
            if (!userId) {
                userId = prompt("Lütfen 4 haneli müşteri ID'nizi girin:");
                localStorage.setItem('customer_id', userId);
            }
            try {
                const response = await fetch(`/api/approved-users/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    userName = data.name;
                    userCredits = data.credits;
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userId').textContent = userId;
                    document.getElementById('userCredits').textContent = userCredits;
                    document.getElementById('callBtn').disabled = userCredits < 1;
                } else {
                    showNotification("Kullanıcı bulunamadı veya onaylı değil!", true);
                    document.getElementById('callBtn').disabled = true;
                }
            } catch (err) {
                showNotification("Sunucuya erişilemiyor!", true);
            }
        }

        function showNotification(message, error) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderLeft = error ? "4px solid #ef4444" : "4px solid #22c55e";
            notification.innerHTML = `<div>${message}</div>`;
            container.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('slide-out');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Part 3'te WebSocket, çağrı başlatma ve push notification entegrasyonu gelecek
        window.onload = fetchUser;
    </script>    <script>
        // WebSocket ile çağrı başlatma ve push notification entegrasyonu
        let socket = null;
        const serverUrl = window.location.hostname === 'localhost'
            ? 'ws://localhost:8080'
            : `wss://vipcep-server-production.up.railway.app`;

        function connectToServer() {
            socket = new WebSocket(serverUrl);
            socket.onopen = () => {
                showNotification("Sunucuya bağlanıldı.");
                socket.send(JSON.stringify({ type: 'customer-connect', userId }));
            };
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'call-accepted') {
                    document.getElementById('callStatus').textContent = "Teknik destek görüşmesini başlatabilirsiniz!";
                    sendLocalNotification('Görüşme Başlatıldı', 'Teknik destek ile bağlantınız açıldı.');
                }
                if (msg.type === 'call-rejected') {
                    document.getElementById('callStatus').textContent = "Görüşme reddedildi!";
                    sendLocalNotification('Görüşme Reddedildi', 'Teknik destek aramanız reddedildi.');
                }
                if (msg.type === 'credit-update') {
                    userCredits = msg.newCredits;
                    document.getElementById('userCredits').textContent = userCredits;
                    document.getElementById('callBtn').disabled = userCredits < 1;
                    showNotification(`Krediniz güncellendi: ${userCredits} dk`);
                }
            };
            socket.onclose = () => {
                showNotification("Sunucu bağlantısı kapandı!", true);
            };
        }

        function startCall() {
            if (userCredits < 1) {
                showNotification("Yeterli krediniz yok!", true);
                return;
            }
            document.getElementById('callStatus').textContent = "Arama başlatılıyor...";
            socket.send(JSON.stringify({ type: 'customer-call', userId }));
        }

        // Push notification entegrasyonu (part 4'te modül import edilecek)
        function sendLocalNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body });
            }
        }

        window.onload = function() {
            fetchUser();
            connectToServer();
        };
    </script>    <script type="module">
        // Push notification modülü (manifest.json ve service-worker.js dosyalarını köke eklemeyi unutma!)
        import { setupPushNotifications, sendLocalNotification as notify } from './push-notification.js';
        setupPushNotifications();
        window.sendLocalNotification = notify;
    </script>
</body>
</html>
