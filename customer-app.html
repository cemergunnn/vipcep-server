<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Müşteri Uygulaması</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #dbeafe;
            --success-color: #16a34a;
            --warning-color: #f59e0b;
            --danger-color: #dc2626;
            --gray-100: #f8fafc;
            --gray-200: #e5e7eb;
            --gray-500: #64748b;
            --gray-800: #1e293b;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            position: relative;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-connected { background: #22c55e; box-shadow: 0 0 6px rgba(34, 197, 94, 0.6); }
        .status-disconnected { background: #ef4444; box-shadow: 0 0 6px rgba(239, 68, 68, 0.6); }
        .status-waiting { background: #f59e0b; box-shadow: 0 0 6px rgba(245, 158, 11, 0.6); animation: pulse 2s infinite; }
        
        .logo {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 10px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .app-title { font-size: 20px; font-weight: 700; margin-bottom: 3px; }
        .app-subtitle { font-size: 13px; opacity: 0.9; }
        
        .app-content { padding: 20px; }
        
        /* KVKK Ekranı Stilleri */
        .kvkk-screen { padding: 20px; max-height: 80vh; overflow-y: auto; }
        .kvkk-title { font-size: 18px; font-weight: 700; color: var(--gray-800); margin-bottom: 15px; text-align: center; }
        .kvkk-content { background: var(--gray-100); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color); margin-bottom: 20px; font-size: 13px; line-height: 1.5; color: #374151; max-height: 450px; overflow-y: auto; word-wrap: break-word; }
        .kvkk-content h4 { color: var(--gray-800); margin: 15px 0 8px 0; font-size: 15px; }
        .kvkk-checkbox-container { display: flex; align-items: center; gap: 12px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #bbf7d0; margin-bottom: 20px; transition: all 0.3s ease; }
        .kvkk-checkbox-container:hover { border-color: var(--primary-color); background: #dcfce7; }
        .kvkk-checkbox { width: 20px; height: 20px; cursor: pointer; transform: scale(1.2); }
        .kvkk-checkbox-label { font-size: 14px; font-weight: 600; color: var(--success-color); cursor: pointer; user-select: none; }
        .kvkk-buttons { display: flex; gap: 10px; }
        
        /* Form Stilleri */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 13px; }
        .form-input { width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 15px; transition: all 0.3s ease; background: var(--gray-100); }
        .form-input:focus { outline: none; border-color: var(--primary-color); background: white; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }
        .user-id-input { text-align: center; font-weight: bold; font-size: 24px; letter-spacing: 2px; font-family: monospace; }
        
        /* Buton Stilleri */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; margin-bottom: 10px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .btn-login, .btn-call, .btn-accept, .btn-kvkk-accept { background: linear-gradient(135deg, var(--primary-color), var(--success-color)); color: white; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-login:hover:not(:disabled), .btn-call:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4); }
        .btn-end, .btn-reject, .btn-logout, .btn-kvkk-decline { background: linear-gradient(135deg, var(--danger-color), #b91c1c); color: white; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-whatsapp { background: #25d366; color: white; font-size: 14px; }
        
        /* Ana Uygulama Stilleri */
        .user-info { background: var(--gray-100); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 3px solid var(--primary-color); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .info-item { text-align: center; }
        .info-label { font-size: 10px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-weight: 700; color: var(--gray-800); font-size: 14px; }
        .credits-value { color: var(--primary-color); font-size: 18px; }
        .credits-zero { color: var(--danger-color); font-size: 18px; }

        /* YENİ: Admin Kart Stilleri */
        .admin-list-container { max-height: 450px; overflow-y: auto; padding: 5px; margin: -5px; }
        .admin-card { background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; gap: 15px; align-items: center; transition: all 0.3s ease; }
        .admin-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .admin-pic { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--gray-200); }
        .admin-details { flex-grow: 1; }
        .admin-name { font-weight: 700; color: var(--gray-800); font-size: 16px; margin-bottom: 4px; }
        .admin-specialization { font-size: 13px; color: var(--gray-500); margin-bottom: 6px; }
        .admin-rating { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--gray-500); }
        .stars { color: var(--warning-color); }
        .admin-actions { display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .btn-admin-action { padding: 8px 16px; font-size: 13px; width: 120px; border-radius: 8px; }
        .btn-admin-callback { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #92400e; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }

        /* Arama Durumları */
        .call-status { text-align: center; margin-bottom: 20px; }
        .call-timer { font-size: 32px; font-weight: 800; color: var(--primary-color); margin: 20px 0; font-family: monospace; }
        .incoming-call-status { background: linear-gradient(135deg, var(--primary-color), #1d4ed8); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; animation: pulse 1.5s infinite; }
        
        /* Mesaj Balonları */
        .message-bubble { padding: 15px; border-radius: 8px; font-size: 14px; text-align: center; margin-top: 15px; }
        .error-message { background: #fef2f2; color: var(--danger-color); border-left: 4px solid var(--danger-color); }
        .success-message { background: #f0fdf4; color: var(--success-color); border-left: 4px solid var(--success-color); }
        
        /* YENİ: Değerlendirme Modalı Stilleri */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .review-modal { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 380px; text-align: center; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .review-modal { transform: scale(1); }
        .review-modal h3 { color: var(--gray-800); margin-bottom: 8px; }
        .review-modal p { color: var(--gray-500); font-size: 14px; margin-bottom: 20px; }
        .review-modal h4 { color: var(--gray-800); font-size: 14px; font-weight: 600; margin: 20px 0 10px 0; }
        .rating-stars { font-size: 36px; color: var(--gray-200); cursor: pointer; margin-bottom: 15px; }
        .rating-stars span:hover, .rating-stars span.selected { color: var(--warning-color); }
        .review-comment { width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 14px; resize: vertical; }
        .tip-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .tip-buttons button { background: var(--gray-100); border: 1px solid var(--gray-200); color: var(--gray-800); padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s ease; }
        .tip-buttons button:hover { background: var(--primary-light); border-color: var(--primary-color); }
        .tip-buttons button.selected { background: var(--primary-color); border-color: var(--primary-color); color: white; font-weight: bold; }
        .review-actions { display: flex; gap: 10px; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-800); box-shadow: none; }
        .btn-secondary:hover { background: #d1d5db; }
        
        .hidden { display: none !important; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header (Değişiklik yok) -->
        <div class="app-header">
            <div class="connection-status">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">Bağlanıyor...</span>
            </div>
            <div class="logo">
                <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
            </div>
            <div class="app-title">USTAMA SOR</div>
            <div class="app-subtitle">Teknik Servis Danışmanlığı</div>
        </div>
        
        <!-- KVKK Ekranı (Değişiklik yok) -->
        <div id="kvkkScreen" class="kvkk-screen">
            <div class="kvkk-title">📋 Kişisel Verilerin Korunması Hakkında Bilgilendirme</div>
            <div class="kvkk-content">
                <h4 >1. Veri İşleme ve Gizlilik</h4>
                <p>Bu hizmet kapsamında kullanıcıların sesli görüşmeleri kayıt altına alınmamaktadır. Görüşme içerikleri tarafımızca saklanmaz, üçüncü kişilerle paylaşılmaz.</p>
                <h4>4. Kullanıcı Sorumluluğu</h4>
                <p>Bu hizmet, teknik destek amacıyla sunulur. Görüşme esnasında kullanıcı tarafından iletilen her türlü bilgi, belge veya kişisel veri paylaşımı tamamen kullanıcının kendi sorumluluğundadır.</p>
                <h4>5. Onay</h4>
                <p>Bu metni onaylayarak ses kayıtlarının tutulmayacağını, kimliğimin tespitine imkân verecek herhangi bir bilginin talep edilmediğini ve görüşme sırasında kendi isteğimle paylaşacağım bilgilerden yalnızca kendimin sorumlu olacağımı kabul ve beyan ediyorum.</p>
            </div>
            <div class="kvkk-checkbox-container">
                <input type="checkbox" id="kvkkCheckbox" class="kvkk-checkbox">
                <label for="kvkkCheckbox" class="kvkk-checkbox-label">Okudum, anladım, onaylıyorum</label>
            </div>
            <div class="kvkk-buttons">
                <button class="btn btn-kvkk-decline" onclick="declineKVKK()">Reddet</button>
                <button class="btn btn-kvkk-accept" id="kvkkAcceptBtn" disabled onclick="acceptKVKK()">Onaylıyorum</button>
            </div>
        </div>
        
        <div class="app-content">
            <!-- Giriş Ekranı (Değişiklik yok) -->
            <div id="loginScreen" class="hidden">
                <div class="form-group">
                    <label class="form-label">4 Haneli ID Kodunuz</label>
                    <input type="text" class="form-input user-id-input" id="userIdInput" placeholder="0000" maxlength="4" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Ad Soyad</label>
                    <input type="text" class="form-input" id="userNameInput" placeholder="Adınızı ve Soyadınızı">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin: 0;">
                    <label for="rememberMe" style="margin: 0; font-size: 14px; color: #374151; cursor: pointer;">🔒 Beni Hatırla</label>
                </div>
                <button class="btn btn-login" id="loginButton" onclick="loginUser()">Giriş Yap</button>
                <button class="btn btn-whatsapp" onclick="requestCreditWhatsApp()">WhatsApp ile Kredi Talep Et</button>
                <div id="loginMessage"></div>
            </div>
            
            <!-- Ana Uygulama Ekranı -->
            <div id="mainApp" class="hidden">
                <div class="user-info">
                    <div class="info-grid">
                        <div class="info-item"><div class="info-label">Kullanıcı</div><div class="info-value" id="displayUserName">-</div></div>
                        <div class="info-item"><div class="info-label">ID</div><div class="info-value" id="displayUserId">-</div></div>
                        <div class="info-item"><div class="info-label">Kredi Bakiye</div><div class="info-value credits-value" id="displayUserCredits">-</div></div>
                        <div class="info-item"><div class="info-label">Durum</div><div class="info-value" id="displayUserStatus">Hazır</div></div>
                    </div>
                </div>

                <!-- YENİ: Usta Seçim Ekranı -->
                <div id="adminSelectionScreen">
                    <label class="form-label" style="font-size: 16px; margin-bottom: 10px;">🎯 Müsait Ustalar</label>
                    <div id="adminListContainer" class="admin-list-container">
                        <!-- DEĞİŞİKLİK: Yükleniyor durumu eklendi -->
                        <p id="adminListPlaceholder" style="text-align:center; color: var(--gray-500); padding: 20px;">Müsait ustalar yükleniyor...</p>
                    </div>
                </div>

                <!-- Arama Durumları -->
                <div id="connectingState" class="hidden call-status">
                    <div style="color: var(--primary-color); font-weight: 700; font-size: 18px;">🔗 Bağlanıyor...</div>
                    <button class="btn btn-end" onclick="endCall()">İptal Et</button>
                </div>
                
                <div id="connectedState" class="hidden">
                    <div class="call-status">
                        <div style="color: var(--success-color); font-weight: 700; font-size: 18px;">📊 Görüşme Aktif</div>
                        <div class="call-timer" id="callTimer">00:00</div>
                        <div style="font-size: 14px; color: var(--gray-500);"><span id="currentAdminName">Usta</span> ile görüşüyorsunuz</div>
                    </div>
                    <button class="btn btn-end" onclick="endCall()">Görüşmeyi Sonlandır</button>
                </div>

                 <div id="incomingCallState" class="hidden">
                    <div class="incoming-call-status">
                         <div class="call-status-title">📞 GELEN ARAMA</div>
                         <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;"><span id="incomingAdminName">USTAM</span> arıyor, kabul ediyor musunuz?</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-accept" onclick="acceptIncomingCall()">Kabul Et</button>
                            <button class="btn btn-reject" onclick="rejectIncomingCall()">Reddet</button>
                        </div>
                    </div>
                </div>

                <div id="errorMessage" class="message-bubble hidden"></div>
                <button class="btn btn-logout" onclick="logoutUser()" style="margin-top: 20px;">Çıkış Yap</button>
            </div>
        </div>
    </div>
    
    <!-- YENİ: Değerlendirme Modalı -->
    <div id="reviewModal" class="modal-overlay">
        <div class="review-modal">
            <h3 id="reviewModalTitle">Görüşme Tamamlandı!</h3>
            <p><strong><span id="reviewAdminName">Usta</span></strong> ile olan görüşmenizi değerlendirin.</p>
            
            <h4>Puanınız</h4>
            <div class="rating-stars" id="ratingStars">
                <span data-value="1">☆</span><span data-value="2">☆</span><span data-value="3">☆</span><span data-value="4">☆</span><span data-value="5">☆</span>
            </div>

            <h4>Yorumunuz (isteğe bağlı)</h4>
            <textarea id="reviewComment" class="form-input" placeholder="Görüşmeniz nasıl geçti? Kısaca yazabilirsiniz..." rows="3"></textarea>
            
            <h4>Destek Ol (isteğe bağlı)</h4>
            <p style="font-size: 12px; margin-bottom: 10px;">Kredinizden ustamıza destek gönderebilirsiniz.</p>
            <div class="tip-buttons" id="tipButtons">
                <button data-amount="1">1 Kredi</button>
                <button data-amount="5">5 Kredi</button>
                <button data-amount="10">10 Kredi</button>
            </div>

            <div class="review-actions">
                <button class="btn btn-secondary" onclick="closeReviewModal(false)">Atla</button>
                <button id="submitReviewBtn" class="btn btn-login" onclick="submitReview()">Gönder</button>
            </div>
        </div>
    </div>

    <audio id="localAudio" muted></audio>
    <audio id="remoteAudio" autoplay></audio>
    
    <script>
        // Global Değişkenler
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let callState = 'idle';
        let callTimer = null;
        let callDuration = 0;
        let callStartTime = null;
        let isLoggedIn = false;
        let kvkkApproved = false;
        let availableAdmins = [];
        let lastCallInfo = {};
        let selectedRating = 0;
        let selectedTip = 0;
        
        let userInfo = { id: '', name: '', credits: 0 };
        
        const serverUrl = window.location.hostname === 'localhost' ? 'ws://localhost:8080' : 'wss://vipcep-server-production.up.railway.app';
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        // Uygulama Başlatma
        window.onload = function() {
            init();
        };
        
        function init() {
            setupEventListeners();
            loadSavedUserInfo();
            connectToServer();
        }
        
        function setupEventListeners() {
            // KVKK Onay Kutusu
            const kvkkCheckbox = document.getElementById('kvkkCheckbox');
            kvkkCheckbox.addEventListener('change', (e) => {
                document.getElementById('kvkkAcceptBtn').disabled = !e.target.checked;
            });

            // Giriş Alanları
            document.getElementById('userIdInput').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
            document.getElementById('userNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });

            // YENİ: Değerlendirme Modalı Event Listeners
            const stars = document.getElementById('ratingStars');
            stars.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    selectedRating = parseInt(e.target.dataset.value);
                    Array.from(stars.children).forEach((star, i) => {
                        star.innerHTML = i < selectedRating ? '★' : '☆';
                        star.classList.toggle('selected', i < selectedRating);
                    });
                }
            });

            const tips = document.getElementById('tipButtons');
            tips.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const amount = parseInt(e.target.dataset.amount);
                    if (selectedTip === amount) {
                        selectedTip = 0; // Tekrar tıklayınca seçimi kaldır
                        e.target.classList.remove('selected');
                    } else {
                        selectedTip = amount;
                        Array.from(tips.children).forEach(btn => btn.classList.remove('selected'));
                        e.target.classList.add('selected');
                    }
                }
            });
        }
        
        // Sunucu Bağlantısı
        function connectToServer() {
            updateConnectionStatus(false, 'Bağlanıyor...');
            try {
                socket = new WebSocket(serverUrl);
                socket.onopen = () => {
                    updateConnectionStatus(true, 'Bağlı');
                    checkKVKKApproval();
                    if (isLoggedIn) registerUser();
                };
                socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
                socket.onclose = () => {
                    updateConnectionStatus(false, 'Bağlantı kesildi');
                    setTimeout(() => { if (!socket || socket.readyState === WebSocket.CLOSED) connectToServer(); }, 3000);
                };
                socket.onerror = () => updateConnectionStatus(false, 'Bağlantı hatası');
            } catch (error) {
                updateConnectionStatus(false, 'Bağlantı hatası');
            }
        }
        
        // Sunucu Mesajlarını İşleme
        function handleServerMessage(message) {
            console.log('📨 Sunucudan mesaj:', message.type, message);
            switch (message.type) {
                case 'login-response': handleLoginResponse(message); break;
                case 'admin-list-update': updateAdminList(message.admins || []); break;
                case 'credit-update': updateCredits(message.credits); showMessage(`Kredi güncellendi: ${message.credits} dk`, 'success'); break;
                case 'admin-call-request': handleIncomingAdminCall(message); break;
                case 'call-connecting': setState('connecting'); break;
                case 'call-accepted': handleCallAccepted(message); break;
                case 'call-rejected': handleCallEnded(message, true); break;
                case 'call-ended': handleCallEnded(message); break;
                case 'callback-success': showMessage(`Geri dönüş talebiniz alındı. ${message.adminName} müsait olduğunda sizi arayacak.`, 'success'); break;
                case 'callback-failed': showMessage(message.reason || 'Geri dönüş talebi başarısız!', 'error'); break;
                case 'offer': case 'answer': case 'ice-candidate': handleWebRTCMessage(message); break;
            }
        }

        // Giriş ve KVKK İşlemleri
        function checkKVKKApproval() {
            if (localStorage.getItem('vipcep_kvkk_approved') === 'true') {
                kvkkApproved = true;
                document.getElementById('kvkkScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }
        function acceptKVKK() {
            localStorage.setItem('vipcep_kvkk_approved', 'true');
            checkKVKKApproval();
        }
        function declineKVKK() {
            alert('KVKK onayı olmadan sistemi kullanamazsınız.');
            window.close();
        }
        function loginUser() {
            const userId = document.getElementById('userIdInput').value.trim();
            const userName = document.getElementById('userNameInput').value.trim();
            if (!userId || !userName || userId.length !== 4) return showLoginError('Lütfen tüm alanları doğru doldurun!');
            
            userInfo = { id: userId, name: userName };
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('vipcep_user', JSON.stringify(userInfo));
            } else {
                localStorage.removeItem('vipcep_user');
            }

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'login-request', userId, userName }));
            }
        }
        function handleLoginResponse(message) {
            if (message.success) {
                isLoggedIn = true;
                userInfo.credits = message.credits;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                updateUserDisplay();
                registerUser();
            } else {
                showLoginError(message.reason);
            }
        }
        function registerUser() {
            if (socket && socket.readyState === WebSocket.OPEN && isLoggedIn) {
                socket.send(JSON.stringify({ type: 'register', ...userInfo, userType: 'customer' }));
            }
        }
        
        // YENİ: Usta Listesini Güncelleme ve Görüntüleme
        function updateAdminList(admins) {
            availableAdmins = admins.filter(a => a.status !== 'offline') || [];
            const container = document.getElementById('adminListContainer');
            
            // DEĞİŞİKLİK: Yükleniyor durumu kaldırılıyor
            const placeholder = document.getElementById('adminListPlaceholder');
            if(placeholder) placeholder.remove();

            if (availableAdmins.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--gray-500); padding: 20px;">Şu anda müsait usta bulunmuyor.</p>';
                return;
            }
            container.innerHTML = availableAdmins.map(admin => {
                const isAvailable = admin.status === 'available';
                return `
                <div class="admin-card">
                    <img src="${admin.profile_picture_url || 'https://placehold.co/60x60/dbeafe/1e40af?text=Usta'}" alt="${admin.name}" class="admin-pic" onerror="this.src='https://placehold.co/60x60/dbeafe/1e40af?text=Usta'"/>
                    <div class="admin-details">
                        <div class="admin-name">${admin.name}</div>
                        <div class="admin-specialization">${admin.specialization || 'Genel Teknik Servis'}</div>
                        <div class="admin-rating">
                            <span class="stars">${generateStars(admin.average_rating)}</span>
                            <span>(${admin.review_count || 0} değerlendirme)</span>
                        </div>
                    </div>
                    <div class="admin-actions">
                        ${isAvailable 
                            ? `<button class="btn btn-call btn-admin-action" onclick="makeCall('${admin.id}')" ${userInfo.credits > 0 ? '' : 'disabled'}>📞 Ara</button>`
                            : `<button class="btn btn-admin-callback btn-admin-action" onclick="makeCallbackRequest('${admin.id}')">📝 Çağrı Bırak</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        function generateStars(rating) {
            const fullStars = Math.round(rating || 0);
            return '★'.repeat(fullStars) + '☆'.repeat(5 - fullStars);
        }

        // Arama İşlemleri
        function makeCall(adminId) {
            if (userInfo.credits <= 0) return showMessage('Arama yapmak için krediniz yetersiz.', 'error');
            setState('connecting');
            lastCallInfo.adminId = adminId;
            socket.send(JSON.stringify({ type: 'direct-call-request', userId: userInfo.id, userName: userInfo.name, targetAdminId: adminId, credits: userInfo.credits }));
        }
        function makeCallbackRequest(adminId) {
            socket.send(JSON.stringify({ type: 'callback-request', userId: userInfo.id, userName: userInfo.name, targetAdminId: adminId }));
        }
        function handleIncomingAdminCall(message) {
            if (callState !== 'idle') return; // Meşgulse gelen aramayı yoksay
            lastCallInfo.adminId = message.adminId;
            document.getElementById('incomingAdminName').textContent = message.adminName || 'USTAM';
            setState('incoming');
        }
        function acceptIncomingCall() {
            setState('connecting');
            socket.send(JSON.stringify({ type: 'accept-incoming-call', adminId: lastCallInfo.adminId, userId: userInfo.id }));
            setupPeerConnection(false); // Admin offer göndereceği için false
        }
        function rejectIncomingCall() {
            socket.send(JSON.stringify({ type: 'reject-incoming-call', adminId: lastCallInfo.adminId, userId: userInfo.id }));
            setState('idle');
        }
        function handleCallAccepted(message) {
            document.getElementById('currentAdminName').textContent = message.adminName || 'Usta';
            setState('connecting');
            setupPeerConnection(true); // Müşteri offer göndereceği için true
        }
        
        // YENİ: Arama Sonu ve Değerlendirme
        function handleCallEnded(message, rejected = false) {
            if (callState === 'idle') return;
            const previousCallState = callState;
            cleanupCall();
            setState('idle');
            
            if (rejected) {
                showMessage(message.reason || 'Arama meşgul veya reddedildi.', 'error');
            } else if (previousCallState === 'connected') {
                lastCallInfo = { ...lastCallInfo, ...message };
                setTimeout(() => showReviewModal(), 500);
            }
        }
        function showReviewModal() {
            const admin = availableAdmins.find(a => a.id === lastCallInfo.adminId);
            document.getElementById('reviewAdminName').textContent = admin?.name || 'Usta';
            document.getElementById('reviewModal').classList.add('visible');
        }
        function closeReviewModal(submitted = false) {
            document.getElementById('reviewModal').classList.remove('visible');
            if(submitted) showMessage('Değerlendirmeniz için teşekkür ederiz!', 'success');
            // Reset modal state
            selectedRating = 0;
            selectedTip = 0;
            document.getElementById('reviewComment').value = '';
            Array.from(document.getElementById('ratingStars').children).forEach(star => {
                star.innerHTML = '☆';
                star.classList.remove('selected');
            });
            Array.from(document.getElementById('tipButtons').children).forEach(btn => btn.classList.remove('selected'));
        }
        async function submitReview() {
            if (selectedRating === 0) {
                alert('Lütfen en az 1 yıldız vererek puanlama yapın.');
                return;
            }
            if (selectedTip > userInfo.credits) {
                alert('Destek göndermek için yeterli krediniz bulunmuyor.');
                return;
            }
            
            const reviewData = {
                customerId: userInfo.id,
                customerName: userInfo.name,
                rating: selectedRating,
                comment: document.getElementById('reviewComment').value.trim(),
                tipAmount: selectedTip,
                callId: lastCallInfo.callId || null
            };

            try {
                const response = await fetch(`${window.location.origin}/api/admins/${lastCallInfo.adminId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                closeReviewModal(true);
            } catch (error) {
                alert('Değerlendirme gönderilirken bir hata oluştu: ' + error.message);
            }
        }

        // WebRTC Fonksiyonları
        async function setupPeerConnection(isInitiator) {
            try {
                peerConnection = new RTCPeerConnection(rtcConfig);
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                document.getElementById('localAudio').srcObject = localStream;
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => { document.getElementById('remoteAudio').srcObject = event.streams[0]; };
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate, targetId: lastCallInfo.adminId }));
                };
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'connected') {
                        setState('connected');
                        startCallTimer();
                    } else if (['failed', 'disconnected', 'closed'].includes(peerConnection.connectionState)) {
                        handleCallEnded({ reason: 'Bağlantı koptu' });
                    }
                };

                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.send(JSON.stringify({ type: 'offer', offer, targetId: lastCallInfo.adminId }));
                }
            } catch (error) {
                showMessage('Mikrofon erişim hatası!', 'error');
                handleCallEnded({ reason: 'Mikrofon hatası' });
            }
        }
        async function handleWebRTCMessage(message) {
            if (!peerConnection && message.type !== 'offer') return;
            try {
                if (message.type === 'offer') {
                    if (!peerConnection) await setupPeerConnection(false);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.send(JSON.stringify({ type: 'answer', answer, targetId: lastCallInfo.adminId }));
                } else if (message.type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                } else if (message.type === 'ice-candidate' && message.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            } catch (error) { console.error('WebRTC Hata:', error); }
        }
        function cleanupCall() {
            if (callTimer) clearInterval(callTimer);
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            peerConnection = localStream = callTimer = null;
            callDuration = 0;
            document.getElementById('remoteAudio').srcObject = null;
        }

        // Arayüz ve Yardımcı Fonksiyonlar
        function setState(newState) {
            document.body.className = `state-${newState}`;
            callState = newState;
            ['adminSelectionScreen', 'connectingState', 'connectedState', 'incomingCallState'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            switch (newState) {
                case 'idle': document.getElementById('adminSelectionScreen').classList.remove('hidden'); document.getElementById('displayUserStatus').textContent = 'Hazır'; break;
                case 'connecting': document.getElementById('connectingState').classList.remove('hidden'); document.getElementById('displayUserStatus').textContent = 'Bağlanıyor...'; break;
                case 'connected': document.getElementById('connectedState').classList.remove('hidden'); document.getElementById('displayUserStatus').textContent = 'Görüşmede'; break;
                case 'incoming': document.getElementById('incomingCallState').classList.remove('hidden'); document.getElementById('displayUserStatus').textContent = 'Gelen Arama'; break;
            }
        }
        function updateUserDisplay() {
            document.getElementById('displayUserName').textContent = userInfo.name || '-';
            document.getElementById('displayUserId').textContent = userInfo.id || '-';
            const creditsEl = document.getElementById('displayUserCredits');
            creditsEl.textContent = userInfo.credits + ' dk';
            creditsEl.className = userInfo.credits <= 0 ? 'info-value credits-zero' : 'info-value credits-value';
        }
        function updateCredits(newCredits) {
            userInfo.credits = newCredits;
            updateUserDisplay();
        }
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                callDuration = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = String(Math.floor(callDuration / 60)).padStart(2, '0');
                const seconds = String(callDuration % 60).padStart(2, '0');
                document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }
        function loadSavedUserInfo() {
            const savedUser = localStorage.getItem('vipcep_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                document.getElementById('userIdInput').value = user.id;
                document.getElementById('userNameInput').value = user.name;
                document.getElementById('rememberMe').checked = true;
            }
        }
        function updateConnectionStatus(connected, text) {
            const dot = document.getElementById('connectionDot');
            dot.className = connected ? 'status-dot status-connected' : 'status-dot status-disconnected';
            document.getElementById('connectionText').textContent = text;
        }
        function showMessage(message, type) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.className = `message-bubble ${type}-message`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }
        function showLoginError(message) {
            const el = document.getElementById('loginMessage');
            el.innerHTML = `<div class="message-bubble error-message">${message}</div>`;
        }
        function requestCreditWhatsApp() {
            const message = `Merhaba! VIPCEP sistemi için kredi talep ediyorum. ID: ${userInfo.id || 'Giriş yapılmadı'}`;
            window.open(`https://wa.me/905374792403?text=${encodeURIComponent(message)}`, '_blank');
        }
        function logoutUser() {
            if (socket) socket.close();
            isLoggedIn = false;
            userInfo = { id: '', name: '', credits: 0 };
            if (!document.getElementById('rememberMe').checked) localStorage.removeItem('vipcep_user');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            connectToServer();
        }
    </script>
</body>
</html>

