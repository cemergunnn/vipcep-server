<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Müşteri Uygulaması</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.15);
            overflow: hidden;
            width: 100%;
            max-width: 380px;
            position: relative;
        }
        
        .app-header {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-connected { 
            background: #22c55e; 
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
        }
        .status-disconnected { 
            background: #ef4444; 
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        .lang-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .lang-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .logo {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 10px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .app-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .app-content {
            padding: 20px;
        }

        /* KVKK Onay Ekranı */
        .kvkk-screen {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .kvkk-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            text-align: center;
        }

        .kvkk-content {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #22c55e;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            max-height: 300px;
            overflow-y: auto;
        }

        .kvkk-content h4 {
            color: #1e293b;
            margin: 15px 0 8px 0;
            font-size: 15px;
        }

        .kvkk-content h4:first-child {
            margin-top: 0;
        }

        .kvkk-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .kvkk-checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f0fdf4;
            border-radius: 8px;
            border: 2px solid #bbf7d0;
            margin-bottom: 20px;
        }

        .kvkk-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .kvkk-checkbox-label {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            cursor: pointer;
        }

        .kvkk-buttons {
            display: flex;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #22c55e;
            background: white;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .user-id-input {
            text-align: center;
            font-weight: bold;
            font-size: 24px;
            letter-spacing: 2px;
            font-family: monospace;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        
        .btn-call {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        
        .btn-call:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        
        .btn-end {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: white;
            font-size: 14px;
        }
        
        .btn-whatsapp:hover:not(:disabled) {
            background: #1da851;
            transform: translateY(-1px);
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-accept {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .btn-reject {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-kvkk-accept {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            flex: 1;
        }

        .btn-kvkk-decline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            flex: 1;
        }
        
        .user-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 3px solid #22c55e;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 14px;
        }
        
        .credits-value {
            color: #22c55e;
            font-size: 18px;
        }
        
        .credits-zero {
            color: #ef4444;
            font-size: 18px;
        }
        
        .call-status {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .call-timer {
            font-size: 32px;
            font-weight: 800;
            color: #22c55e;
            margin: 20px 0;
            font-family: monospace;
        }

        .incoming-call-status {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        .incoming-call-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .incoming-call-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .incoming-call-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* 🚨 YENÄ°: Rate Limit Bildirimi */
        .rate-limit-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #92400e;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #fcd34d;
            text-align: center;
            animation: shake 0.5s ease-in-out;
        }
        
        .rate-limit-warning .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .rate-limit-warning .title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .rate-limit-warning .message {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .rate-limit-warning .countdown {
            font-size: 24px;
            font-weight: 800;
            font-family: monospace;
            color: #dc2626;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #16a34a;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            border-left: 4px solid #22c55e;
        }
        
        .hidden {
            display: none !important;
        }
        
        .footer {
            background: #f8fafc;
            padding: 15px;
            text-align: center;
            font-size: 11px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
        }
        
        .contact-info {
            background: #eff6ff;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: center;
            border-left: 3px solid #3b82f6;
        }
        
        .contact-info strong {
            color: #1e40af;
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .contact-info span {
            color: #374151;
            font-size: 13px;
        }
        
        .credit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in;
        }
        
        .credit-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 320px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }
        
        .credit-modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .credit-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .credit-modal-details {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 3px solid #22c55e;
        }
        
        .credit-modal-duration {
            font-size: 24px;
            font-weight: 800;
            color: #2563eb;
            margin: 5px 0;
            font-family: monospace;
        }
        
        .credit-modal-credit {
            font-size: 18px;
            font-weight: 700;
            color: #ef4444;
            margin: 5px 0;
        }
        
        .credit-modal-remaining {
            font-size: 16px;
            font-weight: 600;
            color: #22c55e;
            margin: 5px 0;
        }
        
        .credit-modal-close {
            background: #22c55e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .credit-modal-close:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }

        .btn-calling {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="connection-status">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText" data-text-tr="Bağlanıyor..." data-text-en="Connecting...">Bağlanıyor...</span>
            </div>
            
            <div class="lang-toggle" onclick="toggleLanguage()">
                <span id="currentFlag">🇹🇷</span>
                <span id="currentLang">TR</span>
            </div>
            
            <div class="logo">
                <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
                    <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                </svg>
            </div>
            <div class="app-title" data-text-tr="USTAMA SOR" data-text-en="ASK MY MASTER">USTAMA SOR</div>
            <div class="app-subtitle" data-text-tr="Teknik Servis Danışmanlığı" data-text-en="Technical Support Service">Teknik Servis Danışmanlığı</div>
        </div>
        
        <!-- KVKK Onay Ekranı -->
        <div id="kvkkScreen" class="kvkk-screen">
            <div class="kvkk-title" data-text-tr="📋 Kişisel Verilerin Korunması Hakkında Bilgilendirme" data-text-en="📋 Personal Data Protection Information">📋 Kişisel Verilerin Korunması Hakkında Bilgilendirme</div>
            
            <div class="kvkk-content">
                <h4 data-text-tr="1. Veri İşleme ve Gizlilik" data-text-en="1. Data Processing and Privacy">1. Veri İşleme ve Gizlilik</h4>
                <p data-text-tr="Bu hizmet kapsamında kullanıcıların sesli görüşmeleri kayıt altına alınmamaktadır. Görüşme içerikleri tarafımızca saklanmaz, üçüncü kişilerle paylaşılmaz." data-text-en="Under this service, users' voice conversations are not recorded. Conversation contents are not stored or shared with third parties by us.">Bu hizmet kapsamında kullanıcıların sesli görüşmeleri kayıt altına alınmamaktadır. Görüşme içerikleri tarafımızca saklanmaz, üçüncü kişilerle paylaşılmaz.</p>
                
                <h4 data-text-tr="2. Anonim Kullanım" data-text-en="2. Anonymous Usage">2. Anonim Kullanım</h4>
                <p data-text-tr="Sistemi kullanmak için kimlik, ad-soyad, telefon numarası, e-posta gibi herhangi bir kişisel bilgi talep edilmez veya saklanmaz. Kullanıcılar tamamen anonim olarak hizmetten yararlanır." data-text-en="No personal information such as identity, name-surname, phone number, e-mail is requested or stored to use the system. Users benefit from the service completely anonymously.">Sistemi kullanmak için kimlik, ad-soyad, telefon numarası, e-posta gibi herhangi bir kişisel bilgi talep edilmez veya saklanmaz. Kullanıcılar tamamen anonim olarak hizmetten yararlanır.</p>
                
                <h4 data-text-tr="3. KVKK Uyarısı" data-text-en="3. GDPR Notice">3. KVKK Uyarısı</h4>
                <p data-text-tr="6698 sayılı Kişisel Verilerin Korunması Kanunu (\"KVKK\") kapsamında, sistem yalnızca teknik olarak gerekli anonim oturum bilgilerini (örneğin tarayıcı tipi, bağlantı süresi, hata kayıtları) geçici olarak işleyebilir. Bu veriler kimliğinizi tespit etmeyecek şekilde tutulur ve sistem performansı amacıyla kısa süreli saklanır." data-text-en="Within the scope of the Personal Data Protection Law No. 6698 (\"GDPR\"), the system can only temporarily process technically necessary anonymous session information (e.g. browser type, connection time, error logs). This data is kept in a way that will not identify you and is stored for a short time for system performance purposes.">6698 sayılı Kişisel Verilerin Korunması Kanunu ("KVKK") kapsamında, sistem yalnızca teknik olarak gerekli anonim oturum bilgilerini (örneğin tarayıcı tipi, bağlantı süresi, hata kayıtları) geçici olarak işleyebilir. Bu veriler kimliğinizi tespit etmeyecek şekilde tutulur ve sistem performansı amacıyla kısa süreli saklanır.</p>
                
                <h4 data-text-tr="4. Kullanıcı Sorumluluğu" data-text-en="4. User Responsibility">4. Kullanıcı Sorumluluğu</h4>
                <p data-text-tr="Bu hizmet, teknik destek amacıyla sunulur. Görüşme esnasında kullanıcı tarafından iletilen her türlü bilgi, belge veya kişisel veri paylaşımı tamamen kullanıcının kendi sorumluluğundadır." data-text-en="This service is provided for technical support purposes. Any information, documents or personal data shared by the user during the conversation is entirely the user's own responsibility.">Bu hizmet, teknik destek amacıyla sunulur. Görüşme esnasında kullanıcı tarafından iletilen her türlü bilgi, belge veya kişisel veri paylaşımı tamamen kullanıcının kendi sorumluluğundadır.</p>
                
                <h4 data-text-tr="5. Onay" data-text-en="5. Consent">5. Onay</h4>
                <p data-text-tr="Bu metni onaylayarak:" data-text-en="By approving this text:">Bu metni onaylayarak:</p>
                <ul>
                    <li data-text-tr="Ses kayıtlarının tutulmayacağını," data-text-en="That voice recordings will not be kept,">Ses kayıtlarının tutulmayacağını,</li>
                    <li data-text-tr="Kimliğimin tespitine imkân verecek herhangi bir bilginin talep edilmediğini," data-text-en="That no information that would allow identification of my identity is requested,">Kimliğimin tespitine imkân verecek herhangi bir bilginin talep edilmediğini,</li>
                    <li data-text-tr="Görüşme sırasında kendi isteğimle paylaşacağım bilgilerden yalnızca kendimin sorumlu olacağımı" data-text-en="That I will be solely responsible for the information I share voluntarily during the conversation">Görüşme sırasında kendi isteğimle paylaşacağım bilgilerden yalnızca kendimin sorumlu olacağımı</li>
                </ul>
                <p data-text-tr="kabul ve beyan ediyorum." data-text-en="I accept and declare.">kabul ve beyan ediyorum.</p>
            </div>
            
            <div class="kvkk-checkbox-container">
                <input type="checkbox" id="kvkkCheckbox" class="kvkk-checkbox">
                <label for="kvkkCheckbox" class="kvkk-checkbox-label" data-text-tr="Okudum, anladım, onaylıyorum" data-text-en="I have read, understood and approve">Okudum, anladım, onaylıyorum</label>
            </div>
            
            <div class="kvkk-buttons">
                <button class="btn btn-kvkk-decline" onclick="declineKVKK()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    <span data-text-tr="Reddet" data-text-en="Decline">Reddet</span>
                </button>
                <button class="btn btn-kvkk-accept" id="kvkkAcceptBtn" disabled onclick="acceptKVKK()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span data-text-tr="Onaylıyorum" data-text-en="I Approve">Onaylıyorum</span>
                </button>
            </div>
        </div>
        
        <div class="app-content">
            <!-- 🚨 YENI: Rate Limit Uyarısı -->
            <div id="rateLimitWarning" class="rate-limit-warning hidden">
                <div class="icon">⚠️</div>
                <div class="title" data-text-tr="Çok Fazla Başarısız Deneme!" data-text-en="Too Many Failed Attempts!">Çok Fazla Başarısız Deneme!</div>
                <div class="message" data-text-tr="Güvenlik nedeniyle giriş yapmamız engellenmiştir. Lütfen bekleyiniz." data-text-en="Login has been blocked for security reasons. Please wait.">Güvenlik nedeniyle giriş yapmamız engellenmiştir. Lütfen bekleyiniz.</div>
                <div class="countdown" id="rateLimitCountdown">--:--</div>
            </div>
            
            <!-- Giriş Ekranı -->
            <div id="loginScreen" class="hidden">
                <div class="form-group">
                    <label class="form-label" data-text-tr="4 Haneli ID Kodunuz" data-text-en="Your 4-Digit ID Code">4 Haneli ID Kodunuz</label>
                    <input type="text" class="form-input user-id-input" id="userIdInput" 
                           placeholder="0000" maxlength="4" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label" data-text-tr="Ad Soyad" data-text-en="Full Name">Ad Soyad</label>
                    <input type="text" class="form-input" id="userNameInput" 
                           data-placeholder-tr="Adınızı ve Soyadınızı" data-placeholder-en="Your First and Last Name"
                           placeholder="Adınızı ve Soyadınızı">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin: 0;">
                    <label for="rememberMe" style="margin: 0; font-size: 14px; color: #374151; cursor: pointer;" 
                           data-text-tr="🔒 Beni Hatırla" data-text-en="🔒 Remember Me">
                        🔒 Beni Hatırla
                    </label>
                </div>
                <button class="btn btn-login" id="loginButton">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span data-text-tr="Giriş Yap" data-text-en="Sign In">Giriş Yap</span>
                </button>
                
                <div class="contact-info">
                    <strong data-text-tr="💳 Kredi Talebi" data-text-en="💳 Credit Request">💳 Kredi Talebi</strong>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-whatsapp" onclick="requestCreditWhatsApp()">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.297"/>
                            </svg>
                            <span data-text-tr="WhatsApp ile Kredi Talep Et" data-text-en="Request Credit via WhatsApp">WhatsApp ile Kredi Talep Et</span>
                        </button>
                        <div style="font-size: 12px; color: #64748b; text-align: center;">
                            📞 +90 537 479 24 03
                        </div>
                    </div>
                </div>
                
                <div id="loginMessage"></div>
            </div>
            
            <!-- Ana Uygulama -->
            <div id="mainApp" class="hidden">
                <!-- Kullanıcı Bilgileri -->
                <div class="user-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label" data-text-tr="Kullanıcı" data-text-en="User">Kullanıcı</div>
                            <div class="info-value" id="displayUserName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ID</div>
                            <div class="info-value" id="displayUserId">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-text-tr="Kredi Bakiye" data-text-en="Credit Balance">Kredi Bakiye</div>
                            <div class="info-value credits-value" id="displayUserCredits">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-text-tr="Durum" data-text-en="Status">Durum</div>
                            <div class="info-value" id="displayUserStatus" data-text-tr="Hazır" data-text-en="Ready">Hazır</div>
                        </div>
                    </div>
                </div>

                <!-- Gelen Arama Ekranı -->
                <div id="incomingCallState" class="hidden">
                    <div class="incoming-call-status">
                        <div class="incoming-call-title" data-text-tr="📞 GELEN ARAMA" data-text-en="📞 INCOMING CALL">📞 GELEN ARAMA</div>
                        <div class="incoming-call-subtitle" data-text-tr="🔧 USTAM ARIYOR" data-text-en="🔧 MASTER CALLING">🔧 USTAM ARIYOR</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;" 
                             data-text-tr="Aramayı kabul ediyor musunuz?" data-text-en="Do you accept the call?">
                            Aramayı kabul ediyor musunuz?
                        </div>
                        <div class="incoming-call-buttons">
                            <button class="btn btn-accept" onclick="acceptIncomingCall()">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                                </svg>
                                <span data-text-tr="Kabul Et" data-text-en="Accept">Kabul Et</span>
                            </button>
                            <button class="btn btn-reject" onclick="rejectIncomingCall()">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                <span data-text-tr="Reddet" data-text-en="Reject">Reddet</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Boş Durum -->
                <div id="idleState">
                    <button class="btn btn-call" onclick="startCall()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                        </svg>
                        <span data-text-tr="Ustamı Ara" data-text-en="Call Master">Ustamı Ara</span>
                    </button>
                    
                    <button class="btn btn-whatsapp" onclick="requestCreditWhatsApp()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.297"/>
                        </svg>
                        <span data-text-tr="WhatsApp Kredi Talebi" data-text-en="WhatsApp Credit Request">WhatsApp Kredi Talebi</span>
                    </button>
                    
                    <button class="btn btn-logout" onclick="logoutUser()">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                        </svg>
                        <span data-text-tr="Çıkış Yap" data-text-en="Sign Out">Çıkış Yap</span>
                    </button>
                    
                    <div id="errorMessage" class="error-message hidden"></div>
                </div>
                
                <!-- Arama Durumu -->
                <div id="callingState" class="hidden">
                    <div class="call-status">
                        <div style="color: #fbbf24; font-weight: 700; font-size: 18px;" 
                             data-text-tr="📞 Aranıyor..." data-text-en="📞 Calling...">📞 Aranıyor...</div>
                        <div style="font-size: 14px; color: #64748b; margin-top: 8px;" 
                             data-text-tr="Lütfen bekleyin" data-text-en="Please wait">Lütfen bekleyin</div>
                    </div>
                    <button class="btn btn-end" onclick="cancelCall()">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <span data-text-tr="İptal Et" data-text-en="Cancel">İptal Et</span>
                    </button>
                </div>
                
                <!-- Bağlanıyor Durumu -->
                <div id="connectingState" class="hidden">
                    <div class="call-status">
                        <div style="color: #2563eb; font-weight: 700; font-size: 18px;" 
                             data-text-tr="🔗 Bağlanıyor..." data-text-en="🔗 Connecting...">🔗 Bağlanıyor...</div>
                        <div style="font-size: 14px; color: #64748b; margin-top: 8px;" 
                             data-text-tr="Ses bağlantısı kuruluyor" data-text-en="Establishing audio connection">Ses bağlantısı kuruluyor</div>
                    </div>
                </div>
                
                <!-- Aktif Görüşme -->
                <div id="connectedState" class="hidden">
                    <div class="call-status">
                        <div style="color: #22c55e; font-weight: 700; font-size: 18px;" 
                             data-text-tr="📊 Görüşme Aktif" data-text-en="📊 Call Active">📊 Görüşme Aktif</div>
                        <div class="call-timer" id="callTimer">00:00</div>
                    </div>
                    <button class="btn btn-end" onclick="endCall()">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <span data-text-tr="Görüşmeyi Sonlandır" data-text-en="End Call">Görüşmeyi Sonlandır</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div data-text-tr="VIPCEP Teknik Servis © 2025" data-text-en="VIPCEP Technical Service © 2025">VIPCEP Teknik Servis © 2025</div>
            <div style="margin-top: 5px;" data-text-tr="Mobil Cihaz Teknik Danışmanlığı" data-text-en="Mobile Device Technical Consultancy">Mobil Cihaz Teknik Danışmanlığı</div>
        </div>
    </div>
    
    <!-- Kredi Bildirimi Modal -->
    <div id="creditModalOverlay" class="credit-modal-overlay hidden">
        <div class="credit-modal">
            <div class="credit-modal-icon">💳</div>
            <div class="credit-modal-title" data-text-tr="Görüşme Sona Erdi" data-text-en="Call Ended">Görüşme Sona Erdi</div>
            
            <div class="credit-modal-details">
                <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;" 
                     data-text-tr="Görüşme Süresi" data-text-en="Call Duration">Görüşme Süresi</div>
                <div class="credit-modal-duration" id="modalDuration">00:00</div>
                
                <div style="font-size: 14px; color: #64748b; margin-bottom: 8px; margin-top: 12px;" 
                     data-text-tr="Kullanılan Kredi" data-text-en="Credits Used">Kullanılan Kredi</div>
                <div class="credit-modal-credit" id="modalCreditsUsed" 
                     data-text-tr="0 dakika" data-text-en="0 minutes">0 dakika</div>
                
                <div style="font-size: 14px; color: #64748b; margin-bottom: 8px; margin-top: 12px;" 
                     data-text-tr="Kalan Krediniz" data-text-en="Remaining Credits">Kalan Krediniz</div>
                <div class="credit-modal-remaining" id="modalRemainingCredits" 
                     data-text-tr="0 dakika" data-text-en="0 minutes">0 dakika</div>
            </div>
            
            <button class="credit-modal-close" onclick="closeCreditModal()">
                <span data-text-tr="✓ Tamam" data-text-en="✓ OK">✓ Tamam</span>
            </button>
        </div>
    </div>
    
    <!-- Gizli ses elementleri -->
    <audio id="localAudio" muted></audio>
    <audio id="remoteAudio" autoplay></audio>
    
    <script>
        // Language support
        let currentLanguage = 'tr';
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let callState = 'idle';
        let callTimer = null;
        let callDuration = 0;
        let callStartTime = null;
        let isLoggedIn = false;
        let serverUrl = 'wss://vipcep-server-production.up.railway.app';
        let ringbackAudio = null;
        let incomingCallInfo = null;
        let kvkkApproved = false;
        
        // 🚨 YENİ: Rate Limit değişkenleri
        let rateLimitEndTime = null;
        let rateLimitTimer = null;
        
        let userInfo = {
            id: '',
            name: '',
            credits: 0,
            adminId: "ADMIN001"
        };
        
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        // Sayfa yüklendiğinde başlat
        window.onload = function() {
            init();
        };
        
        function init() {
            setupEventListeners();
            loadSavedUserInfo();
            connectToServer();
            
            const savedLang = localStorage.getItem('vipcep_language');
            if (savedLang && (savedLang === 'tr' || savedLang === 'en')) {
                currentLanguage = savedLang;
            }
            updateLanguage();
        }
        
        function setupEventListeners() {
            // KVKK checkbox
            document.getElementById('kvkkCheckbox').addEventListener('change', (e) => {
                document.getElementById('kvkkAcceptBtn').disabled = !e.target.checked;
            });

            // Login form
            document.getElementById('userIdInput').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
            
            document.getElementById('userIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });
            
            document.getElementById('userNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'tr' ? 'en' : 'tr';
            updateLanguage();
            localStorage.setItem('vipcep_language', currentLanguage);
        }
        
        function updateLanguage() {
            document.getElementById('currentFlag').textContent = currentLanguage === 'tr' ? '🇹🇷' : '🇺🇸';
            document.getElementById('currentLang').textContent = currentLanguage.toUpperCase();
            
            document.querySelectorAll('[data-text-tr]').forEach(element => {
                const trText = element.getAttribute('data-text-tr');
                const enText = element.getAttribute('data-text-en');
                element.textContent = currentLanguage === 'tr' ? trText : enText;
            });
            
            document.querySelectorAll('[data-placeholder-tr]').forEach(element => {
                const trPlaceholder = element.getAttribute('data-placeholder-tr');
                const enPlaceholder = element.getAttribute('data-placeholder-en');
                element.placeholder = currentLanguage === 'tr' ? trPlaceholder : enPlaceholder;
            });
            
            updateConnectionStatus();
        }
        
        function updateConnectionStatus() {
            const connectionText = document.getElementById('connectionText');
            const statusDot = document.getElementById('connectionDot');
            
            if (statusDot.classList.contains('status-connected')) {
                connectionText.textContent = currentLanguage === 'tr' ? 'Bağlı' : 'Connected';
            } else {
                connectionText.textContent = currentLanguage === 'tr' ? 'Bağlantı Yok' : 'Disconnected';
            }
        }

        // KVKK functions
        async function checkKVKKConsent() {
            return new Promise((resolve) => {
                let responseReceived = false;
                
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'kvkk-check' }));
                    
                    const messageHandler = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'kvkk-status') {
                            responseReceived = true;
                            socket.removeEventListener('message', messageHandler);
                            resolve(message.hasConsent);
                        }
                    };
                    
                    socket.addEventListener('message', messageHandler);
                    
                    // 🚨 YENİ: 5 saniye timeout - response gelmezse false döndür
                    setTimeout(() => {
                        if (!responseReceived) {
                            console.log('⚠️ KVKK check timeout - 5 saniye içinde response alınamadı');
                            socket.removeEventListener('message', messageHandler);
                            resolve(false); // Timeout durumunda false döndür (KVKK ekranını zorla göster)
                        }
                    }, 5000);
                } else {
                    console.log('⚠️ WebSocket bağlantısı yok, KVKK ekranı gösterilecek');
                    resolve(false);
                }
            });
        }
        async function acceptKVKK() {
            if (!document.getElementById('kvkkCheckbox').checked) return;
            
            const success = await saveKVKKConsent();
            if (success) {
                kvkkApproved = true;
                document.getElementById('kvkkScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                const rememberMe = localStorage.getItem('vipcep_remember_me') === 'true';
                const savedUserId = localStorage.getItem('vipcep_user_id');
                const savedUserName = localStorage.getItem('vipcep_user_name');
                
                if (rememberMe && savedUserId && savedUserName) {
                    setTimeout(() => {
                        const welcomeMsg = currentLanguage === 'tr' 
                            ? `Hoş geldiniz ${savedUserName}! Otomatik giriş yapılıyor...`
                            : `Welcome ${savedUserName}! Auto-login in progress...`;
                        showLoginMessage(welcomeMsg, 'success');
                        
                        setTimeout(() => {
                            loginUser();
                        }, 1500);
                    }, 500);
                }
            } else {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Onay kaydedilemedi. Lütfen tekrar deneyin.'
                    : 'Consent could not be saved. Please try again.';
                alert(errorMsg);
            }
        }

        function declineKVKK() {
            const message = currentLanguage === 'tr' 
                ? 'KVKK onayı olmadan sistemi kullanamazsınız.'
                : 'You cannot use the system without GDPR consent.';
            alert(message);
            window.close();
        }
        
        function loadSavedUserInfo() {
            const savedUserId = localStorage.getItem('vipcep_user_id');
            const savedUserName = localStorage.getItem('vipcep_user_name');
            const rememberMe = localStorage.getItem('vipcep_remember_me') === 'true';
            
            if (rememberMe && savedUserId && savedUserName) {
                document.getElementById('userIdInput').value = savedUserId;
                document.getElementById('userNameInput').value = savedUserName;
                document.getElementById('rememberMe').checked = true;
            }
        }
        
        function saveUserInfo() {
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (rememberMe) {
                localStorage.setItem('vipcep_user_id', userInfo.id);
                localStorage.setItem('vipcep_user_name', userInfo.name);
                localStorage.setItem('vipcep_remember_me', 'true');
            } else {
                localStorage.removeItem('vipcep_user_id');
                localStorage.removeItem('vipcep_user_name');
                localStorage.removeItem('vipcep_remember_me');
            }
        }
        
        function requestCreditWhatsApp() {
            const name = userInfo.name || document.getElementById('userNameInput').value || (currentLanguage === 'tr' ? 'Belirtilmedi' : 'Not specified');
            const id = userInfo.id || document.getElementById('userIdInput').value || (currentLanguage === 'tr' ? 'Belirtilmedi' : 'Not specified');
            
            let message;
            if (currentLanguage === 'tr') {
                message = `🎯 VIPCEP Kredi Talebi\n\n👤 Ad: ${name}\n🆔 ID: ${id}\n💳 Kredi talep ediyorum\n\nLütfen bana kredi yükleyip arama yapmamı sağlayın. Teşekkürler.`;
            } else {
                message = `🎯 VIPCEP Credit Request\n\n👤 Name: ${name}\n🆔 ID: ${id}\n💳 I request credit\n\nPlease load credit for me to make calls. Thank you.`;
            }
            
            const phoneNumber = '905374792403';
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function connectToServer() {
            try {
                socket = new WebSocket(serverUrl);
                
                socket.onopen = async () => {
                    setConnectionStatus('connected');
                    
                    const hasConsent = await checkKVKKConsent();
                    if (hasConsent) {
                        kvkkApproved = true;
                        document.getElementById('kvkkScreen').classList.add('hidden');
                        document.getElementById('loginScreen').classList.remove('hidden');
                        
                        const rememberMe = localStorage.getItem('vipcep_remember_me') === 'true';
                        const savedUserId = localStorage.getItem('vipcep_user_id');
                        const savedUserName = localStorage.getItem('vipcep_user_name');
                        
                        if (rememberMe && savedUserId && savedUserName) {
                            setTimeout(() => {
                                const welcomeMsg = currentLanguage === 'tr' 
                                    ? `Hoş geldiniz ${savedUserName}! Otomatik giriş yapılıyor...`
                                    : `Welcome ${savedUserName}! Auto-login in progress...`;
                                showLoginMessage(welcomeMsg, 'success');
                                
                                setTimeout(() => {
                                    loginUser();
                                }, 1500);
                            }, 500);
                        }
                    }
                };
                
                socket.onclose = () => {
                    setConnectionStatus('disconnected');
                    isLoggedIn = false;
                    setTimeout(() => connectToServer(), 3000);
                };
                
                socket.onerror = () => {
                    setConnectionStatus('disconnected');
                };
                
                socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };
                
            } catch (error) {
                setConnectionStatus('error');
            }
        }
        
        function setConnectionStatus(status) {
            const connectionDot = document.getElementById('connectionDot');
            
            switch (status) {
                case 'connected':
                    connectionDot.className = 'status-dot status-connected';
                    break;
                case 'disconnected':
                    connectionDot.className = 'status-dot status-disconnected';
                    break;
            }
            
            updateConnectionStatus();
        }
        
        function loginUser() {
            // 🚨 Rate limit kontrolü ÖNCE
            if (rateLimitEndTime && Date.now() < rateLimitEndTime) {
                showRateLimitWarning();
                return;
            }
            
            const userId = document.getElementById('userIdInput').value.trim();
            const userName = document.getElementById('userNameInput').value.trim();
            
            if (!userId || userId.length !== 4) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Lütfen 4 haneli ID kodunuzu girin!'
                    : 'Please enter your 4-digit ID code!';
                showLoginMessage(errorMsg, 'error');
                return;
            }
            
            if (!userName || userName.length < 2) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Lütfen adınızı ve soyadınızı girin!'
                    : 'Please enter your first and last name!';
                showLoginMessage(errorMsg, 'error');
                return;
            }
            
            userInfo.id = userId;
            userInfo.name = userName;
            saveUserInfo();
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'login-request',
                    userId: userId,
                    userName: userName
                }));
                
                document.getElementById('loginButton').disabled = true;
                const checkingText = currentLanguage === 'tr' ? '🔄 Kontrol Ediliyor...' : '🔄 Checking...';
                document.getElementById('loginButton').innerHTML = checkingText;
            } else {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Sunucu bağlantısı yok. Lütfen bekleyin...'
                    : 'No server connection. Please wait...';
                showLoginMessage(errorMsg, 'error');
            }
        }
        
        function loginSuccess() {
            isLoggedIn = true;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('displayUserName').textContent = userInfo.name;
            document.getElementById('displayUserId').textContent = '#' + userInfo.id;
            updateCreditsDisplay();
            
            socket.send(JSON.stringify({
                type: 'register',
                userId: userInfo.id,
                name: userInfo.name,
                userType: 'customer'
            }));
        }
        
        function loginFailed(reason) {
            // 🚨 Rate limit kontrolü - 30 dakika ban mesajını yakala
            if (reason && reason.includes('30 dakika')) {
                handleRateLimit(reason);
                return;
            }
            
            const defaultReason = currentLanguage === 'tr' 
                ? 'Giriş başarısız! ID kodunuzu kontrol edin.'
                : 'Login failed! Please check your ID code.';
            showLoginMessage(reason || defaultReason, 'error');
            
            document.getElementById('loginButton').disabled = false;
            const loginText = currentLanguage === 'tr' ? 'Giriş Yap' : 'Sign In';
            document.getElementById('loginButton').innerHTML = `
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${loginText}
            `;
        }
        
        // 🚨 YENİ: Rate limit işleme
        function handleRateLimit(message) {
            console.log('🚨 Rate limit algılandı:', message);
            
            // 30 dakika ban süresi ayarla
            rateLimitEndTime = Date.now() + (30 * 60 * 1000); // 30 dakika
            localStorage.setItem('vipcep_rate_limit_end', rateLimitEndTime.toString());
            
            showRateLimitWarning();
        }
        
        function showRateLimitWarning() {
            // Login formu gizle, rate limit uyarısını göster
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('rateLimitWarning').classList.remove('hidden');
            
            startRateLimitCountdown();
        }
        
        function startRateLimitCountdown() {
            const countdownElement = document.getElementById('rateLimitCountdown');
            
            if (rateLimitTimer) {
                clearInterval(rateLimitTimer);
            }
            
            rateLimitTimer = setInterval(() => {
                const now = Date.now();
                const timeLeft = rateLimitEndTime - now;
                
                if (timeLeft <= 0) {
                    clearInterval(rateLimitTimer);
                    rateLimitTimer = null;
                    rateLimitEndTime = null;
                    localStorage.removeItem('vipcep_rate_limit_end');
                    
                    // Rate limit uyarısını gizle, login ekranını göster
                    document.getElementById('rateLimitWarning').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    
                    const successMsg = currentLanguage === 'tr' 
                        ? '✅ Artık tekrar giriş yapabilirsiniz!'
                        : '✅ You can now login again!';
                    showLoginMessage(successMsg, 'success');
                    return;
                }
                
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Sayfa yüklendiğinde rate limit kontrolü
        function checkSavedRateLimit() {
            const savedRateLimitEnd = localStorage.getItem('vipcep_rate_limit_end');
            if (savedRateLimitEnd) {
                const endTime = parseInt(savedRateLimitEnd);
                if (Date.now() < endTime) {
                    rateLimitEndTime = endTime;
                    showRateLimitWarning();
                } else {
                    localStorage.removeItem('vipcep_rate_limit_end');
                }
            }
        }
        
        function showLoginMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
        
        function updateCreditsDisplay() {
            const creditsElement = document.getElementById('displayUserCredits');
            const creditsText = currentLanguage === 'tr' ? `${userInfo.credits} dk` : `${userInfo.credits} min`;
            creditsElement.textContent = creditsText;
            creditsElement.className = userInfo.credits > 0 ? 'info-value credits-value' : 'info-value credits-zero';
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
        
        function setState(newState) {
            callState = newState;
            
            document.getElementById('idleState').classList.add('hidden');
            document.getElementById('callingState').classList.add('hidden');
            document.getElementById('connectingState').classList.add('hidden');
            document.getElementById('connectedState').classList.add('hidden');
            document.getElementById('incomingCallState').classList.add('hidden');
            
            const statusElement = document.getElementById('displayUserStatus');
            
            switch (newState) {
                case 'idle':
                    document.getElementById('idleState').classList.remove('hidden');
                    statusElement.textContent = currentLanguage === 'tr' ? 'Hazır' : 'Ready';
                    break;
                case 'calling':
                    document.getElementById('callingState').classList.remove('hidden');
                    statusElement.textContent = currentLanguage === 'tr' ? 'Aranıyor...' : 'Calling...';
                    break;
                case 'connecting':
                    document.getElementById('connectingState').classList.remove('hidden');
                    statusElement.textContent = currentLanguage === 'tr' ? 'Bağlanıyor...' : 'Connecting...';
                    break;
                case 'connected':
                    document.getElementById('connectedState').classList.remove('hidden');
                    statusElement.textContent = currentLanguage === 'tr' ? 'Görüşmede' : 'In Call';
                    startCallTimer();
                    break;
                case 'incoming':
                    document.getElementById('incomingCallState').classList.remove('hidden');
                    statusElement.textContent = currentLanguage === 'tr' ? 'Gelen Arama' : 'Incoming Call';
                    break;
            }
        }
        
        function handleMessage(message) {
            console.log('Message received:', message.type);
            
            switch (message.type) {
                case 'login-response':
                    if (message.success) {
                        userInfo.credits = message.credits || 0;
                        loginSuccess();
                    } else {
                        loginFailed(message.reason);
                    }
                    break;

                case 'admin-call-request':
                    incomingCallInfo = {
                        adminId: message.adminId,
                        adminName: message.adminName || 'Technical Support',
                        startTime: Date.now()
                    };
                    
                    setState('incoming');
                    playIncomingCallSound();
                    
                    setTimeout(() => {
                        if (incomingCallInfo && callState === 'incoming') {
                            rejectIncomingCall('timeout');
                        }
                    }, 30000);
                    break;

                case 'admin-call-cancelled':
                    if (incomingCallInfo) {
                        hideIncomingCall();
                        const errorMsg = currentLanguage === 'tr' 
                            ? 'Teknik destek aramayı iptal etti.'
                            : 'Technical support cancelled the call.';
                        showError(errorMsg);
                        stopIncomingCallSound();
                    }
                    break;
                    
                case 'call-accepted':
                    stopRingbackTone();
                    setupPeerConnection();
                    setState('connecting');
                    break;
                    
                case 'call-rejected':
                    stopRingbackTone();
                    setState('idle');
                    if (message.reason === 'unauthorized') {
                        const errorMsg = currentLanguage === 'tr' 
                            ? 'ID kodunuz onaylanmamış! Lütfen kredi talep edin.'
                            : 'Your ID code is not approved! Please request credit.';
                        showError(errorMsg);
                    } else {
                        const errorMsg = currentLanguage === 'tr' 
                            ? 'Arama reddedildi veya usta müsait değil.'
                            : 'Call rejected or master not available.';
                        showError(errorMsg);
                    }
                    break;
                    
                case 'ice-candidate':
                    if (peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                    }
                    break;
                    
                case 'answer':
                    if (peerConnection) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer))
                            .then(() => {
                                console.log('✅ Remote description (answer) set');
                            })
                            .catch(error => {
                                console.error('❌ Remote description error:', error);
                                endCall();
                            });
                    }
                    break;

                case 'offer':
                    if (incomingCallInfo && peerConnection) {
                        handleIncomingOffer(message);
                    }
                    break;
                    
                case 'call-ended':
                    if (message.creditsUsed && message.creditsUsed > 0) {
                        userInfo.credits = Math.max(0, userInfo.credits - message.creditsUsed);
                        updateCreditsDisplay();
                        showCreditModal(message.duration, message.creditsUsed, userInfo.credits);
                    }
                    endCall();
                    break;
                    
                case 'credit-update':
                    userInfo.credits = message.credits;
                    updateCreditsDisplay();
                    break;
            }
        }

        function acceptIncomingCall() {
            if (!incomingCallInfo) return;
            
            stopIncomingCallSound();
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'admin-call-accepted',
                    userId: userInfo.id,
                    adminId: incomingCallInfo.adminId
                }));
            }
            
            setupIncomingPeerConnection();
        }

        function rejectIncomingCall(reason = 'user_rejected') {
            if (!incomingCallInfo) return;
            
            stopIncomingCallSound();
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                const rejectReason = reason === 'timeout' 
                    ? (currentLanguage === 'tr' 
                        ? 'Müşteri aramayı cevaplamadı (30 saniye zaman aşımı)'
                        : 'Customer did not answer call (30 second timeout)')
                    : (currentLanguage === 'tr' 
                        ? 'Müşteri aramayı reddetti'
                        : 'Customer rejected the call');
                    
                socket.send(JSON.stringify({
                    type: 'admin-call-rejected',
                    userId: userInfo.id,
                    adminId: incomingCallInfo.adminId,
                    reason: rejectReason
                }));
            }
            
            hideIncomingCall();
            
            if (reason === 'timeout') {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Gelen arama zaman aşımına uğradı.'
                    : 'Incoming call timed out.';
                showError(errorMsg);
            }
        }

        function hideIncomingCall() {
            incomingCallInfo = null;
            setState('idle');
        }

        async function setupIncomingPeerConnection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                localStream = stream;
                
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                stream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, stream);
                });
                
                peerConnection.ontrack = (event) => {
                    const remoteAudio = document.getElementById('remoteAudio');
                    if (event.streams && event.streams[0]) {
                        remoteAudio.srcObject = event.streams[0];
                        remoteAudio.play().catch(e => console.log('Remote audio play error:', e));
                    }
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && socket && incomingCallInfo) {
                        socket.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            targetId: incomingCallInfo.adminId
                        }));
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    switch (peerConnection.connectionState) {
                        case 'connected':
                            setState('connected');
                            callStartTime = Date.now();
                            incomingCallInfo = null;
                            break;
                        case 'connecting':
                            setState('connecting');
                            break;
                        case 'failed':
                        case 'disconnected':
                            endCall();
                            break;
                    }
                };
                
                setState('connecting');
                
            } catch (error) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Mikrofon erişimi gerekli!'
                    : 'Microphone access required!';
                showError(errorMsg);
                rejectIncomingCall('mic_error');
            }
        }

        async function handleIncomingOffer(message) {
            if (!peerConnection) return;
            
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.send(JSON.stringify({
                    type: 'answer',
                    answer: answer,
                    targetId: incomingCallInfo.adminId,
                    userId: userInfo.id
                }));
                
            } catch (error) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'WebRTC bağlantı hatası oluştu.'
                    : 'WebRTC connection error occurred.';
                showError(errorMsg);
                rejectIncomingCall('webrtc_error');
            }
        }

        function playIncomingCallSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const playRing = () => {
                    if (callState !== 'incoming') return;
                    
                    const oscillator1 = audioContext.createOscillator();
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator1.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator2.frequency.setValueAtTime(880, audioContext.currentTime);
                    oscillator1.type = 'sine';
                    oscillator2.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0.0, audioContext.currentTime + 1.0);
                    
                    oscillator1.start(audioContext.currentTime);
                    oscillator2.start(audioContext.currentTime);
                    oscillator1.stop(audioContext.currentTime + 1.0);
                    oscillator2.stop(audioContext.currentTime + 1.0);
                    
                    setTimeout(playRing, 1500);
                };
                
                playRing();
            } catch (error) {
                console.log('Ring sound could not play:', error);
            }
        }

        function stopIncomingCallSound() {
            // Sound stops automatically when callState changes
        }
        
        function playRingbackTone() {
            try {
                if (ringbackAudio) stopRingbackTone();
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const playTone = () => {
                    if (callState !== 'calling') return;
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(425, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.25, audioContext.currentTime + 0.1);
                    gainNode.gain.linearRampToValueAtTime(0.0, audioContext.currentTime + 1.0);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1.0);
                    
                    setTimeout(playTone, 4000);
                };
                
                playTone();
                ringbackAudio = { audioContext };
                
            } catch (error) {
                console.log('Ringback tone could not play:', error);
            }
        }
        
        function stopRingbackTone() {
            if (ringbackAudio) {
                try {
                    if (ringbackAudio.audioContext && ringbackAudio.audioContext.state === 'running') {
                        ringbackAudio.audioContext.suspend();
                    }
                } catch (error) {
                    console.log('Ringback tone stop error:', error);
                }
                ringbackAudio = null;
            }
        }
        
        async function setupPeerConnection() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    const remoteAudio = document.getElementById('remoteAudio');
                    if (event.streams && event.streams[0]) {
                        remoteAudio.srcObject = event.streams[0];
                        remoteAudio.play().catch(e => console.log('Remote audio play error:', e));
                    }
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && socket) {
                        socket.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            targetId: userInfo.adminId
                        }));
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    switch (peerConnection.connectionState) {
                        case 'connected':
                            setState('connected');
                            callStartTime = Date.now();
                            break;
                        case 'connecting':
                            setState('connecting');
                            break;
                        case 'failed':
                        case 'disconnected':
                            endCall();
                            break;
                    }
                };
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.send(JSON.stringify({
                    type: 'offer',
                    offer: offer,
                    targetId: userInfo.adminId,
                    userId: userInfo.id,
                    userName: userInfo.name
                }));
                
            } catch (error) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Mikrofon erişimi gerekli.'
                    : 'Microphone access required.';
                showError(errorMsg);
                setState('idle');
            }
        }
        
        function startCall() {
            if (!isLoggedIn) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Lütfen önce giriş yapın!'
                    : 'Please login first!';
                showError(errorMsg);
                return;
            }
            
            if (userInfo.credits <= 0) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Yetersiz kredi! Kredi talep etmek için "Kredi Talep Et" butonunu kullanın.'
                    : 'Insufficient credit! Use "Request Credit" button to request credit.';
                showError(errorMsg);
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                const errorMsg = currentLanguage === 'tr' 
                    ? 'Sunucu bağlantısı yok. Lütfen bekleyin...'
                    : 'No server connection. Please wait...';
                showError(errorMsg);
                return;
            }
            
            setState('calling');
            hideError();
            playRingbackTone();
            
            socket.send(JSON.stringify({
                type: 'call-request',
                userId: userInfo.id,
                userName: userInfo.name,
                credits: userInfo.credits,
                targetId: userInfo.adminId
            }));
            
            setTimeout(() => {
                if (callState === 'calling') {
                    setState('idle');
                    const errorMsg = currentLanguage === 'tr' 
                        ? 'Arama zaman aşımına uğradı.'
                        : 'Call timed out.';
                    showError(errorMsg);
                }
            }, 30000);
        }
        
        function cancelCall() {
            if (socket && callState === 'calling') {
                const reason = currentLanguage === 'tr' 
                    ? 'Müşteri aramayı iptal etti'
                    : 'Customer cancelled the call';
                    
                socket.send(JSON.stringify({
                    type: 'call-cancelled',
                    userId: userInfo.id,
                    userName: userInfo.name,
                    reason: reason
                }));
            }
            
            endCall();
        }
        
        function endCall() {
            stopRingbackTone();
            stopIncomingCallSound();
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (socket && callState === 'connected' && callStartTime) {
                const actualDuration = Math.floor((Date.now() - callStartTime) / 1000);
                const creditsUsed = Math.ceil(actualDuration / 60);
                
                socket.send(JSON.stringify({
                    type: 'end-call',
                    userId: userInfo.id,
                    duration: actualDuration,
                    creditsUsed: creditsUsed,
                    targetId: userInfo.adminId
                }));
            }
            
            if (incomingCallInfo) {
                incomingCallInfo = null;
            }
            
            setState('idle');
            callDuration = 0;
            callStartTime = null;
        }
        
        function startCallTimer() {
            callDuration = 0;
            callTimer = setInterval(() => {
                callDuration++;
                const mins = Math.floor(callDuration / 60);
                const secs = callDuration % 60;
                document.getElementById('callTimer').textContent = 
                    mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
            }, 1000);
        }
        
        function showCreditModal(duration, creditsUsed, remainingCredits) {
            const mins = Math.floor(duration / 60);
            const secs = duration % 60;
            const durationText = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('modalDuration').textContent = durationText;
            
            const creditsUsedText = currentLanguage === 'tr' ? `${creditsUsed} dakika` : `${creditsUsed} minutes`;
            const remainingText = currentLanguage === 'tr' ? `${remainingCredits} dakika` : `${remainingCredits} minutes`;
            
            document.getElementById('modalCreditsUsed').textContent = creditsUsedText;
            document.getElementById('modalRemainingCredits').textContent = remainingText;
            
            document.getElementById('creditModalOverlay').classList.remove('hidden');
        }
        
        function closeCreditModal() {
            document.getElementById('creditModalOverlay').classList.add('hidden');
        }
        
        function logoutUser() {
            const confirmMsg = currentLanguage === 'tr' 
                ? 'Çıkış yapmak istediğinizden emin misiniz?'
                : 'Are you sure you want to sign out?';
                
            if (confirm(confirmMsg)) {
                localStorage.removeItem('vipcep_user_id');
                localStorage.removeItem('vipcep_user_name');
                localStorage.removeItem('vipcep_remember_me');
                
                if (callState !== 'idle') {
                    endCall();
                }
                
                if (socket) {
                    socket.close();
                }
                
                isLoggedIn = false;
                userInfo = { id: '', name: '', credits: 0, adminId: "ADMIN001" };
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                document.getElementById('userIdInput').value = '';
                document.getElementById('userNameInput').value = '';
                document.getElementById('rememberMe').checked = false;
                
                document.getElementById('loginButton').disabled = false;
                const loginText = currentLanguage === 'tr' ? 'Giriş Yap' : 'Sign In';
                document.getElementById('loginButton').innerHTML = `
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ${loginText}
                `;
                
                const successMsg = currentLanguage === 'tr' 
                    ? 'Başarıyla çıkış yaptınız!'
                    : 'Successfully signed out!';
                showLoginMessage(successMsg, 'success');
                
                setTimeout(() => {
                    connectToServer();
                }, 1000);
            }
        }
        
        // 🚨 Sayfa yüklendiğinde rate limit kontrolü ekle
        window.addEventListener('load', () => {
            checkSavedRateLimit();
        });
    </script>
</body>
</html>

