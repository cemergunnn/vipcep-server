<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Admin- Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-info {
            text-align: right;
            position: relative;
        }

        .admin-name {
            font-weight: 700;
            font-size: 16px;
        }

        .admin-role {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
        }

        .tip-notification {
            position: absolute;
            bottom: -45px;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10;
        }
        
        .tip-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.3);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.5);
            transform: translateY(-1px);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connected {
            background: #22c55e;
        }

        .disconnected {
            background: #ef4444;
        }

        .busy {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            grid-template-areas:
                "call-panel users-panel callback-panel"
                "connections-panel connections-panel connections-panel";
        }

        .call-management-panel {
            grid-area: call-panel;
        }

        .users-panel {
            grid-area: users-panel;
        }

        .callback-panel {
            grid-area: callback-panel;
        }

        .connections-panel {
            grid-area: connections-panel;
        }

        .panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(34, 197, 94, 0.1);
        }

        .panel h3 {
            margin-bottom: 20px;
            color: #1e293b;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Video Arama Arayüzü Stilleri */
        .call-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0f172a;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .call-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }

        .fullscreen-call-container {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0f172a;
            color: white;
        }

        .call-header {
            padding: 20px;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 102;
            background: linear-gradient(to bottom, rgba(15,23,42,0.9), transparent);
        }

        .call-footer {
            padding: 20px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 102;
            background: linear-gradient(to top, rgba(15,23,42,0.9), transparent);
        }

        .main-video-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
        }

        .video-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 101;
        }

        .screenshare-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 102;
            display: none;
            background: #000;
        }

        .screenshare-container.active {
            display: block;
        }

        .screen-stream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .pip-video-container {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 130px;
            height: 180px;
            z-index: 103;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }

        .pip-video-container.active {
            display: block;
        }

        .pip-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.3);
        }

        .control-btn.active {
            background: #22c55e;
        }

        .control-btn.end-call {
            background: #ef4444;
        }

        .control-btn.end-call:hover {
            background: #dc2626;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 200;
            max-width: 400px;
            width: 90%;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
        }

        .device-selector {
            margin-bottom: 15px;
        }

        .device-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .device-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        /* Chat Panel */
        .chat-panel {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 300px;
            height: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 104;
            overflow: hidden;
        }

        .chat-panel.active {
            display: flex;
        }

        .chat-header {
            padding: 15px;
            background: #22c55e;
            color: white;
            font-weight: bold;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f0f2f5;
        }

        .chat-input-container {
            padding: 10px;
            border-top: 1px solid #eaeaea;
            display: flex;
            background: white;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
        }

        .send-btn {
            margin-left: 10px;
            background: #22c55e;
            border: none;
            width: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
        }

        .message {
            margin-bottom: 10px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            clear: both;
        }

        .message.received {
            background: white;
            float: left;
            border-bottom-left-radius: 5px;
			color: #374151;
        }

        .message.sent {
            background: #dcf8c6;
            color: #075e54;
            float: right;
            border-bottom-right-radius: 5px;
        }

        /* Switch Camera Button */
        #switchCameraBtn {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 105;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #switchCameraBtn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Existing styles continue... */
        .callback-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            overflow: hidden;
        }

        .callback-header {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .callback-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .callback-counter {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .callback-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .callback-empty {
            text-align: center;
            padding: 30px 20px;
            color: #64748b;
            font-style: italic;
        }

        .callback-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .callback-item:hover {
            background: #fef3c7;
        }

        .callback-item:last-child {
            border-bottom: none;
        }

        .callback-info {
            flex: 1;
        }

        .callback-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .callback-details {
            font-size: 12px;
            color: #64748b;
            display: flex;
            gap: 10px;
        }

        .callback-actions {
            display: flex;
            gap: 8px;
        }

        .call-status-card {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .outgoing-call {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 25px;
            text-align: center;
            animation: callPulse 1.5s infinite;
        }

        .incoming-call {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 25px;
            text-align: center;
            animation: callPulse 1.5s infinite;
        }

        .active-call {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .call-status-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .call-status-details {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .call-timer-display {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        @keyframes callPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .call-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-accept {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .btn-reject {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-call {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-end {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-delete {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .audio-controls {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .audio-controls h4 {
            margin-bottom: 10px;
            color: #1e293b;
            font-size: 14px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
        }

        .audio-toggle {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-toggle.enabled {
            background: #22c55e;
            color: white;
        }

        .audio-toggle.disabled {
            background: #ef4444;
            color: white;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #22c55e;
            transform: translateY(-1px);
        }

        .user-item.online-user {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-color: #22c55e;
        }

        .user-info {
            flex: 1;
        }

        .user-id {
            font-weight: 700;
            color: #2563eb;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .user-name {
            color: #374151;
            font-size: 15px;
            font-weight: 600;
            margin: 2px 0;
        }

        .user-credits {
            color: #059669;
            font-size: 13px;
            font-weight: 600;
        }

        .user-status {
            color: #6b7280;
            font-size: 12px;
            margin-top: 4px;
        }

        .user-status.online {
            color: #22c55e;
            font-weight: 600;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connected-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .connected-user:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .user-online-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 4px solid #22c55e;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.slide-out {
            animation: slideOut 0.3s ease-in;
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .notification.success {
            border-left-color: #22c55e;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.info {
            border-left-color: #3b82f6;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .admin-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            font-size: 12px;
        }

        .admin-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .admin-status.available .admin-status-dot {
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        .admin-status.busy .admin-status-dot {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .admin-status.offline .admin-status-dot {
            background: #6b7280;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
        }

        #profileModalContent h3 {
            color: #16a34a;
            margin-bottom: 25px;
            font-size: 22px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .profile-stat-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .profile-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .profile-stat-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .star-rating {
            color: #f59e0b;
        }

        #profileModalContent h4 
		{
            color: #374151;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .reviews-list {
            margin-top: 20px;
        }

        .review-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-author {
            font-weight: 600;
            color: #374151;
        }

        .review-date {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }

        .review-comment {
            color: #4b5563;
            line-height: 1.5;
            font-size: 14px;
        }

        .review-tip {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #16a34a;
        }

        .no-reviews {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-style: italic;
        }

        .modal-footer {
            margin-top: 25px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "call-panel"
                    "users-panel"
                    "callback-panel"
                    "connections-panel";
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-right {
                justify-content: center;
            }

            .callback-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .callback-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>📞 VIPCEP Admin Panel</h1>
                <p>Teknik Servis Danışmanlığı</p>
            </div>
            <div class="header-right">
                <div class="status">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">Bağlanıyor...</span>
                </div>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">-</div>
                    <div class="admin-role" id="adminRole">🟡 Normal Admin</div>
                    <div class="admin-earnings" id="adminEarnings" style="font-size: 11px; color: #fbbf24; background: rgba(251, 191, 36, 0.2); padding: 3px 8px; border-radius: 10px; margin-top: 3px;">
                        💰 <span id="earningsAmount">0</span> Kredi kazanç
                    </div>
                    <div class="admin-status available" id="adminStatus">
                        <div class="admin-status-dot"></div>
                        <span>Müsait</span>
                    </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="openProfileModal()" style="padding: 8px 16px; font-size: 14px;">
                    👤 Profilim
                </button>
                <button class="btn btn-secondary btn-small" onclick="openSettingsModal()" style="padding: 8px 16px; font-size: 14px;">
                    ⚙️ Ayarlar
                </button>
                <button class="logout-btn" onclick="performLogout()">🚪 Çıkış</button>
            </div>
        </div>

        <div class="main-content">
            <div class="panel call-management-panel">
                <h3>📞 Arama Yönetimi</h3>
                <div class="audio-controls">
                    <h4>🔊 Ses Kontrolleri</h4>
                    <div class="volume-control">
                        <span style="font-size: 12px; width: 80px;">Ses Seviyesi:</span>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                        <span style="font-size: 12px; width: 30px;" id="volumeValue">70%</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="audio-toggle enabled" id="micToggle" onclick="toggleMicrophone()">🎤 Mikrofon</button>
                        <button class="audio-toggle enabled" id="speakerToggle" onclick="toggleSpeaker()">🔊 Hoparlör</button>
                        <button class="audio-toggle disabled" id="noiseToggle" onclick="toggleNoiseSuppression()">🚫 Gürültü</button>
                    </div>
                </div>

                <div id="incomingCall" class="call-status-card incoming-call hidden">
                    <div class="call-status-title">📞 GELEN ARAMA</div>
                    <div class="call-status-details">
                        <p style="font-size: 18px; font-weight: 600;"><span id="incomingName">-</span></p>
                        <p style="opacity: 0.9;">ID: <span id="incomingId">-</span></p>
                        <p style="opacity: 0.8; font-size: 12px; margin-top: 5px;">Müşteri sizi arıyor...</p>
                    </div>
                    <div class="call-buttons">
                        <button class="btn btn-accept" onclick="acceptIncomingCall()">✅ Kabul Et</button>
                        <button class="btn btn-reject" onclick="rejectIncomingCall()">❌ Reddet</button>
                    </div>
                </div>

                <div id="outgoingCall" class="call-status-card outgoing-call hidden">
                    <div class="call-status-title">📞 GİDEN ARAMA</div>
                    <div class="call-status-details">
                        <p style="font-size: 18px; font-weight: 600;"><span id="outgoingName">-</span></p>
                        <p style="opacity: 0.9;">ID: <span id="outgoingId">-</span></p>
                        <p style="opacity: 0.8; font-size: 12px; margin-top: 5px;">Bağlantı kuruluyor...</p>
                    </div>
                    <div class="call-buttons">
                        <button class="btn btn-reject" onclick="cancelOutgoingCall()">❌ İptal Et</button>
                    </div>
                </div>

                <div id="activeCall" class="call-status-card active-call hidden">
                    <div class="call-status-title">🔊 GÖRÜŞME AKTİF</div>
                    <div class="call-status-details">
                        <p style="font-size: 18px; font-weight: 600; margin: 10px 0;"><span id="activeCaller">-</span></p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                            <div>
                                <div style="font-size: 12px; opacity: 0.8;">Görüşme Süresi</div>
                                <div class="call-timer-display" id="callTimer">00:00</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; opacity: 0.8;">Bağlantı</div>
                                <div style="font-size: 14px; font-weight: 600;" id="connectionQuality">İyi</div>
                            </div>
                        </div>
                    </div>
                    <div class="call-buttons">
                        <button class="btn btn-end" onclick="endCall()">📞 Görüşmeyi Bitir</button>
                        <button class="btn btn-primary" onclick="muteCall()" id="muteButton">🔇 Sessize Al</button>
                        <button class="btn btn-primary" onclick="switchToVideoCall()" id="videoCallButton">📹 Video Arama</button>
                    </div>
                </div>
            </div>

            <div class="panel users-panel hidden">
                <h3>🟢 Online Kullanıcılar</h3>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="🔍 Kullanıcı adı veya ID ile ara..." oninput="searchUsers()">
                    <div class="search-icon">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                </div>
                <div class="user-list" id="onlineUsersList">
                    <div style="text-align: center; color: #6b7280; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">👥</div>
                        <div>Online kullanıcılar yükleniyor...</div>
                    </div>
                </div>
            </div>

            <div class="callback-panel">
                <div class="callback-container" id="callbackContainer">
                    <div class="callback-header">
                        <div class="callback-title">
                            <span>📝 Geri Dönüş Bekleyenler</span>
                        </div>
                        <div class="callback-counter" id="callbackCounter">0</div>
                    </div>
                    <div class="callback-list" id="callbackList">
                        <div class="callback-empty">
                            <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">📝</div>
                            <div>Henüz geri dönüş bekleyen yok</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel connections-panel">
                <h3>👥 Aktif Bağlantılar</h3>
                <div id="userList" style="margin-top: 15px;">
                    <div style="text-align: center; color: #6b7280; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🌐</div>
                        <div>Henüz kullanıcı bağlanmadı</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">🔄 Verileri Yenile</button>
                    <button class="btn btn-primary" onclick="window.open('https://wa.me/905374792403', '_blank')">💬 WhatsApp Destek</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Arama Overlay -->
    <div id="callOverlay" class="call-overlay hidden">
        <div id="fullscreenCallView" class="fullscreen-call-container">
            <div class="call-header">
                <h2 id="currentCustomerName">Müşteri ile Görüşme</h2>
                <div id="callTimerOverlay">00:00</div>
            </div>
            
            <div class="main-video-container">
                <video id="remoteVideoStream" class="video-stream" autoplay playsinline></video>
            </div>
            
            <div id="screenshareContainer" class="screenshare-container">
                <video id="screenshareVideo" class="screen-stream" autoplay playsinline></video>
            </div>
            
            <div id="pipVideoContainer" class="pip-video-container">
                <video id="localVideoStream" class="pip-video" autoplay playsinline muted></video>
            </div>
            
            <button id="switchCameraBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 8l-4-4H9l-4 4"></path>
                    <path d="M12 16v-8"></path>
                    <path d="M5 16l4 4h6l4-4"></path>
                </svg>
            </button>
            
            <div class="call-footer">
                <div class="call-controls">
                    <button class="control-btn" id="toggleMicBtn" title="Mikrofon Aç/Kapa">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                    <button class="control-btn" id="toggleCameraBtn" title="Kamera Aç/Kapa">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                    <button class="control-btn" id="toggleScreenShareBtn" title="Ekran Paylaş">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                    </button>
                    <button class="control-btn" id="toggleChatBtn" title="Sohbet">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <button class="control-btn end-call" id="endCallBtn" title="Aramayı Sonlandır">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path>
                            <line x1="23" y1="1" x2="1" y2="23"></line>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="chatPanel" class="chat-panel">
                <div class="chat-header">
                    <span>Sohbet</span>
                    <button class="chat-close" id="closeChatBtn">&times;</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Mesajlar buraya eklenecek -->
                </div>
                <div class="chat-input-container">
    <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.txt">
    <button id="fileBtn" class="file-btn" style="margin-right: 5px; background: #6b7280; border: none; width: 35px; height: 35px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">📎</button>
    <input type="text" class="chat-input" id="chatInput" placeholder="Mesajınızı yazın...">
    <button class="send-btn" id="sendMessageBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="settings-modal">
            <div class="settings-header">
                <h3>⚙️ Cihaz Ayarları</h3>
                <button class="settings-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="device-selector">
                <label for="microphoneSelect">🎤 Mikrofon:</label>
                <select id="microphoneSelect"></select>
            </div>
            <div class="device-selector">
                <label for="cameraSelect">📹 Kamera:</label>
                <select id="cameraSelect"></select>
            </div>
            <div class="device-selector">
                <label for="speakerSelect">🔊 Hoparlör:</label>
                <select id="speakerSelect"></select>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="applyDeviceSettings()">Uygula</button>
                <button class="btn btn-secondary" onclick="closeSettingsModal()" style="margin-left: 10px;">İptal</button>
            </div>
        </div>
    </div>

    <div id="creditNotifications" class="notification-container"></div>
    <audio id="remoteAudio" autoplay></audio>
    <audio id="localAudio" muted></audio>
    <audio id="mediaSessionAudio" loop></audio>
    <audio id="cashSound" src="cash.mp3"></audio>

    <div id="profileModal" class="modal-overlay hidden">
        <div class="modal">
            <button class="modal-close" onclick="closeProfileModal()">×</button>
            <div id="profileModalContent"></div>
        </div>
    </div>
    
    <div id="callSummaryModal" class="modal-overlay hidden">
        <div class="modal">
            <div id="callSummaryModalContent">
                <div style="text-align: center;">
                    <h3 style="color: #16a34a;">✅ Görüşme Sonlandırıldı</h3>
                    <p style="margin-top: 20px; font-size: 16px;">
                        Görüşme süresi: <strong id="summaryDuration">00:00</strong>
                    </p>
                    <p style="font-size: 16px; margin-top: 10px;">
                        Kazanılan kredi: <strong style="color: #f59e0b;" id="summaryCredits">0 Kredi</strong>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeCallSummaryModal()">Kapat</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global değişkenler
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let localVideoStream = null;
        let screenStream = null;
        let currentCall = null;
        let callTimer = null;
        let callDuration = 0;
        let callStartTime = null;

        let connectedUsers = [];
        let onlineUsers = [];
        let filteredUsers = [];
        let outgoingCallInfo = null;
        let incomingCallInfo = null;

        let isLoggedIn = false;
        let currentAdmin = null;
        let adminUniqueId = null;
        let myCallbacks = [];
        let pendingIceCandidates = [];

        // Video arama değişkenleri
        let isMicMuted = false;
        let isCameraOn = false;
        let isSharingScreen = false;
        let isChatOpen = false;
        let isVideoCall = false;
        let currentCameraFacing = 'user';

        // Cihaz değişkenleri
        let availableMicrophones = [];
        let availableCameras = [];
        let availableSpeakers = [];
        let selectedMicrophoneId = '';
        let selectedCameraId = '';
        let selectedSpeakerId = '';

        let micEnabled = true;
        let speakerEnabled = true;
        let noiseSuppression = false;
        let callState = 'idle';
        let isInitializing = false;
        let isMediaAudioUnlocked = false;

        const serverUrl = window.location.hostname === 'localhost' ?
            'ws://localhost:8080' : `wss://${window.location.host}`;
        const rtcConfig = {
            iceServers: [
                {
                    urls: "stun:stun.relay.metered.ca:80",
                },
                {
                    urls: "turn:global.relay.metered.ca:80",
                    username: "2cd6997bdf9666187e5c41e1",
                    credential: "vjN0huj/wkeKHu8f",
                },
                {
                    urls: "turn:global.relay.metered.ca:80?transport=tcp",
                    username: "2cd6997bdf9666187e5c41e1",
                    credential: "vjN0huj/wkeKHu8f",
                },
                {
                    urls: "turn:global.relay.metered.ca:443",
                    username: "2cd6997bdf9666187e5c41e1",
                    credential: "vjN0huj/wkeKHu8f",
                },
                {
                    urls: "turns:global.relay.metered.ca:443?transport=tcp",
                    username: "2cd6997bdf9666187e5c41e1",
                    credential: "vjN0huj/wkeKHu8f",
                },
            ],
        };
        const baseUrl = '';

        const cashSound = new Audio('cash.mp3');

        // Sayfa yüklendiğinde
        window.onload = function() {
            console.log('🎯 VIPCEP Admin Panel başlatılıyor...');
            if (isInitializing) return;
            isInitializing = true;
            
            setupEventListeners();
            checkAuthStatus();
            loadAvailableDevices();
        };
		// Event Listener Setup
		function setupEventListeners() {
		    // Duplikasyon önleme - sadece bir kez çalıştır
		    if (window.adminEventListenersAdded) return;
		    window.adminEventListenersAdded = true;
		
		    const volumeSlider = document.getElementById('volumeSlider');
		    if (volumeSlider) {
		        volumeSlider.addEventListener('input', (e) => {
		            const volume = e.target.value;
		            document.getElementById('volumeValue').textContent = volume + '%';
		            
		            const remoteAudio = document.getElementById('remoteAudio');
		            if (speakerEnabled && remoteAudio) {
		                remoteAudio.volume = volume / 100;
		            }
		        });
		    }
		
		    // Video arama kontrolleri
		    document.getElementById('toggleMicBtn')?.addEventListener('click', toggleVideoMicrophone);
		    document.getElementById('toggleCameraBtn')?.addEventListener('click', toggleVideoCamera);
		    document.getElementById('toggleScreenShareBtn')?.addEventListener('click', toggleScreenShare);
		    document.getElementById('toggleChatBtn')?.addEventListener('click', toggleChat);
		    document.getElementById('endCallBtn')?.addEventListener('click', () => endVideoCall());
		    document.getElementById('switchCameraBtn')?.addEventListener('click', switchCamera);
		    document.getElementById('closeChatBtn')?.addEventListener('click', toggleChat);
		
		    // Dosya transfer butonları
		    document.getElementById('fileBtn')?.addEventListener('click', () => {
		        document.getElementById('fileInput').click();
		    });
		    
		    document.getElementById('fileInput')?.addEventListener('change', handleFileSelection);
		    
		    // Sohbet mesaj gönderme
		    document.getElementById('sendMessageBtn')?.addEventListener('click', sendChatMessage);
		    document.getElementById('chatInput')?.addEventListener('keyup', function(e) {
		        if (e.key === 'Enter') {
		            sendChatMessage();
		        }
		    });
		
		    // Klavye kısayolları
		    document.addEventListener('keydown', (e) => {
		        if (e.ctrlKey || e.metaKey) {
		            switch (e.key) {
		                case 'r': e.preventDefault(); refreshData(); break;
		                case 'e': e.preventDefault(); if (currentCall) endCall(); break;
		                case 'm': e.preventDefault(); if (currentCall) muteCall(); break;
		            }
		        }
		        
		        if (e.key === 'Escape') {
		            if (outgoingCallInfo) cancelOutgoingCall();
		            else if (incomingCallInfo) rejectIncomingCall();
		            else if (currentCall && confirm('Görüşmeyi sonlandırmak istiyor musunuz?')) endCall();
		            
		            if (!document.getElementById('profileModal').classList.contains('hidden')) {
		                closeProfileModal();
		            }
		            if (!document.getElementById('settingsModal').classList.contains('hidden')) {
		                closeSettingsModal();
		            }
		        }
		    });
		    
		    // Medya ses kilidi açma
		    document.body.addEventListener('click', () => {
		        if (!isMediaAudioUnlocked) {
		            const mediaAudio = document.getElementById('mediaSessionAudio');
		            if (mediaAudio) {
		                mediaAudio.play().then(() => {
		                    mediaAudio.pause();
		                    isMediaAudioUnlocked = true;
		                    console.log('Medya oturumu için ses kilidi kullanıcı etkileşimiyle açıldı.');
		                }).catch(e => {
		                   console.warn('Ses kilidi açılamadı, tarayıcı engelliyor olabilir.', e);
		                });
		            }
		        }
		    }, { once: true });
		
		    // Modal event listener'ları
		    document.getElementById('profileModal')?.addEventListener('click', (e) => {
		        if (e.target.id === 'profileModal') {
		            closeProfileModal();
		        }
		    });
		
		    document.getElementById('settingsModal')?.addEventListener('click', (e) => {
		        if (e.target.id === 'settingsModal') {
		            closeSettingsModal();
		        }
		    });
		}
		async function toggleScreenShare() {
		    const screenShareBtn = document.getElementById('toggleScreenShareBtn');
		    const screenshareContainer = document.getElementById('screenshareContainer');
		    
		    if (isSharingScreen) {
		        // Ekran paylaşımını durdur
		        if (screenStream) {
		            screenStream.getTracks().forEach(track => track.stop());
		            screenStream = null;
		        }
		        
		        screenshareContainer?.classList.remove('active');
		        screenShareBtn?.classList.remove('active');
		        isSharingScreen = false;
		        
		        // PeerConnection'da video track'i eski haline döndür
		        if (peerConnection && localVideoStream && isCameraOn) {
		            const senders = peerConnection.getSenders();
		            const videoSender = senders.find(s => s.track && s.track.kind === 'video');
		            if (videoSender) {
		                await videoSender.replaceTrack(localVideoStream.getVideoTracks()[0]);
		            }
		        }
		        
		        showNotification("Ekran paylaşımı durduruldu", "info");
		        
		        // Sunucuya bildirim gönder
		        if (socket && socket.readyState === WebSocket.OPEN && currentCall) {
		            socket.send(JSON.stringify({
		                type: 'screen-sharing-stopped',
		                adminId: adminUniqueId,
		                targetId: currentCall.userId
		            }));
		        }
		        
		    } else {
		        // Ekran paylaşımını başlat
		        try {
		            screenStream = await navigator.mediaDevices.getDisplayMedia({
		                video: {
		                    displaySurface: "screen"
		                },
		                audio: false
		            });
		            
		            const screenVideo = document.getElementById('screenshareVideo');
		            if (screenVideo) {
		                screenVideo.srcObject = screenStream;
		            }
		            
		            screenshareContainer?.classList.add('active');
		            
		            // PeerConnection'da video track'i değiştir
		            if (peerConnection) {
		                const videoTrack = screenStream.getVideoTracks()[0];
		                const senders = peerConnection.getSenders();
		                const videoSender = senders.find(s => s.track && s.track.kind === 'video');
		                
		                if (videoSender) {
		                    await videoSender.replaceTrack(videoTrack);
		                } else {
		                    peerConnection.addTrack(videoTrack, screenStream);
		                }
		            }
		            
		            // Ekran paylaşımı bittiğinde otomatik durdur
		            screenStream.getVideoTracks()[0].addEventListener('ended', () => {
		                toggleScreenShare();
		            });
		            
		            screenShareBtn?.classList.add('active');
		            isSharingScreen = true;
		            
		            showNotification("Ekran paylaşımı başlatıldı", "success");
		            
		            // Sunucuya bildirim gönder
		            if (socket && socket.readyState === WebSocket.OPEN && currentCall) {
		                socket.send(JSON.stringify({
		                    type: 'screen-sharing-started',
		                    adminId: adminUniqueId,
		                    targetId: currentCall.userId
		                }));
		            }
		            
		        } catch (error) {
		            if (error.name === 'NotAllowedError') {
		                showNotification("Ekran paylaşımı izni reddedildi", "error");
		            } else if (error.name === 'AbortError') {
		                showNotification("Ekran paylaşımı iptal edildi", "info");
		            } else {
		                showNotification("Ekran paylaşımı başlatılamadı: " + error.message, "error");
		            }
		            console.error("Ekran paylaşımı hatası:", error);
		        }
		    }
		}
        // Cihaz Yönetimi
		async function loadAvailableDevices() {
			try {
				const devices = await navigator.mediaDevices.enumerateDevices();
				
				availableMicrophones = devices.filter(device => device.kind === 'audioinput');
				availableCameras = devices.filter(device => device.kind === 'videoinput');
				availableSpeakers = devices.filter(device => device.kind === 'audiooutput');

				// Varsayılan cihazları seç
				if (availableMicrophones.length > 0) {
					selectedMicrophoneId = availableMicrophones[0].deviceId;
				}
				if (availableCameras.length > 0) {
					selectedCameraId = availableCameras[0].deviceId;
				}
				if (availableSpeakers.length > 0) {
					selectedSpeakerId = availableSpeakers[0].deviceId;
				}

				updateDeviceSelectors();
				console.log('📱 Cihazlar yüklendi:', {
					microphones: availableMicrophones.length,
					cameras: availableCameras.length,
					speakers: availableSpeakers.length
				});
			} catch (error) {
				console.error('❌ Cihaz listeleme hatası:', error);
			}
		}

        function updateDeviceSelectors() {
            const micSelect = document.getElementById('microphoneSelect');
            const camSelect = document.getElementById('cameraSelect');
            const speakerSelect = document.getElementById('speakerSelect');

            if (micSelect) {
                micSelect.innerHTML = availableMicrophones.map(device => 
                    `<option value="${device.deviceId}" ${device.deviceId === selectedMicrophoneId ? 'selected' : ''}>
                        ${device.label || `Mikrofon ${device.deviceId.slice(0, 8)}`}
                    </option>`
                ).join('');
            }

            if (camSelect) {
                camSelect.innerHTML = availableCameras.map(device => 
                    `<option value="${device.deviceId}" ${device.deviceId === selectedCameraId ? 'selected' : ''}>
                        ${device.label || `Kamera ${device.deviceId.slice(0, 8)}`}
                    </option>`
                ).join('');
            }

            if (speakerSelect) {
                speakerSelect.innerHTML = availableSpeakers.map(device => 
                    `<option value="${device.deviceId}" ${device.deviceId === selectedSpeakerId ? 'selected' : ''}>
                        ${device.label || `Hoparlör ${device.deviceId.slice(0, 8)}`}
                    </option>`
                ).join('');
            }
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            updateDeviceSelectors();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function applyDeviceSettings() {
            const micSelect = document.getElementById('microphoneSelect');
            const camSelect = document.getElementById('cameraSelect');
            const speakerSelect = document.getElementById('speakerSelect');

            if (micSelect) selectedMicrophoneId = micSelect.value;
            if (camSelect) selectedCameraId = camSelect.value;
            if (speakerSelect) selectedSpeakerId = speakerSelect.value;

            showNotification('Cihaz ayarları güncellendi!', 'success', 2000);
            closeSettingsModal();

        }
        
        // Kimlik Kontrolü Fonksiyonu
        async function checkAuthStatus() {
            try {
                console.log('🔐 Oturum kontrol ediliyor...');
                const response = await fetch(`${baseUrl}/auth/check-session`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated && ['normal', 'super'].includes(data.role)) {
                        loginSuccess(data);
                        return;
                    }
                }
                console.log('❌ Yetkisiz erişim, giriş sayfasına yönlendiriliyor...');
                window.location.href = baseUrl + '/';
            } catch (error) {
                console.error('❌ Auth kontrol hatası:', error);
                window.location.href = baseUrl + '/';
            }
        }

        function loginSuccess(adminData) {
            console.log('✅ Giriş başarılı:', adminData.username);
            isLoggedIn = true;
            currentAdmin = adminData;
            document.getElementById('adminName').textContent = adminData.username || 'Admin';
            document.getElementById('adminRole').textContent = 
                adminData.role === 'super' ? '🔴 Süper Admin' : '🟡 Normal Admin';
            updateAdminStatus('available');
            connectToServer();
            loadMyEarnings(); 
        }

        async function performLogout() {
            if (!confirm('Çıkış yapmak istediğinizden emin misiniz?')) return;
            console.log('👋 Çıkış yapılıyor...');
            if (currentCall) endCall();
            if (isVideoCall) endVideoCall();
            try { 
                await fetch(`${baseUrl}/auth/logout`, { method: 'POST' }); 
            } catch (error) {
                console.error('Logout hatası:', error);
            }
            if (socket) {
                socket.close();
                socket = null;
            }
            window.location.href = baseUrl + '/';
        }

        function connectToServer() {
            if (!isLoggedIn) {
                console.log('❌ Giriş yapmadan sunucuya bağlanılamaz');
                return;
            }
            
            console.log('🔗 Sunucuya bağlanılıyor...');
            updateConnectionStatus('connecting');
            
            try {
                socket = new WebSocket(serverUrl);
                
                socket.onopen = () => {
                    console.log('✅ WebSocket bağlandı');
                    updateConnectionStatus('connected');
                    registerAdmin();
                };
                
                socket.onclose = () => { 
                    console.log('❌ WebSocket bağlantı kesildi');
                    updateConnectionStatus('disconnected'); 
                    
                    if (isLoggedIn && !isInitializing) {
                        console.log('🔄 3 saniye sonra yeniden bağlanılacak...');
                        setTimeout(connectToServer, 3000); 
                    }
                };
                
                socket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleServerMessage(message);
                    } catch (error) {
                        console.error('❌ Mesaj parse hatası:', error);
                    }
                };
                
                socket.onerror = (error) => {
                    console.error('❌ WebSocket hatası:', error);
                    updateConnectionStatus('error');
                };
                
            } catch (error) { 
                console.error('❌ WebSocket oluşturma hatası:', error);
                updateConnectionStatus('error'); 
            }
        }

        function registerAdmin() {
            if (socket && socket.readyState === WebSocket.OPEN && currentAdmin) {
                const registerMessage = { 
                    type: 'register', 
                    userId: currentAdmin.username, 
                    name: currentAdmin.username || 'Admin', 
                    userType: 'admin' 
                };
                socket.send(JSON.stringify(registerMessage));
                console.log('📝 Admin kaydedildi:', registerMessage);
            }
        }

        function updateConnectionStatus(status) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            if (!statusDot || !statusText) return;
            switch (status) {
                case 'connected':
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Bağlı';
                    updateAdminStatus('available');
                    break;
                case 'connecting':
                    statusDot.className = 'status-dot busy';
                    statusText.textContent = 'Bağlanıyor...';
                    break;
                case 'disconnected':
                case 'error':
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Bağlantı Yok';
                    updateAdminStatus('offline');
                    break;
            }
        }

        function updateAdminStatus(status) {
            const statusElement = document.getElementById('adminStatus');
            if (!statusElement) return;
            const dot = statusElement.querySelector('.admin-status-dot');
            const text = statusElement.querySelector('span');
            if (!dot || !text) return;
            switch (status) {
                case 'available': statusElement.className = 'admin-status available'; text.textContent = 'Müsait'; callState = 'idle'; break;
                case 'busy': statusElement.className = 'admin-status busy'; text.textContent = 'Meşgul'; break;
                case 'offline': statusElement.className = 'admin-status offline'; text.textContent = 'Çevrimdışı'; break;
            }
            console.log('📊 Admin durumu güncellendi:', status);
        }

        // Video Arama Yöneticisi
        function switchToVideoCall() {
            if (!currentCall) return;
            
            isVideoCall = true;
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('currentCustomerName').textContent = `${currentCall.userName} ile Video Görüşme`;
            
            // Ses görüşmesini video görüşmesine geçir
            initializeVideoCall();
            showNotification('Video görüşmesine geçildi', 'success', 2000);
        }

        async function initializeVideoCall() {
            try {
                // Mikrofon izni al (zaten varsa kullan)
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            deviceId: selectedMicrophoneId ? { exact: selectedMicrophoneId } : undefined,
                            echoCancellation: true, 
                            noiseSuppression: true 
                        } 
                    });
                }

                // Video timer'ı başlat
                startVideoCallTimer();
                
            } catch (error) {
                console.error('❌ Video görüşme başlatma hatası:', error);
                showNotification('Video görüşme başlatılamadı', 'error');
            }
        }

        function startVideoCallTimer() {
            const timerEl = document.getElementById('callTimerOverlay');
            if (!timerEl) return;

            const updateTimer = () => {
                if (callStartTime) {
                    const duration = Math.floor((Date.now() - callStartTime) / 1000);
                    const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                    const seconds = (duration % 60).toString().padStart(2, '0');
                    timerEl.textContent = `${minutes}:${seconds}`;
                }
            };

            updateTimer();
            if (callTimer) clearInterval(callTimer);
            callTimer = setInterval(updateTimer, 1000);
        }
		// Video Arama Kontrolleri
        async function toggleVideoMicrophone() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            if (!audioTrack) return;
            
            isMicMuted = !isMicMuted;
            audioTrack.enabled = !isMicMuted;
            
            const micBtn = document.getElementById('toggleMicBtn');
            if (micBtn) {
                micBtn.classList.toggle('active', !isMicMuted);
                
                if (isMicMuted) {
                    micBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                            <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                            <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    `;
                } else {
                    micBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    `;
                }
            }
            
            showNotification(isMicMuted ? "Mikrofon kapatıldı" : "Mikrofon açıldı", "info", 1500);
        }

		async function toggleVideoCamera() {
		    const cameraBtn = document.getElementById('toggleCameraBtn');
		    const localVideo = document.getElementById('localVideoStream');
		    const pipContainer = document.getElementById('pipVideoContainer');
		    
		    if (isCameraOn) {
		        // Kamerayı kapat
		        if (localVideoStream) {
		            localVideoStream.getTracks().forEach(track => track.stop());
		            localVideoStream = null;
		        }
		        
		        if (localVideo) localVideo.srcObject = null;
		        pipContainer.classList.remove('active');
		        
		        // PeerConnection'dan video track'i kaldır (replaceTrack ile)
		        if (peerConnection) {
		            const senders = peerConnection.getSenders();
		            const videoSender = senders.find(s => s.track && s.track.kind === 'video');
		            if (videoSender) {
		                await videoSender.replaceTrack(null);
		            }
		        }
		        
		        isCameraOn = false;
		        cameraBtn.classList.remove('active');
		        showNotification("Kamera kapatıldı", "info", 1500);
		    } else {
		        try {
		            // Kamerayı aç
		            localVideoStream = await navigator.mediaDevices.getUserMedia({
		                video: { 
		                    deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined,
		                    facingMode: currentCameraFacing,
		                    width: { ideal: 1280 },
		                    height: { ideal: 720 }
		                }
		            });
		            
		            localVideo.srcObject = localVideoStream;
		            pipContainer.classList.add('active');
		            
		            // PeerConnection'a video track ekle veya değiştir
		            if (peerConnection) {
		                const senders = peerConnection.getSenders();
		                const videoSender = senders.find(s => s.track === null || (s.track && s.track.kind === 'video'));
		                
		                if (videoSender) {
		                    await videoSender.replaceTrack(localVideoStream.getVideoTracks()[0]);
		                } else {
		                    peerConnection.addTrack(localVideoStream.getVideoTracks()[0], localVideoStream);
		                }
		            }
		            
		            isCameraOn = true;
		            cameraBtn.classList.add('active');
		            showNotification("Kamera açıldı", "success", 1500);
		        } catch (error) {
		            console.error("Kamera açma hatası:", error);
		            showNotification("Kamera açılamadı", "error");
		        }
		    }
		}
        async function switchCamera() {
            if (!isCameraOn) {
                currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
                return;
            }
            
            try {
                if (localVideoStream) {
                    localVideoStream.getTracks().forEach(track => track.stop());
                }
                
                currentCameraFacing = currentCameraFacing === 'user' ? 'environment' : 'user';
                
                localVideoStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined,
                        facingMode: currentCameraFacing 
                    }
                });
                
                const localVideo = document.getElementById('localVideoStream');
                localVideo.srcObject = localVideoStream;
                
                if (peerConnection) {
                    const senders = peerConnection.getSenders();
                    senders.forEach(sender => {
                        if (sender.track && sender.track.kind === 'video') {
                            peerConnection.removeTrack(sender);
                        }
                    });
                    
                    localVideoStream.getVideoTracks().forEach(track => {
                        peerConnection.addTrack(track, localVideoStream);
                    });
                }
                
                showNotification(`${currentCameraFacing === 'user' ? 'Ön' : 'Arka'} kamera aktif`, "info", 1500);
            } catch (error) {
                console.error("Kamera değiştirme hatası:", error);
                showNotification("Kamera değiştirilemedi", "error");
            }
        }

		async function toggleScreenShare() {
		    console.log('toggleScreenShare çağrıldı');
		    
		    // Basit browser desteği kontrolü
		    if (!navigator.mediaDevices) {
		        alert('navigator.mediaDevices yok');
		        return;
		    }
		    
		    if (!navigator.mediaDevices.getDisplayMedia) {
		        alert('getDisplayMedia desteklenmiyor');
		        return;
		    }
		    
		    alert('API desteği var, ekran paylaşımı başlatılıyor...');
		    
		    try {
		        const stream = await navigator.mediaDevices.getDisplayMedia({
		            video: true
		        });
		        
		        alert('Başarılı! Stream alındı');
		        console.log('Stream:', stream);
		        
		        // Stream'i durdur (test için)
		        stream.getTracks().forEach(track => track.stop());
		        
		    } catch (error) {
		        alert('Hata: ' + error.name + ' - ' + error.message);
		        console.error('Detay:', error);
		    }
		}
		function toggleChat() {
			const chatPanel = document.getElementById('chatPanel');
			const chatBtn = document.getElementById('toggleChatBtn');
			
			if (!chatPanel || !chatBtn) {
				console.error('Chat panel elementleri bulunamadı');
				return;
			}
			
			isChatOpen = !isChatOpen;
			
			if (isChatOpen) {
				chatPanel.classList.add('active');
				chatBtn.classList.add('active');
				console.log('Chat paneli açıldı');
			} else {
				chatPanel.classList.remove('active');
				chatBtn.classList.remove('active');
				console.log('Chat paneli kapatıldı');
			}
		}

		function sendChatMessage() {
		    const input = document.getElementById('chatInput');
		    if (!input || !input.value.trim()) return;
		    
		    const message = input.value.trim();
		    input.value = '';
		    
		    addChatMessage(currentAdmin.username, message, true);
		    
		    if (socket && socket.readyState === WebSocket.OPEN && currentCall) {
		        socket.send(JSON.stringify({
		            type: 'chat-message',
		            from: currentAdmin.username,
		            text: message,
		            targetId: currentCall.userId,
		            adminId: adminUniqueId,
		            targetType: 'customer'
		        }));
		    }
		}

        function addChatMessage(from, text, isSent) {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
            messageEl.innerHTML = `
                ${!isSent ? `<div style="font-weight: 600; margin-bottom: 3px;">${from}</div>` : ''}
                <div>${text}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function endVideoCall() {
            console.log('📞 Video görüşme sonlandırılıyor...');
            
            // Video overlay'ı gizle
            document.getElementById('callOverlay').classList.add('hidden');
            
            // Video öğelerini temizle
            cleanupVideoCall();
            
            // Normal ses görüşmesine geri dön veya tamamen bitir
            if (currentCall) {
                endCall();
            }
            
            isVideoCall = false;
        }

        function cleanupVideoCall() {
            // Video stream'leri durdur
            if (localVideoStream) {
                localVideoStream.getTracks().forEach(track => track.stop());
                localVideoStream = null;
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            // Video elementlerini temizle
            const localVideo = document.getElementById('localVideoStream');
            const remoteVideo = document.getElementById('remoteVideoStream');
            const screenshareVideo = document.getElementById('screenshareVideo');
            
            if (localVideo) localVideo.srcObject = null;
            if (remoteVideo) remoteVideo.srcObject = null;
            if (screenshareVideo) screenshareVideo.srcObject = null;
            
            // Konteynerları gizle
            document.getElementById('screenshareContainer').classList.remove('active');
            document.getElementById('pipVideoContainer').classList.remove('active');
            
            // Chat'i kapat
            if (isChatOpen) toggleChat();
            
            // Değişkenleri sıfırla
            isCameraOn = false;
            isSharingScreen = false;
            isMicMuted = false;
            
            // Chat mesajlarını temizle
            document.getElementById('chatMessages').innerHTML = '';
            
            console.log('🧹 Video görüşme temizlendi');
        }

        // Normal Arama Yönetimi
        function handleServerMessage(message) {
            console.log('📨 Sunucu mesajı:', message.type);
            switch (message.type) {
                case 'admin-registered':
                    adminUniqueId = message.uniqueId;
                    console.log('✅ Admin kaydı tamamlandı:', adminUniqueId);
                    loadInitialData();
                    break;
                case 'user-list-update':
                    handleUserListUpdate(message.users || []);
                    break;
                case 'callback-list-update':
                    updateCallbacks(message.callbacks || []);
                    break;
                case 'admin-earning-update':
                    updateMyEarningsDisplay(message.newEarnings);
                    if (message.sourceInfo && message.sourceInfo.source === 'tip') {
                        showTipNotification(message.sourceInfo);
                    }
                    break;
                case 'admin-call-request':
                    console.log('📞 Gelen arama:', message.userName, '(' + message.userId + ')');
                    if (currentCall || outgoingCallInfo || callState !== 'idle') {
                        console.log('⚠️ Meşgul durumda, arama reddediliyor');
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({ type: 'reject-incoming-call', adminId: adminUniqueId || currentAdmin.username, reason: 'Admin meşgul' }));
                        }
                        return;
                    }
                    incomingCallInfo = { userId: message.userId, userName: message.userName };
                    callState = 'incoming';
                    const incomingNameEl = document.getElementById('incomingName');
                    const incomingIdEl = document.getElementById('incomingId');
                    const incomingCallEl = document.getElementById('incomingCall');
                    if (incomingNameEl) incomingNameEl.textContent = message.userName;
                    if (incomingIdEl) incomingIdEl.textContent = message.userId;
                    if (incomingCallEl) incomingCallEl.classList.remove('hidden');
                    updateAdminStatus('busy');
                    playRingTone();
                    console.log('📱 Gelen arama UI gösterildi, kullanıcı kararını bekliyor');
                    break;
                case 'call-connecting': handleCallConnecting(message); break;
                case 'call-accepted': 
                    if(callState === 'outgoing') handleCallAccepted(message);
                    else console.log('⚠️ Call-accepted mesajı beklenmeyen bir durumda geldi.');
                    break;
                case 'call-rejected': 
                    if(callState === 'outgoing' || callState === 'incoming') handleCallRejected(message);
                    else console.log('⚠️ Call-rejected mesajı beklenmeyen bir durumda geldi.');
                    break;
                case 'call-failed': 
                    showNotification(message.reason || 'Arama başarısız oldu!', 'error');
                    resetCallState();
                    break;
                case 'call-ended': handleCallEnded(message); break;
                case 'offer': case 'answer': case 'ice-candidate': handleWebRTCMessage(message); break;
				case 'chat-message':
				    if (currentCall && isVideoCall) {
				        addChatMessage(message.from, message.text, false);
				        
				        // Chat paneli kapalıysa otomatik aç
				        if (!isChatOpen) {
				            toggleChat();
				            // Bildirim sesi çal
				            const notificationSound = new Audio('notification.mp3');
				            notificationSound.play().catch(e => console.warn("Ses çalınamadı", e));
				        }
				        
				        showNotification(`${message.from}: ${message.text}`, 'info');
				    }
				    break;
				case 'file-transfer-request':
				    handleIncomingFileRequest(message);
				    break;
				
				case 'file-chunk':
				    handleIncomingFileChunk(message);
				    break;
                case 'auto-credit-update':
                    break;
                default: console.log('❓ Bilinmeyen mesaj tipi:', message.type); break;
            }
        }
		function handleUserListUpdate(users) {
            console.log('👥 Kullanıcı listesi güncellendi:', users.length, 'kullanıcı');
            connectedUsers = users || [];
            if (!isInitializing) {
                loadOnlineUsers();
                renderConnectedUsers();
            }
        }

        function loadInitialData() {
            console.log('📊 İlk veri yükleme başlatılıyor...');
            isInitializing = false;
        }

        function updateCallbacks(callbacks) {
            console.log('📝 Callback listesi güncellendi:', callbacks.length);
            myCallbacks = callbacks || [];
            const counterElement = document.getElementById('callbackCounter');
            if (counterElement) counterElement.textContent = myCallbacks.length;
            renderCallbacks();
        }

        function renderCallbacks() {
            const list = document.getElementById('callbackList');
            if (!list) return;
            if (myCallbacks.length === 0) {
                list.innerHTML = `<div class="callback-empty"><div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">📝</div><div>Henüz geri dönüş bekleyen yok</div></div>`;
                return;
            }
            list.innerHTML = myCallbacks.map(callback => {
                const waitTime = Date.now() - callback.timestamp;
                const minutes = Math.floor(waitTime / 60000);
                return `<div class="callback-item"><div class="callback-info"><div class="callback-name">${callback.customerName}</div><div class="callback-details"><span>ID: ${callback.customerId}</span><span>⏰ ${minutes} dk önce</span></div></div><div class="callback-actions"><button class="btn btn-call btn-small" onclick="callCustomer('${callback.customerId}', '${callback.customerName}')">📞 Ara</button><button class="btn btn-delete btn-small" onclick="removeCallback('${callback.customerId}')">🗑️</button></div></div>`;
            }).join('');
        }

        function removeCallback(customerId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'remove-callback', customerId: customerId }));
                console.log('🗑️ Callback silindi:', customerId);
            }
        }

        function callCustomer(customerId, customerName) {
            if (currentCall || outgoingCallInfo || callState !== 'idle') {
                showNotification('Zaten bir aramada bulunuyorsunuz!', 'warning');
                return;
            }
            console.log('📞 Müşteri aranıyor:', customerName, '(' + customerId + ')');
            outgoingCallInfo = { userId: customerId, userName: customerName };
            currentCall = { userId: customerId, userName: customerName };
            callState = 'outgoing';
            const outgoingNameEl = document.getElementById('outgoingName');
            const outgoingIdEl = document.getElementById('outgoingId');
            const outgoingCallEl = document.getElementById('outgoingCall');
            if (outgoingNameEl) outgoingNameEl.textContent = customerName;
            if (outgoingIdEl) outgoingIdEl.textContent = customerId;
            if (outgoingCallEl) outgoingCallEl.classList.remove('hidden');
            updateAdminStatus('busy');
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'admin-call-customer', targetCustomerId: customerId, adminName: currentAdmin.username || 'Admin' }));
            }
        }

        function cancelOutgoingCall() {
            if (!outgoingCallInfo) return;
            console.log('❌ Giden arama iptal edildi:', outgoingCallInfo.userName);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'end-call', targetId: outgoingCallInfo.userId, userId: adminUniqueId || currentAdmin.username, userType: 'admin', endedBy: 'admin', reason: 'cancelled' }));
            }
            resetCallState();
        }

		async function acceptIncomingCall() {
		    if (!incomingCallInfo) return;
		    console.log('✅ Gelen arama kabul edildi:', incomingCallInfo.userName);
		    
		    const incomingCallEl = document.getElementById('incomingCall');
		    if (incomingCallEl) incomingCallEl.classList.add('hidden');
		    
		    if (socket && socket.readyState === WebSocket.OPEN) {
		        socket.send(JSON.stringify({ 
		            type: 'accept-incoming-call', 
		            adminId: adminUniqueId || currentAdmin.username, 
		            userId: incomingCallInfo.userId 
		        }));
		    }
		    
		    currentCall = incomingCallInfo;
		    incomingCallInfo = null;
		    callState = 'connected'; // *** connecting değil connected yap ***
		    updateAdminStatus('busy');
		    
		    // *** VIDEO OVERLAY'I AÇ ***
		    isVideoCall = true;
		    document.getElementById('callOverlay').classList.remove('hidden');
		    document.getElementById('currentCustomerName').textContent = `${currentCall.userName} ile Video Görüşme`;
		    
		    // WebRTC bağlantısını kur
		    await setupPeerConnection(currentCall, false);
		    
		    console.log('🔗 Admin kabul etti, video overlay açık kalmalı');
		}

        function rejectIncomingCall() {
            if (!incomingCallInfo) return;
            console.log('❌ Gelen arama reddedildi:', incomingCallInfo.userName);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'reject-incoming-call', adminId: adminUniqueId || currentAdmin.username, reason: 'Admin tarafından reddedildi' }));
            }
            resetCallState();
        }

        function handleCallConnecting(message) {
            console.log('🔗 Arama bağlanıyor...');
            showNotification('Arama bağlanıyor...', 'info', 3000);
        }

		function handleCallAccepted(message) {
		    console.log('Müşteri aramayı kabul etti:', message.customerName || message.customerId);
		    if (callState === 'outgoing') {
		        const callInfo = { userId: currentCall.userId, userName: currentCall.userName };
		        currentCall = callInfo;
		        outgoingCallInfo = null;
		        
		        // *** OTOMATIK VIDEO EKRANINA GEÇ ***
		        isVideoCall = true;
		        document.getElementById('callOverlay').classList.remove('hidden');
		        document.getElementById('currentCustomerName').textContent = `${callInfo.userName} ile Video Görüşme`;
		        
		        setupPeerConnection(callInfo, true);
		    }
		}

        function handleCallRejected(message) {
            console.log('❌ Arama reddedildi:', message.reason);
            showNotification(message.reason || 'Arama reddedildi', 'warning');
            resetCallState();
        }

		function handleCallEnded(message) {
		    console.log('Arama sonlandı:', message.reason);
		    if (currentCall) showNotification('Görüşme sonlandırıldı', 'info');
		    
		    // Video overlay'ı kapat
		    if (isVideoCall) {
		        document.getElementById('callOverlay').classList.add('hidden');
		        isVideoCall = false;
		    }
		    
		    if (message.reason !== 'cancelled' && message.reason !== 'rejected' && message.reason !== 'ended_before_start') {
		        showCallSummaryModal(message.duration, message.creditsUsed);
		    }
		
		    cleanupCall();
		    resetCallState();
		}

        function showCallSummaryModal(durationInSeconds, creditsUsed) {
            const minutes = Math.floor(durationInSeconds / 60);
            const seconds = durationInSeconds % 60;
            const formattedDuration = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('summaryDuration').textContent = formattedDuration;
            document.getElementById('summaryCredits').textContent = `${creditsUsed} Kredi`;
            
            const cashSound = new Audio('cash.mp3');
            cashSound.play().catch(e => console.error("Cash sound play failed", e));
            document.getElementById('callSummaryModal').classList.remove('hidden');
        }

        function closeCallSummaryModal() {
            document.getElementById('callSummaryModal').classList.add('hidden');
        }

        function endCall() {
            if (!currentCall) return;
            console.log('📞 Görüşme sonlandırılıyor:', currentCall.userName);
            const duration = callDuration;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ 
                    type: 'end-call', 
                    userId: adminUniqueId, 
                    targetId: currentCall.userId, 
                    duration: duration, 
                    userType: 'admin', 
                    endedBy: 'admin', 
                    reason: 'normal' 
                }));
            }
            cleanupCall();
            resetCallState();
        }

        function resetCallState() {
            const callCards = document.querySelectorAll('.call-status-card');
            callCards.forEach(card => card.classList.add('hidden'));

            const tempCard = document.getElementById('tempConnectingCard');
            if (tempCard) tempCard.remove();

            currentCall = null;
            outgoingCallInfo = null;
            incomingCallInfo = null;
            callState = 'idle';
            updateAdminStatus('available');
            console.log('🔄 Call state sıfırlandı');
        }

        async function setupPeerConnection(callInfo, isInitiator) {
            if (peerConnection) {
                console.log('⚠️ Mevcut PeerConnection temizleniyor...');
                cleanupCall();
            }
            try {
                console.log(`🔗 Admin WebRTC bağlantısı kuruluyor... Başlatan: ${isInitiator}`);
                updateAdminStatus('busy');
                
                peerConnection = new RTCPeerConnection(rtcConfig);
                pendingIceCandidates = [];

                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        deviceId: selectedMicrophoneId ? { exact: selectedMicrophoneId } : undefined,
                        echoCancellation: true, 
                        noiseSuppression: true 
                    } 
                });
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                if (localVideoStream) {
					localVideoStream.getVideoTracks().forEach(track => {
						peerConnection.addTrack(track, localVideoStream);
					});
				}
                peerConnection.ontrack = (event) => { 
                    console.log('🎵 Müşteriden medya akışı alındı');
                    const stream = event.streams[0];
                    
                    // Video track kontrolü
                    const videoTracks = stream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        const remoteVideo = document.getElementById('remoteVideoStream');
                        if (remoteVideo) {
                            remoteVideo.srcObject = stream;
                        }
                    }
                    
                    // Audio track kontrolü
                    const audioTracks = stream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        document.getElementById('remoteAudio').srcObject = stream;
                    }
                };

                peerConnection.onicecandidate = (event) => { 
                    if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate, targetId: callInfo.userId }));
                    }
                };

                peerConnection.onconnectionstatechange = () => {
                    if (!peerConnection) return;
                    const state = peerConnection.connectionState;
                    console.log('🔗 Admin Bağlantı durumu:', state);
                    if (state === 'connected') {
                        document.getElementById('outgoingCall').classList.add('hidden');
                        document.getElementById('incomingCall').classList.add('hidden');
                        document.getElementById('activeCall').classList.remove('hidden');
                        document.getElementById('activeCaller').textContent = callInfo.userName;
                        startTimer();
                    } else if (['failed', 'disconnected', 'closed'].includes(state)) {
                        handleCallEnded({ reason: 'Bağlantı koptu' });
                    }
                };

                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'offer', offer: offer, targetId: callInfo.userId }));
                        console.log('📤 Admin "offer" gönderdi.');
                    }
                }
            } catch (error) {
                console.error('❌ WebRTC kurulum hatası (Admin):', error);
                showNotification('Mikrofon erişimi gerekli veya bir hata oluştu!', 'error');
                endCall();
            }
        }

        async function handleWebRTCMessage(message) {
            try {
                switch (message.type) {
                    case 'offer':
                        console.log('📨 Müşteriden "offer" alındı, cevap hazırlanıyor...');
                        await setupPeerConnection({ userId: message.userId, userName: currentCall?.userName || 'Müşteri' }, false);
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({ type: 'answer', answer: answer, targetId: message.userId }));
                            console.log('📤 Admin "answer" gönderdi.');
                        }
                        processPendingIceCandidates();
                        break;
                    case 'answer':
                        if (peerConnection && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                            processPendingIceCandidates();
                        }
                        break;
                    case 'ice-candidate':
                        if (message.candidate) {
                            if (peerConnection && peerConnection.remoteDescription) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                            } else {
                                pendingIceCandidates.push(message.candidate);
                            }
                        }
                        break;
                }
            } catch (error) {
                console.error('❌ WebRTC Mesaj Hatası (Admin):', error);
            }
        }

        function processPendingIceCandidates() {
            if (!peerConnection || !peerConnection.remoteDescription || pendingIceCandidates.length === 0) {
                return;
            }
            console.log(`🧊 ${pendingIceCandidates.length} bekleyen ICE adayı işleniyor...`);
            pendingIceCandidates.forEach(async (candidate) => {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('❌ Bekleyen ICE adayı eklenirken hata:', error);
                }
            });
            pendingIceCandidates = [];
        }

		function cleanupCall() {
		    console.log('Call cleanup başlatılıyor...');
		    
		    // Video overlay'ı kapat
		    if (isVideoCall) {
		        document.getElementById('callOverlay').classList.add('hidden');
		        isVideoCall = false;
		    }
		    
		    if (callTimer) { clearInterval(callTimer); callTimer = null; }
		    if (peerConnection) { peerConnection.close(); peerConnection = null; }
		    if (localStream) { 
		        localStream.getTracks().forEach(track => {
		            track.stop();
		            console.log('Track durduruldu:', track.kind);
		        }); 
		        localStream = null; 
		    }
		    
		    // Video temizliği
		    cleanupVideoCall();
		    
		    const localAudio = document.getElementById('localAudio');
		    const remoteAudio = document.getElementById('remoteAudio');
		    if (localAudio) localAudio.srcObject = null;
		    if (remoteAudio) remoteAudio.srcObject = null;
		    callDuration = 0;
		    callStartTime = null;
		    pendingIceCandidates = [];
		    console.log('Call cleanup tamamlandı');
		}

        // Audio Controls
        function toggleMicrophone() {
            micEnabled = !micEnabled;
            const button = document.getElementById('micToggle');
            if (!button) return;
            button.className = micEnabled ? 'audio-toggle enabled' : 'audio-toggle disabled';
            button.textContent = micEnabled ? '🎤 Mikrofon' : '🎤 Kapalı';
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) audioTrack.enabled = micEnabled;
            }
            console.log(micEnabled ? '🎤 Mikrofon etkinleştirildi' : '🎤 Mikrofon devre dışı');
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            const button = document.getElementById('speakerToggle');
            const remoteAudio = document.getElementById('remoteAudio');
            if (!button) return;
            button.className = speakerEnabled ? 'audio-toggle enabled' : 'audio-toggle disabled';
            button.textContent = speakerEnabled ? '🔊 Hoparlör' : '🔊 Kapalı';
            if (remoteAudio) remoteAudio.volume = speakerEnabled ? document.getElementById('volumeSlider').value / 100 : 0;
            console.log(speakerEnabled ? '🔊 Hoparlör etkinleştirildi' : '🔊 Hoparlör devre dışı');
        }

        function toggleNoiseSuppression() {
            noiseSuppression = !noiseSuppression;
            const button = document.getElementById('noiseToggle');
            if (!button) return;
            button.className = noiseSuppression ? 'audio-toggle enabled' : 'audio-toggle disabled';
            button.textContent = noiseSuppression ? '✅ Gürültü' : '🚫 Gürültü';
            console.log(noiseSuppression ? '✅ Gürültü önleme etkin' : '🚫 Gürültü önleme kapalı');
        }

        function muteCall() {
            if (!localStream || !currentCall) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const button = document.getElementById('muteButton');
                if (button) {
                    button.textContent = audioTrack.enabled ? '🔇 Sessize Al' : '🔊 Sesi Aç';
                    button.className = audioTrack.enabled ? 'btn btn-primary' : 'btn btn-success';
                    showNotification(audioTrack.enabled ? 'Mikrofon açıldı' : 'Mikrofon kapatıldı', audioTrack.enabled ? 'success' : 'info', 2000);
                }
                console.log(audioTrack.enabled ? '🔊 Mikrofon açıldı' : '🔇 Mikrofon kapatıldı');
            }
        }

        function startTimer() {
            callStartTime = Date.now();
            callDuration = 0;
            callTimer = setInterval(() => {
                callDuration = Math.floor((Date.now() - callStartTime) / 1000);
                updateCallTimerDisplay();
            }, 1000);
            console.log('⏱️ Call timer başlatıldı');
        }

        function updateCallTimerDisplay() {
            const minutes = Math.floor(callDuration / 60);
            const seconds = callDuration % 60;
            const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const timerElement = document.getElementById('callTimer');
            if (timerElement) timerElement.textContent = timerText;
        }

        function updateConnectionQuality(state) {
            const qualityElement = document.getElementById('connectionQuality');
            if (!qualityElement) return;
            switch (state) {
                case 'connected': qualityElement.textContent = 'Mükemmel'; qualityElement.style.color = '#22c55e'; break;
                case 'connecting': qualityElement.textContent = 'Bağlanıyor'; qualityElement.style.color = '#f59e0b'; break;
                case 'failed': case 'disconnected': qualityElement.textContent = 'Kötü'; qualityElement.style.color = '#ef4444'; break;
                default: qualityElement.textContent = 'Bilinmiyor'; qualityElement.style.color = '#6b7280';
            }
        }

        // User Management
        async function loadOnlineUsers() {
            try {
                console.log('👥 Online kullanıcılar yükleniyor...');
                const response = await fetch(`${baseUrl}/api/approved-users`);
                if (response.ok) {
                    const allUsers = await response.json();
                    onlineUsers = allUsers.map(user => ({ ...user, isOnline: connectedUsers.some(c => c.id === user.id && c.userType === 'customer') }));
                    console.log('✅ Kullanıcılar yüklendi:', onlineUsers.length);
                    renderOnlineUsers();
                } else {
                    console.error('❌ Kullanıcı yükleme hatası:', response.status);
                }
            } catch (error) {
                console.error('❌ Kullanıcı yükleme hatası:', error);
                showNotification('Kullanıcılar yüklenemedi!', 'error');
            }
        }

        function renderOnlineUsers() {
            const container = document.getElementById('onlineUsersList');
            if (!container) return;
            const users = filteredUsers.length > 0 ? filteredUsers : onlineUsers;
            if (users.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #6b7280; padding: 30px;"><div style="font-size: 48px; margin-bottom: 10px;">👥</div><div>Kullanıcı bulunamadı</div></div>`;
                return;
            }
            container.innerHTML = users.map(user => {
                const isOnline = user.isOnline || connectedUsers.some(c => c.id === user.id && c.userType === 'customer');
                const canCall = isOnline && callState === 'idle';
                return `<div class="user-item ${isOnline ? 'online-user' : ''}"><div class="user-info"><div class="user-id">#${user.id}</div><div class="user-name">${user.name}</div><div class="user-credits">${user.credits || 0} Kredi</div><div class="user-status ${isOnline ? 'online' : ''}">${isOnline ? '🟢 Çevrimiçi' : '⚫ Çevrimdışı'}</div></div><div class="user-actions"><button class="btn btn-call" ${canCall ? `onclick="callCustomer('${user.id}', '${user.name}')"` : 'disabled'}>📞 Ara</button></div></div>`;
            }).join('');
        }

        function renderConnectedUsers() {
            const container = document.getElementById('userList');
            if (!container) return;
            const customers = connectedUsers.filter(u => u.userType === 'customer');
            if (customers.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: #6b7280; padding: 30px;"><div style="font-size: 48px; margin-bottom: 10px;">🌐</div><div>Henüz kullanıcı bağlanmadı</div></div>`;
                return;
            }
            container.innerHTML = customers.map(user => `<div class="connected-user"><div class="user-online-dot"></div><div style="flex: 1;"><div style="font-weight: 600; color: #1e293b;">${user.name || user.id}</div><div style="font-size: 12px; color: #64748b;">ID: ${user.id} | Bağlandı: ${user.registeredAt || 'Bilinmiyor'}</div></div></div>`).join('');
            console.log('👥 Bağlı kullanıcılar güncellendi:', customers.length);
        }

        function searchUsers() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            const term = searchInput.value.toLowerCase().trim();
            filteredUsers = term === '' ? [] : onlineUsers.filter(u => u.name.toLowerCase().includes(term) || u.id.includes(term));
            console.log('🔍 Arama sonucu:', filteredUsers.length, 'kullanıcı');
            renderOnlineUsers();
        }

        function playRingTone() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                setTimeout(() => { if (incomingCallInfo && callState === 'incoming') playRingTone(); }, 1000);
            } catch (error) {
                console.error('❌ Zil sesi çalınamadı:', error);
            }
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('creditNotifications');
            if (!container) return;
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            console.log(`📢 Bildirim [${type}]: ${message}`);
            setTimeout(() => {
                notification.classList.add('slide-out');
                setTimeout(() => { if (notification.parentNode) container.removeChild(notification); }, 300);
            }, duration);
        }

        function refreshData() { 
            console.log('🔄 Veriler yenileniyor...');
            if (!isInitializing) loadOnlineUsers();
            if (socket && socket.readyState === WebSocket.OPEN) socket.send(JSON.stringify({ type: 'refresh-data' }));
            showNotification('Veriler yenilendi!', 'success', 2000);
        }

        // Profile Management
        function openProfileModal() {
            if (!currentAdmin || !currentAdmin.username) {
                showNotification('Profil bilgileri için önce giriş yapılmalı.', 'error');
                return;
            }
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileModalContent');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div style="text-align: center; padding: 40px;">Profil verileri yükleniyor...</div>';
            
            fetchProfileData();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('hidden');
        }

        async function fetchProfileData() {
            try {
                const response = await fetch(`${baseUrl}/api/admins/${currentAdmin.username}/profile`);
                
                if (!response.ok) throw new Error('Profil verileri sunucudan alınamadı.');
                
                const result = await response.json();
                
                if (result.success) {
                    renderProfileModal(result.profile);
                } else {
                    throw new Error(result.error || 'Profil verileri işlenemedi.');
                }
                
            } catch (error) {
                const content = document.getElementById('profileModalContent');
                content.innerHTML = `<div class="no-reviews" style="color: #ef4444;">Hata: ${error.message}</div>`;
                console.error('Profil verileri alınırken hata oluştu:', error);
            }
        }

        function renderProfileModal(profile) {
            const content = document.getElementById('profileModalContent');
            const totalTips = profile.reviews.reduce((sum, review) => sum + (review.tip_amount || 0), 0);
            
            let reviewsHtml = '';
            if (profile.reviews && profile.reviews.length > 0) {
                reviewsHtml = profile.reviews.map(review => `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-author">${review.customer_name || `Kullanıcı #${review.customer_id}`}</span>
                            <span class="star-rating">${generateStars(review.rating)}</span>
                        </div>
                        <p class="review-comment">${review.comment || '<i>Yorum bırakılmadı.</i>'}</p>
                        ${review.tip_amount > 0 ? `<div class="review-tip">💰 ${review.tip_amount} Kredi destek gönderdi!</div>` : ''}
                        <div class="review-date">${new Date(review.created_at).toLocaleString('tr-TR')}</div>
                    </div>
                `).join('');
            } else {
                reviewsHtml = '<div class="no-reviews">Henüz hiç değerlendirme almadınız.</div>';
            }

            content.innerHTML = `
                <h3>👤 Profilim & Performansım</h3>
                <div class="profile-stats">
                    <div class="profile-stat-item">
                        <div class="profile-stat-value star-rating">
                            ${profile.average_rating} ★
                        </div>
                        <div class="profile-stat-label">Genel Puan Ortalaması</div>
                    </div>
                    <div class="profile-stat-item">
                        <div class="profile-stat-value" style="color: #16a34a;">
                            💰 ${totalTips}
                        </div>
                        <div class="profile-stat-label">Toplam Kazanılan Destek (Kredi)</div>
                    </div>
                </div>
                
                <h4>Gelen Değerlendirmeler</h4>
                <div class="reviews-list">
                    ${reviewsHtml}
                </div>
            `;
        }

        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            for (let i = 0; i < 5; i++) {
                stars += i < fullStars ? '★' : '☆';
            }
            return stars;
        }
        
        async function loadMyEarnings() {
            try {
                const response = await fetch(`${baseUrl}/api/my-earnings`);
                
                if (response.ok) {
                    const result = await response.json();
                    updateMyEarningsDisplay(result.earnings);
                } else {
                    console.error('Kazanç bilgisi yüklenemedi');
                }
            } catch (error) {
                console.error('Kazanç yükleme hatası:', error);
            }
        }
        
        function updateMyEarningsDisplay(earnings) {
            const earningsElement = document.getElementById('earningsAmount');
            if (earningsElement) {
                earningsElement.textContent = earnings || 0;
            }
        }
        
        function showTipNotification(sourceInfo) {
            const adminInfoDiv = document.querySelector('.admin-info');
            if (!adminInfoDiv) return;

            const existingNotif = document.getElementById('tipNotif');
            if(existingNotif) existingNotif.remove();

            const notification = document.createElement('div');
            notification.id = 'tipNotif';
            notification.className = 'tip-notification';
            notification.innerHTML = `<strong>+${sourceInfo.amount} kredi</strong> (${sourceInfo.customerName}'dan bahşiş)`;
            
            adminInfoDiv.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
		function openSettingsModal() {
		document.getElementById('settingsModal').classList.remove('hidden');
		updateDeviceSelectors();
		}

		function closeSettingsModal() {
			document.getElementById('settingsModal').classList.add('hidden');
		}
		// Dosya transfer değişkenleri
		let activeTransfers = new Map();
		let transferIdCounter = 0;
		
		function handleFileSelection(event) {
		    const file = event.target.files[0];
		    if (!file) return;
		    
		    console.log('Admin - Dosya seçildi:', file.name, file.type, file.size);
		    console.log('currentCall:', currentCall);
		    console.log('adminUniqueId:', adminUniqueId);
		    console.log('currentAdmin:', currentAdmin);
		    
		    // Dosya boyutu kontrolü (5MB limit)
		    if (file.size > 5 * 1024 * 1024) {
		        showNotification('Dosya boyutu 5MB\'dan büyük olamaz!', 'error');
		        return;
		    }
		    
		    const transferId = `transfer_${Date.now()}_${++transferIdCounter}`;
		    
		    // Admin tarafı için hedef belirleme
		    const targetId = currentCall?.userId;
		    const targetType = 'customer';
		    const fromName = currentAdmin?.username;
		    
		    console.log('Transfer bilgileri:', {
		        targetId,
		        targetType,
		        fromName,
		        transferId
		    });
		    
		    if (!targetId) {
		        showNotification('Aktif görüşme bulunamadı!', 'error');
		        console.log('Hata: targetId bulunamadı');
		        return;
		    }
		    
		    if (!socket || socket.readyState !== WebSocket.OPEN) {
		        showNotification('WebSocket bağlantısı yok!', 'error');
		        console.log('Hata: WebSocket bağlantısı yok');
		        return;
		    }
		    
		    try {
		        const message = {
		            type: 'file-transfer-request',
		            transferId: transferId,
		            fileName: file.name,
		            fileSize: file.size,
		            fileType: file.type,
		            targetId: targetId,
		            targetType: targetType,
		            from: fromName,
		            adminId: adminUniqueId
		        };
		        
		        console.log('Gönderilecek mesaj:', message);
		        
		        socket.send(JSON.stringify(message));
		        console.log('Dosya transfer isteği gönderildi');
		        
		        // Dosyayı parçalara böl ve gönder
		        sendFileInChunks(file, transferId, targetId, targetType);
		        
		    } catch (error) {
		        console.error('Dosya gönderme hatası:', error);
		        showNotification('Dosya gönderilirken hata oluştu: ' + error.message, 'error');
		    }
		    
		    // Input'u temizle
		    event.target.value = '';
		}
		
		function sendFileInChunks(file, transferId, targetId, targetType) {
		    const chunkSize = 64 * 1024; // 64KB chunks
		    const totalChunks = Math.ceil(file.size / chunkSize);
		    let chunkIndex = 0;
		    
		    const reader = new FileReader();
		    
		    reader.onload = function(e) {
		        const chunk = btoa(e.target.result); // Base64 encode
		        
		        if (socket && socket.readyState === WebSocket.OPEN) {
		            socket.send(JSON.stringify({
		                type: 'file-chunk',
		                transferId: transferId,
		                chunk: chunk,
		                chunkIndex: chunkIndex,
		                totalChunks: totalChunks,
		                targetId: targetId,
		                targetType: targetType
		            }));
		        }
		        
		        chunkIndex++;
		        if (chunkIndex < totalChunks) {
		            // Sonraki chunk'ı oku
		            const start = chunkIndex * chunkSize;
		            const end = Math.min(start + chunkSize, file.size);
		            const blob = file.slice(start, end);
		            reader.readAsBinaryString(blob);
		        } else {
		            showNotification(`${file.name} gönderildi`, 'success');
		        }
		    };
		    
		    // İlk chunk'ı başlat
		    const blob = file.slice(0, chunkSize);
		    reader.readAsBinaryString(blob);
		}
		function handleIncomingFileRequest(message) {
		    const { transferId, fileName, fileSize, from } = message;
		    
		    // Transfer'ı başlat
		    activeTransfers.set(transferId, {
		        fileName: fileName,
		        fileSize: fileSize,
		        from: from,
		        chunks: [],
		        receivedChunks: 0,
		        totalChunks: 0
		    });
		    
		    addFileMessage(from, fileName, fileSize, 'receiving');
		    showNotification(`${from} size ${fileName} dosyasını gönderiyor`, 'info');
		}
		
		function handleIncomingFileChunk(message) {
		    const { transferId, chunk, chunkIndex, totalChunks } = message;
		    const transfer = activeTransfers.get(transferId);
		    
		    if (!transfer) return;
		    
		    transfer.chunks[chunkIndex] = chunk;
		    transfer.receivedChunks++;
		    transfer.totalChunks = totalChunks;
		    
		    // Tüm chunk'lar alındı mı?
		    if (transfer.receivedChunks === totalChunks) {
		        // Dosyayı birleştir
		        const binaryString = transfer.chunks.map(c => atob(c)).join('');
		        const bytes = new Uint8Array(binaryString.length);
		        for (let i = 0; i < binaryString.length; i++) {
		            bytes[i] = binaryString.charCodeAt(i);
		        }
		        
		        // Dosyayı indir
		        const blob = new Blob([bytes]);
		        const url = URL.createObjectURL(blob);
		        const a = document.createElement('a');
		        a.href = url;
		        a.download = transfer.fileName;
		        a.click();
		        
		        URL.revokeObjectURL(url);
		        activeTransfers.delete(transferId);
		        
		        showNotification(`${transfer.fileName} indirildi`, 'success');
		    }
		}
		
		function addFileMessage(from, fileName, fileSize, status) {
		    const messagesContainer = document.getElementById('chatMessages');
		    if (!messagesContainer) return;
		    
		    const sizeText = (fileSize / 1024).toFixed(1) + ' KB';
		    const messageEl = document.createElement('div');
		    messageEl.className = 'message received';
		    messageEl.innerHTML = `
		        <div style="font-weight: 600; margin-bottom: 3px;">${from}</div>
		        <div style="background: #f0f0f0; padding: 8px; border-radius: 6px; border-left: 3px solid #2563eb;">
		            📎 ${fileName}<br>
		            <small>${sizeText} • ${status === 'receiving' ? 'Alınıyor...' : 'Gönderildi'}</small>
		        </div>
		    `;
		    
		    messagesContainer.appendChild(messageEl);
		    messagesContainer.scrollTop = messagesContainer.scrollHeight;
		}

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('❌ Global hata:', event.error);
            if (!isInitializing) showNotification('Beklenmeyen bir hata oluştu!', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Unhandled promise rejection:', event.reason);
            if (!isInitializing) showNotification('Promise hatası oluştu!', 'error');
        });
        
        console.log('🎯 VIPCEP Admin Panel - VIDEO ARAMA VERSİYONU');
		
    </script>
</body>
</html>















