// 🔔 ADMIN-PANEL.HTML'E EKLENECEKLER

// 1. Sayfa yüklendiğinde bildirim izni iste
window.onload = function() {
    log('🚀 Admin panel başlatılıyor...');
    
    // Bildirim izni iste
    requestNotificationPermission();
    
    loadApprovedUsers();
    connectToServer();
    
    document.getElementById('newUserId').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
};

// 2. Bildirim izni fonksiyonu
function requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    log('✅ Bildirim izni verildi');
                    showTestNotification();
                } else {
                    log('❌ Bildirim izni reddedildi');
                }
            });
        } else if (Notification.permission === 'granted') {
            log('✅ Bildirim izni zaten mevcut');
        }
    } else {
        log('❌ Bu tarayıcı bildirimi desteklemiyor');
    }
}

// 3. Test bildirimi (ilk açılışta)
function showTestNotification() {
    const notification = new Notification('🎯 VIPCEP Admin Panel', {
        body: 'Bildirimler aktif! Gelen aramalardan haberdar olacaksınız.',
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2322c55e"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef4444"><circle cx="12" cy="12" r="10"/></svg>',
        tag: 'vipcep-test',
        requireInteraction: false
    });

    // 3 saniye sonra otomatik kapat
    setTimeout(() => notification.close(), 3000);
}

// 4. Gelen arama bildirimi fonksiyonu
function showIncomingCallNotification(caller) {
    if (Notification.permission !== 'granted') return;

    const notification = new Notification('📞 GELEN ARAMA!', {
        body: `${caller.userName} (${caller.userId}) sizi arıyor\n💳 Kredi: ${caller.credits} dakika`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f59e0b"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef4444"><circle cx="12" cy="12" r="10"/></svg>',
        tag: 'incoming-call',
        requireInteraction: true, // Kapanmasın
        actions: [
            {action: 'answer', title: '✅ Kabul Et'},
            {action: 'reject', title: '❌ Reddet'}
        ]
    });

    // Bildirime tıklandığında
    notification.onclick = function() {
        window.focus(); // Sekmeyi öne getir
        document.querySelector('#acceptBtn')?.scrollIntoView(); // Kabul butonuna odaklan
        notification.close();
        
        // Ses de çal
        playIncomingCallSound();
    };

    // Action button'lara tıklandığında
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('notificationclick', function(event) {
            if (event.action === 'answer') {
                acceptCall();
            } else if (event.action === 'reject') {
                rejectCall();
            }
            event.notification.close();
            window.focus();
        });
    }

    // 30 saniye sonra kapat (arama timeout'u)
    setTimeout(() => notification.close(), 30000);
}

// 5. Giden arama bildirimi
function showOutgoingCallNotification(callInfo) {
    if (Notification.permission !== 'granted') return;

    const notification = new Notification('📞 ARAMA YAPILIYOR', {
        body: `${callInfo.userName} (${callInfo.userId}) aranıyor...\n⏱️ Cevap bekleniyor`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%232563eb"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',
        tag: 'outgoing-call',
        requireInteraction: false
    });

    notification.onclick = function() {
        window.focus();
        notification.close();
    };

    // 30 saniye sonra kapat
    setTimeout(() => notification.close(), 30000);
}

// 6. Bildirim sesini çalma
function playNotificationSound() {
    try {
        // Çift ses efekti
        const beep1 = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUaBDSH0vLYi');
        beep1.play();
        
        setTimeout(() => {
            const beep2 = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUaBDSH0vLYi');
            beep2.play();
        }, 300);
        
    } catch (error) {
        console.log('Bildirim sesi çalınamadı:', error);
    }
}

// 7. showIncomingCall fonksiyonunu güncelleyelim
function showIncomingCall(caller) {
    try {
        currentCall = caller;
        
        // UI güncellemeleri...
        document.getElementById('callerName').textContent = caller.userName;
        document.getElementById('callerId').textContent = caller.userId;
        document.getElementById('callerCredits').textContent = caller.credits;
        document.getElementById('incomingCall').classList.remove('hidden');
        
        // ARKA PLAN BİLDİRİM EKLE
        showIncomingCallNotification(caller);
        playNotificationSound();
        
        log(`📞 Gelen arama: ${caller.userName} (${caller.credits} dk)`);
        playNotificationSound();
        
    } catch (error) {
        console.error('❌ showIncomingCall hatası:', error);
    }
}

// 8. callUser fonksiyonunu güncelleyelim
function callUser(userId) {
    const user = approvedUsers.find(u => u.id === userId);
    if (!user) {
        alert('Kullanıcı bulunamadı!');
        return;
    }

    // ... mevcut kontroller ...

    outgoingCallInfo = {
        userId: userId,
        userName: user.name,
        credits: user.credits,
        startTime: Date.now()
    };

    showOutgoingCall(outgoingCallInfo);
    
    // ARKA PLAN BİLDİRİM EKLE
    showOutgoingCallNotification(outgoingCallInfo);
    
    playAdminRingbackTone();

    // ... websocket gönderimi ...
}

// 9. Görüşme başladığında bildirimi kapat
function startCallTimer() {
    callDuration = 0;
    
    // Tüm bildirimleri kapat
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            registration.getNotifications().then(notifications => {
                notifications.forEach(notification => notification.close());
            });
        });
    }
    
    callTimer = setInterval(function() {
        callDuration++;
        const mins = Math.floor(callDuration / 60);
        const secs = callDuration % 60;
        document.getElementById('callTimer').textContent = 
            mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
    }, 1000);
}

// =====================================================
// 🔔 CUSTOMER-APP.HTML'E EKLENECEKLER

// 1. VIPCEPApp class'ına bildirim sistemi ekle
class VIPCEPApp {
    constructor() {
        this.requestNotificationPermission();
        this.init();
    }
    
    // Bildirim izni iste
    requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('✅ Müşteri bildirim izni verildi');
                    }
                });
            }
        }
    }
    
    // Admin arama bildirimi
    showAdminCallNotification() {
        if (Notification.permission !== 'granted') return;

        const notification = new Notification('🔧 USTAM ARIYOR!', {
            body: 'Teknik destek sizi arıyor.\nAramayı kabul ediyor musunuz?',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2322c55e"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>',
            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef4444"><circle cx="12" cy="12" r="10"/></svg>',
            tag: 'admin-calling',
            requireInteraction: true,
            vibrate: [300, 100, 300, 100, 300], // Mobilde titreşim
            actions: [
                {action: 'accept', title: '✅ Kabul Et'},
                {action: 'reject', title: '❌ Reddet'}
            ]
        });

        // Bildirime tıklandığında
        notification.onclick = function() {
            window.focus();
            document.querySelector('#acceptCallButton')?.scrollIntoView();
            notification.close();
        };

        // 30 saniye sonra kapat
        setTimeout(() => notification.close(), 30000);
    }
    
    // showIncomingCall fonksiyonunu güncelle
    showIncomingCall() {
        callState = 'incoming';
        
        document.getElementById('idleState').classList.add('hidden');
        document.getElementById('callingState').classList.add('hidden');
        document.getElementById('connectingState').classList.add('hidden');
        document.getElementById('connectedState').classList.add('hidden');
        
        document.getElementById('incomingCallState').classList.remove('hidden');
        document.getElementById('displayUserStatus').textContent = 'Gelen Arama';
        
        // ARKA PLAN BİLDİRİM EKLE
        this.showAdminCallNotification();
        
        console.log('📱 Gelen arama UI gösterildi');
    }
    
    // Arama başladığında bildirimleri kapat
    setState(newState) {
        callState = newState;
        
        // Görüşme başlarsa bildirimleri kapat
        if (newState === 'connected') {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.getNotifications().then(notifications => {
                        notifications.forEach(notification => notification.close());
                    });
                });
            }
        }
        
        // ... mevcut setState kodu ...
    }
}
