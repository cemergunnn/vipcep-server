<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Admin Panel</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #dc2626; color: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.5em; }
        .header .status { display: flex; align-items: center; gap: 10px; }
        .status-circle { width: 10px; height: 10px; border-radius: 50%; background: #34c759; }
        .status-circle.busy { background: #ff3b30; }
        .panel { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { margin: 0 0 15px; font-size: 1.2em; }
        .call-queue { max-height: 300px; overflow-y: auto; }
        .call-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .call-item:last-child { border-bottom: none; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #dc2626; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .volume-slider { width: 100%; margin: 10px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¯ VIPCEP Admin Panel</h1>
                <p>Voice IP Communication Emergency Protocol</p>
            </div>
            <div class="status">
                <div id="connection-status">BaÄŸlanÄ±yor...</div>
                <div class="status-circle" id="admin-status"></div>
                <span id="admin-username">-</span>
                <span>ğŸŸ¡ Normal Admin</span>
                <button class="btn btn-secondary" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="panel">
            <div class="card">
                <h2>ğŸ“ Arama YÃ¶netimi</h2>
                <div id="call-management">
                    <div class="card">
                        <h2>âš¡ Performans Metrikleri</h2>
                        <div class="controls">
                            <div>-</div>
                            <div>Ort. YanÄ±t</div>
                            <div>0</div>
                            <div>Ä°ÅŸlenen</div>
                            <div>-%</div>
                            <div>BaÅŸarÄ±</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ”Š Ses Kontrolleri</h2>
                        <div>
                            <label>Ses Seviyesi:</label>
                            <input type="range" class="volume-slider" min="0" max="100" value="70" oninput="adjustVolume(this.value)">
                            <span>70%</span>
                        </div>
                        <div class="controls">
                            <button class="btn btn-secondary" onclick="toggleMic()">ğŸ¤ Mikrofon</button>
                            <button class="btn btn-secondary" onclick="toggleSpeaker()">ğŸ”Š HoparlÃ¶r</button>
                            <button class="btn btn-secondary" onclick="toggleNoiseCancellation()">ğŸš« GÃ¼rÃ¼ltÃ¼</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“‹ Gelen Aramalar</h2>
                        <div id="queue-size">0/5</div>
                        <div class="call-queue" id="call-queue">
                            <div class="call-item">
                                <span>HenÃ¼z gelen arama yok</span>
                                <span>MÃ¼ÅŸteriler arama yaptÄ±ÄŸÄ±nda burada gÃ¶rÃ¼necek</span>
                            </div>
                        </div>
                    </div>

                    <div class="card hidden" id="outgoing-call">
                        <h2>ğŸ“ GÄ°DEN ARAMA</h2>
                        <div id="outgoing-call-info">-</div>
                        <div>ID: -</div>
                        <div>BaÄŸlantÄ± kuruluyor...</div>
                        <button class="btn btn-primary" onclick="cancelOutgoingCall()">âŒ Ä°ptal Et</button>
                    </div>

                    <div class="card hidden" id="call-cancelled">
                        <h2>âŒ ARAMA Ä°PTAL EDÄ°LDÄ°</h2>
                        <div>-</div>
                        <div>MÃ¼ÅŸteri aramayÄ± iptal etti</div>
                        <button class="btn btn-primary" onclick="closeCallCancelled()">âœ”ï¸ Tamam</button>
                    </div>

                    <div class="card hidden" id="call-taken">
                        <h2>ğŸ‘¥ ARAMA BAÅKA ADMÄ°N TARAFINDAN ALINDI</h2>
                        <div>-</div>
                        <div>AlÄ±nan Admin: -</div>
                        <button class="btn btn-primary" onclick="closeCallTaken()">âœ”ï¸ Tamam</button>
                    </div>

                    <div class="card hidden" id="active-call">
                        <h2>ğŸ“Š GÃ–RÃœÅME AKTÄ°F</h2>
                        <div>
                            <div id="active-call-user">-</div>
                            <div>GÃ¶rÃ¼ÅŸme SÃ¼resi: <span id="call-duration">00:00</span></div>
                            <div>BaÄŸlantÄ±: <span id="connection-quality">Ä°yi</span></div>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" onclick="endCall()">ğŸ“ GÃ¶rÃ¼ÅŸmeyi Bitir</button>
                            <button class="btn btn-secondary" onclick="toggleMute()">ğŸ”‡ Sessize Al</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentCall = null;
        let callTimer = null;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${location.host}`);
            
            ws.onopen = () => {
                document.getElementById('connection-status').textContent = 'BaÄŸlandÄ±';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                switch (message.type) {
                    case 'login-response':
                        if (message.success) {
                            document.getElementById('admin-username').textContent = message.user.username;
                            document.getElementById('admin-status').className = `status-circle ${message.user.status}`;
                        } else {
                            alert(`GiriÅŸ baÅŸarÄ±sÄ±z: ${message.reason}`);
                        }
                        break;
                    
                    case 'user-list-update':
                        message.users.forEach(user => {
                            if (user.userType === 'admin' && user.uniqueId === message.user?.uniqueId) {
                                document.getElementById('admin-status').className = `status-circle ${user.status}`;
                            }
                        });
                        break;
                    
                    case 'call-queue-update':
                        updateCallQueue(message.queue, message.queueSize);
                        break;
                    
                    case 'call-accepted':
                        currentCall = { callId: message.callId, targetId: message.acceptedAdminId };
                        showActiveCall(message);
                        break;
                    
                    case 'call-rejected':
                        showCallCancelled(message);
                        break;
                    
                    case 'call-taken':
                        showCallTaken(message);
                        break;
                    
                    case 'call-ended':
                        endActiveCall(message);
                        break;
                }
            };

            ws.onclose = () => {
                document.getElementById('connection-status').textContent = 'BaÄŸlantÄ± kesildi';
                setTimeout(connectWebSocket, 5000);
            };
        }

        function updateCallQueue(queue, size) {
            const queueElement = document.getElementById('call-queue');
            document.getElementById('queue-size').textContent = `${size}/5`;
            
            queueElement.innerHTML = '';
            if (queue.length === 0) {
                queueElement.innerHTML = `
                    <div class="call-item">
                        <span>HenÃ¼z gelen arama yok</span>
                        <span>MÃ¼ÅŸteriler arama yaptÄ±ÄŸÄ±nda burada gÃ¶rÃ¼necek</span>
                    </div>`;
                return;
            }
            
            queue.forEach(call => {
                const item = document.createElement('div');
                item.className = 'call-item';
                item.innerHTML = `
                    <span>${call.userName} (ID: ${call.userId})</span>
                    <div class="controls">
                        <button class="btn btn-primary" onclick="acceptCall('${call.callId}')">ğŸ“ Kabul Et</button>
                        <button class="btn btn-secondary" onclick="rejectCall('${call.callId}')">ğŸ—‘ï¸ Reddet</button>
                    </div>`;
                queueElement.appendChild(item);
            });
        }

        function acceptCall(callId) {
            ws.send(JSON.stringify({
                type: 'accept-call-by-id',
                callId: callId
            }));
        }

        function rejectCall(callId) {
            ws.send(JSON.stringify({
                type: 'reject-call-by-id',
                callId: callId,
                reason: 'Admin tarafÄ±ndan reddedildi'
            }));
        }

        function showActiveCall(message) {
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('active-call').classList.remove('hidden');
            document.getElementById('active-call-user').textContent = `MÃ¼ÅŸteri: ${message.userId}`;
            startCallTimer();
        }

        function showCallCancelled(message) {
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('call-cancelled').classList.remove('hidden');
        }

        function showCallTaken(message) {
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('call-taken').classList.remove('hidden');
        }

        function endActiveCall(message) {
            clearInterval(callTimer);
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('call-queue').parentElement.classList.remove('hidden');
            currentCall = null;
        }

        function startCallTimer() {
            let seconds = 0;
            callTimer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('call-duration').textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function endCall() {
            if (currentCall) {
                ws.send(JSON.stringify({
                    type: 'end-call',
                    targetId: currentCall.targetId,
                    duration: parseInt(document.getElementById('call-duration').textContent.split(':').reduce((m, s) => parseInt(m) * 60 + parseInt(s), 0))
                }));
            }
        }

        function cancelOutgoingCall() {
            ws.send(JSON.stringify({
                type: 'call-cancelled',
                callId: currentCall?.callId
            }));
        }

        function closeCallCancelled() {
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('call-queue').parentElement.classList.remove('hidden');
        }

        function closeCallTaken() {
            document.getElementById('call-management').querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById('call-queue').parentElement.classList.remove('hidden');
        }

        function adjustVolume(value) {
            // Implement volume adjustment
            document.querySelector('.volume-slider + span').textContent = `${value}%`;
        }

        function toggleMic() {
            // Implement microphone toggle
        }

        function toggleSpeaker() {
            // Implement speaker toggle
        }

        function toggleNoiseCancellation() {
            // Implement noise cancellation
        }

        function toggleMute() {
            // Implement mute functionality
        }

        function logout() {
            ws.close();
            window.location.href = '/';
        }

        connectWebSocket();
    </script>
</body>
</html>
