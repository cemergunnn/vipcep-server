<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>VIPCEP Admin Paneli</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    h1 { text-align: center; color: #333; }
    .call-info, .status-info, .credit-info { margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    #status { font-weight: bold; color: green; }
    #call-details, #credit-balance { margin-top: 10px; }
    #accept-call, #end-call { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; }
    #accept-call { background-color: #4CAF50; display: none; }
    #end-call { background-color: #f44336; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VIPCEP Admin Paneli</h1>

    <div class="status-info">
      <p>Durum: <span id="status">Bağlanıyor...</span></p>
    </div>

    <div class="call-info">
      <h2 id="call-message"></h2>
      <button id="accept-call">Aramayı Kabul Et</button>
      <button id="end-call">Görüşmeyi Sonlandır</button>
    </div>

    <div class="credit-info">
      <h2>Müşteri Kredisi</h2>
      <p id="credit-balance">Bilgi bekleniyor...</p>
    </div>

    <script>
      const ws = new WebSocket("ws://localhost:3000"); // Proje Railway'de ise Railway URL'si ile değiştirin
      let localStream;
      let peerConnection;
      let customerId;

      ws.onopen = () => {
        console.log("WebSocket connected.");
        ws.send(JSON.stringify({ type: "register_admin", user_id: "admin1" }));
        document.getElementById("status").innerText = "Müsait";
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        switch (data.type) {
          case "incoming_call":
            document.getElementById("status").innerText = "Gelen Arama";
            document.getElementById("call-message").innerText = `${data.customer_name} sizi arıyor...`;
            document.getElementById("accept-call").style.display = "block";
            customerId = data.from; // Müşteri kimliğini sakla
            break;

          case "webrtc_offer":
            if (!peerConnection) createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "webrtc_answer", to: customerId, answer: answer }));
            break;

          case "webrtc_ice_candidate":
            if (peerConnection) {
              await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
            break;
            
          case "credit_update":
            document.getElementById("credit-balance").innerText = `Yeni Kredi: ${data.credits} dakika`;
            break;
        }
      };

      document.getElementById("accept-call").onclick = async () => {
        document.getElementById("status").innerText = "Görüşme Başladı";
        document.getElementById("call-message").innerText = "";
        document.getElementById("accept-call").style.display = "none";
        document.getElementById("end-call").style.display = "block";

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        createPeerConnection();
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      };

      document.getElementById("end-call").onclick = () => {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
        }
        document.getElementById("status").innerText = "Müsait";
        document.getElementById("call-message").innerText = "Görüşme Sona Erdi";
        document.getElementById("end-call").style.display = "none";

        ws.send(JSON.stringify({
          type: "call_end",
          duration: 120, // Örnek süre (gerçek uygulamada hesaplanmalı)
          customer_id: customerId,
          admin_id: ws.client_id,
        }));
      };

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            ws.send(JSON.stringify({ type: "webrtc_ice_candidate", to: customerId, candidate: event.candidate }));
          }
        };
        peerConnection.ontrack = (event) => {
          const remoteAudio = new Audio();
          remoteAudio.srcObject = event.streams[0];
          remoteAudio.play();
        };
      }
    </script>
  </div>
</body>
</html>
