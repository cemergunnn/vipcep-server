// Admin panel'de addApprovedUser fonksiyonunu düzelt
function addApprovedUser() {
    const userId = document.getElementById('newUserId').value.trim();
    const userName = document.getElementById('newUserName').value.trim();
    const userCredits = parseInt(document.getElementById('newUserCredits').value) || 0;
    
    if (!userId || userId.length !== 4 || !/^\d{4}$/.test(userId)) {
        alert('Lütfen 4 haneli sayısal ID girin!');
        return;
    }
    
    if (!userName) {
        alert('Lütfen kullanıcı adını girin!');
        return;
    }
    
    if (approvedUsers.find(u => u.id === userId)) {
        alert('Bu ID zaten kullanılıyor!');
        return;
    }
    
    // Loading state
    const addButton = document.querySelector('button[onclick="addApprovedUser()"]');
    const originalText = addButton.textContent;
    addButton.disabled = true;
    addButton.textContent = '⏳ Ekleniyor...';
    
    // API'ye kullanıcı ekleme isteği gönder
    fetch('/api/approved-users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            id: userId,
            name: userName,
            credits: userCredits
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.user) {
            // Local storage'a da ekle
            const newUser = {
                id: data.user.id,
                name: data.user.name,
                credits: data.user.credits,
                createdAt: data.user.created_at || new Date().toLocaleString(),
                totalCalls: data.user.total_calls || 0,
                lastCall: data.user.last_call
            };
            
            approvedUsers.push(newUser);
            saveApprovedUsers();
            searchUsers();
            updateStats();
            
            // Form'u temizle
            document.getElementById('newUserId').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserCredits').value = '';
            
            log(`✅ Kullanıcı başarıyla eklendi: ${userName} (${userId}) - ${userCredits} dk`);
            
            // Başarı bildirimi
            showSuccessNotification(`Kullanıcı eklendi: ${userName} (${userId})`);
            
        } else {
            throw new Error(data.error || 'Kullanıcı eklenemedi');
        }
    })
    .catch(error => {
        console.error('Kullanıcı ekleme hatası:', error);
        alert('Kullanıcı ekleme hatası: ' + error.message);
        log(`❌ Kullanıcı ekleme hatası: ${error.message}`);
    })
    .finally(() => {
        // Loading state'i kaldır
        addButton.disabled = false;
        addButton.textContent = originalText;
    });
}

// Başarı bildirimi göster
function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'credit-update-notification';
    notification.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
    notification.innerHTML = `✅ ${message}`;
    
    const container = document.getElementById('creditNotifications');
    container.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.add('slide-out');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 3000);
}
