<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIPCEP Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .header-left h1 { font-size: 24px; margin-bottom: 5px; }
        .header-left p { opacity: 0.9; font-size: 14px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .admin-info { text-align: right; }
        .admin-name { font-weight: 700; font-size: 16px; }
        .admin-role { font-size: 12px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; margin-top: 5px; }
        .logout-btn { background: rgba(239, 68, 68, 0.3); color: white; border: 1px solid rgba(239, 68, 68, 0.5); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.5); transform: translateY(-1px); }
        .status { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        .connected { background: #22c55e; }
        .disconnected { background: #ef4444; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .main-content { display: grid; grid-template-columns: 1fr 1fr 300px; gap: 20px; }
        .panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid rgba(34, 197, 94, 0.1); }
        .panel h3 { margin-bottom: 20px; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #22c55e; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-number { font-size: 28px; font-weight: 800; color: #22c55e; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        
        /* Çoklu Arama Sistemi */
        .call-queue-container { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid rgba(34, 197, 94, 0.1); overflow: hidden; margin-bottom: 20px; }
        .call-queue-header { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .queue-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .queue-counter { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .call-queue-list { max-height: 500px; overflow-y: auto; }
        .call-queue-empty { text-align: center; padding: 40px 20px; color: #64748b; }
        .call-item { border-bottom: 1px solid #e5e7eb; transition: all 0.3s ease; cursor: pointer; }
        .call-item:hover { background: #f8fafc; }
        .call-item:last-child { border-bottom: none; }
        .call-item.priority-1 { padding: 25px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; animation: callPulse 1.5s infinite; }
        .call-item.priority-2, .call-item.priority-3, .call-item.priority-4, .call-item.priority-5 { padding: 18px 25px; background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }
        .call-item.priority-2 { opacity: 0.9; } .call-item.priority-3 { opacity: 0.8; } .call-item.priority-4 { opacity: 0.7; } .call-item.priority-5 { opacity: 0.6; }
        @keyframes callPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .call-item-content { display: flex; justify-content: space-between; align-items: center; }
        .call-item-info { flex: 1; }
        .call-item-name { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .call-item.priority-2 .call-item-name, .call-item.priority-3 .call-item-name, .call-item.priority-4 .call-item-name, .call-item.priority-5 .call-item-name { font-size: 16px; }
        .call-item-details { font-size: 14px; opacity: 0.9; display: flex; gap: 15px; flex-wrap: wrap; }
        .call-item.priority-2 .call-item-details, .call-item.priority-3 .call-item-details, .call-item.priority-4 .call-item-details, .call-item.priority-5 .call-item-details { font-size: 13px; }
        .call-item-timer { font-family: 'Courier New', monospace; font-weight: bold; margin-top: 5px; }
        .call-item-actions { display: flex; gap: 8px; }
        
        .outgoing-call { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; animation: callPulse 1.5s infinite; box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4); }
        .call-cancelled { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }
        .call-taken { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4); }
        .active-call { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4); }
        .call-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-accept { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-reject { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-call { background: linear-gradient(135deg, #059669, #047857); color: white; padding: 6px 12px; font-size: 12px; border-radius: 6px; margin-left: 8px; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 14px 45px 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; background: white; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .user-list { max-height: 450px; overflow-y: auto; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 10px; background: white; transition: all 0.3s ease; }
        .user-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-color: #22c55e; }
        .user-item.online-user { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-color: #22c55e; }
        .user-info { flex: 1; }
        .user-id { font-weight: 700; color: #2563eb; font-family: 'Courier New', monospace; font-size: 16px; }
        .user-name { color: #374151; font-size: 15px; font-weight: 600; margin: 2px 0; }
        .user-credits { color: #059669; font-size: 13px; font-weight: 600; }
        .user-status { color: #6b7280; font-size: 12px; margin-top: 4px; }
        .user-status.online { color: #22c55e; font-weight: 600; }
        .user-actions { display: flex; align-items: center; gap: 8px; }
        .connected-user { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background: white; }
        .user-online-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        .user-offline-dot { width: 10px; height: 10px; background: #6b7280; border-radius: 50%; }
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 350px; }
        .notification { background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-left: 4px solid #22c55e; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .notification.slide-out { animation: slideOut 0.3s ease-in; }
        @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        .log-container { background: #1f2937; color: #f9fafb; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; margin-top: 20px; }
        .log-container div { margin-bottom: 4px; opacity: 0.9; }
        .hidden { display: none !important; }
        .loading { opacity: 0.7; pointer-events: none; }
        .highlighted { background: #fef3c7; font-weight: 600; padding: 0 2px; border-radius: 2px; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; gap: 20px; } }
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: linear-gradient(135deg, #64748b, #475569); color: white; box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3); }
        .btn-success { background: linear-gradient(135deg, #059669, #047857); color: white; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>🎯 VIPCEP Admin Panel</h1>
                <p>Voice IP Communication Emergency Protocol</p>
            </div>
            <div class="header-right">
                <div class="status">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">Bağlanıyor...</span>
                </div>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">-</div>
                    <div class="admin-role">🟡 Normal Admin</div>
                </div>
                <button class="logout-btn" onclick="performLogout()">🚪 Çıkış</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="totalApproved">0</div><div class="stat-label">Onaylı Kullanıcı</div></div>
            <div class="stat-card"><div class="stat-number" id="onlineUsers">0</div><div class="stat-label">Çevrimiçi</div></div>
            <div class="stat-card"><div class="stat-number" id="totalCredits">0</div><div class="stat-label">Toplam Kredi</div></div>
            <div class="stat-card"><div class="stat-number" id="todayCalls">0</div><div class="stat-label">Bugün Arama</div></div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h3>📞 Arama Yönetimi</h3>
                
                <div class="call-queue-container" id="callQueueContainer">
                    <div class="call-queue-header">
                        <div class="queue-title">📋 Gelen Aramalar</div>
                        <div class="queue-counter" id="queueCounter">0/5</div>
                    </div>
                    <div class="call-queue-list" id="callQueueList">
                        <div class="call-queue-empty">
                            <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">📞</div>
                            <div>Henüz gelen arama yok</div>
                        </div>
                    </div>
                </div>

                <div id="outgoingCall" class="outgoing-call hidden">
                    <h3>📞 GİDEN ARAMA</h3>
                    <div style="margin: 15px 0;">
                        <p style="font-size: 18px; font-weight: 600;"><span id="outgoingName">-</span></p>
                        <p style="opacity: 0.9;">ID: <span id="outgoingId">-</span></p>
                    </div>
                    <div class="call-buttons">
                        <button class="btn btn-reject" onclick="cancelOutgoingCall()">❌ İptal Et</button>
                    </div>
                </div>

                <div id="callCancelled" class="call-cancelled hidden">
                    <h3>❌ ARAMA İPTAL EDİLDİ</h3>
                    <div style="margin: 15px 0;">
                        <p style="font-weight: 600;"><span id="cancelledName">-</span></p>
                        <p style="opacity: 0.9;" id="cancelledReason">Müşteri aramayı iptal etti</p>
                    </div>
                    <button class="btn" style="background: #6b7280; color: white; margin-top: 10px;" onclick="dismissCancelledCall()">✔️ Tamam</button>
                </div>

                <div id="callTaken" class="call-taken hidden">
                    <h3>👥 ARAMA BAŞKA ADMİN TARAFINDAN ALINDI</h3>
                    <div style="margin: 15px 0;">
                        <p style="font-weight: 600;"><span id="takenCallerName">-</span></p>
                        <p style="opacity: 0.9;">Alınan Admin: <span id="takenByAdmin">-</span></p>
                    </div>
                    <button class="btn" style="background: #6b7280; color: white; margin-top: 10px;" onclick="dismissTakenCall()">✔️ Tamam</button>
                </div>
                
                <div id="activeCall" class="active-call hidden">
                    <h3>📊 GÖRÜŞME AKTİF</h3>
                    <p style="font-size: 18px; font-weight: 600; margin: 10px 0;"><span id="activeCaller">-</span></p>
                    <div style="font-size: 32px; font-weight: 800; margin: 15px 0; font-family: 'Courier New', monospace;" id="callTimer">00:00</div>
                    <button class="btn btn-reject" onclick="endCall()">📞 Görüşmeyi Bitir</button>
                </div>
                
                <h3 style="margin-top: 25px;">📋 Sistem Logları</h3>
                <div class="log-container" id="logContainer">
                    <div>[Sistem] Admin panel başlatılıyor...</div>
                </div>
            </div>
            
            <div class="panel">
                <h3>👥 Onaylı Kullanıcılar</h3>
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="🔍 Kullanıcı adı veya ID ile ara..." oninput="searchUsers()">
                    <div class="search-icon">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                </div>
                <div id="searchResults" class="hidden"></div>
                <div class="user-list" id="approvedUsersList">
                    <div style="text-align: center; color: #6b7280; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">👥</div>
                        <div>Kullanıcılar yükleniyor...</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>👥 Aktif Bağlantılar</h3>
                <div id="userList" style="margin-top: 15px;">
                    <div style="text-align: center; color: #6b7280; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🌍</div>
                        <div>Henüz kullanıcı bağlanmadı</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">🔄 Verileri Yenile</button>
                    <button class="btn btn-primary" onclick="window.open('https://wa.me/905374792403', '_blank')">💬 WhatsApp Destek</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="creditNotifications" class="notification-container"></div>
    <audio id="remoteAudio" autoplay></audio>
    
    <script>
        let socket, peerConnection, localStream, currentCall, callTimer, callDuration = 0;
        let connectedUsers = [], approvedUsers = [], filteredUsers = [], outgoingCallInfo = null;
        let isLoggedIn = false, currentAdmin = null, adminUniqueId = null, originalAdminId = "ADMIN001";
        let currentCallQueue = [], queueTimers = new Map();
        
        const serverUrl = window.location.hostname === 'localhost' ? 'ws://localhost:8080' : 'wss://vipcep-server-production.up.railway.app';
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        function updateCallQueue(queue) {
            currentCallQueue = queue || [];
            document.getElementById('queueCounter').textContent = `${currentCallQueue.length}/5`;
            renderCallQueue();
            if (currentCallQueue.length > 0) playNotificationSound(); else stopNotificationSound();
        }

        function renderCallQueue() {
            const list = document.getElementById('callQueueList');
            if (currentCallQueue.length === 0) {
                list.innerHTML = '<div class="call-queue-empty"><div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">📞</div><div>Henüz gelen arama yok</div></div>';
                return;
            }
            list.innerHTML = [...currentCallQueue].sort((a, b) => a.timestamp - b.timestamp).map((call, index) => {
                const priority = index + 1;
                return `<div class="call-item priority-${Math.min(priority, 5)}">
                    <div class="call-item-content">
                        <div class="call-item-info">
                            <div class="call-item-name">${call.userName}</div>
                            <div class="call-item-details">
                                <span>ID: ${call.userId}</span>
                                <span>💳 ${call.credits} dk</span>
                                <span>📍 Sıra: ${priority}</span>
                            </div>
                            <div class="call-item-timer">${formatTimer(Date.now() - call.timestamp)}</div>
                        </div>
                        <div class="call-item-actions">
                            <button class="btn btn-accept btn-small" onclick="acceptCall('${call.callId}')">✅ Kabul</button>
                            <button class="btn btn-reject btn-small" onclick="rejectCall('${call.callId}')">❌ Ret</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function formatTimer(ms) {
            const s = Math.floor(ms / 1000), m = Math.floor(s / 60);
            return `${m.toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function acceptCall(callId) {
            const call = currentCallQueue.find(c => c.callId === callId);
            if (!call || currentCall || outgoingCallInfo) return alert('Arama bulunamadı veya zaten aramada!');
            stopNotificationSound();
            if (socket?.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'accept-call-by-id', callId, userId: call.userId, adminId: adminUniqueId || originalAdminId }));
                setupCall(call);
            }
        }

        function rejectCall(callId) {
            if (socket?.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'reject-call-by-id', callId, reason: 'Admin reddetti' }));
            }
        }

        async function setupCall(callInfo) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                peerConnection = new RTCPeerConnection(rtcConfig);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = e => { if (e.streams?.[0]) document.getElementById('remoteAudio').srcObject = e.streams[0]; };
                peerConnection.onicecandidate = e => { if (e.candidate && socket) socket.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate, targetId: callInfo.userId })); };
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'connected') {
                        currentCall = callInfo;
                        document.getElementById('activeCaller').textContent = callInfo.userName;
                        document.getElementById('activeCall').classList.remove('hidden');
                        document.getElementById('callQueueContainer').style.display = 'none';
                        startTimer();
                    } else if (['failed', 'disconnected'].includes(peerConnection.connectionState)) endCall();
                };
            } catch (error) { alert('Mikrofon erişimi gerekli!'); }
        }

        function playNotificationSound() {
            try { new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuG0fLVgDIGHm6++9uYSQwOUarm7a5jFgU+ltryxnkpBSl+zPLaizsIGGS57uGQQAoUXrTp66hVFApGn+DyvmwhBSuG0fLVgDIGHm6++9uYSQwOUarm7a5jFgU=').play(); } catch (e) {}
        }
        function stopNotificationSound() {}

        window.onload = () => { checkAuthStatus(); };

        async function checkAuthStatus() {
            try {
                const r = await fetch('/auth/check-session', { credentials: 'include' });
                if (r.ok) {
                    const d = await r.json();
                    if (d.authenticated && ['normal', 'super'].includes(d.role)) return loginSuccess(d);
                }
            } catch (e) {}
            window.location.href = '/';
        }

        function loginSuccess(adminData) {
            isLoggedIn = true;
            currentAdmin = adminData;
            document.getElementById('adminName').textContent = adminData.username || 'Admin';
            connectToServer();
            loadUsers();
        }

        async function performLogout() {
            if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) {}
                if (socket) socket.close();
                if (currentCall) endCall();
                window.location.href = '/';
            }
        }

        async function loadUsers() {
            try {
                const r = await fetch('/api/approved-users', { credentials: 'include' });
                if (r.ok) {
                    const users = await r.json();
                    approvedUsers = users.map(u => ({ id: u.id, name: u.name, credits: u.credits || 0 }));
                    renderUsers();
                    updateStats();
                }
            } catch (e) {}
        }

        function renderUsers() {
            const container = document.getElementById('approvedUsersList');
            const users = filteredUsers.length > 0 ? filteredUsers : approvedUsers;
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 30px;"><div style="font-size: 48px; margin-bottom: 10px;">👥</div><div>Henüz onaylı kullanıcı yok</div></div>';
                return;
            }
            container.innerHTML = users.map(user => {
                const isOnline = connectedUsers.some(u => u.id === user.id && u.userType === 'customer');
                const canCall = isOnline && !currentCall && !outgoingCallInfo;
                return `<div class="user-item ${isOnline ? 'online-user' : ''}">
                    <div class="user-info">
                        <div class="user-id">#${user.id}</div>
                        <div class="user-name">${user.name}</div>
                        <div class="user-credits">${user.credits} dakika kredi</div>
                        <div class="user-status ${isOnline ? 'online' : ''}">${isOnline ? '🟢 Çevrimiçi' : '⚫ Çevrimdışı'}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-call" ${canCall ? `onclick="callUser('${user.id}')"` : 'disabled'}>📞 Ara</button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateStats() {
            document.getElementById('totalApproved').textContent = approvedUsers.length;
            document.getElementById('onlineUsers').textContent = connectedUsers.filter(u => u.userType === 'customer').length;
            document.getElementById('totalCredits').textContent = approvedUsers.reduce((sum, u) => sum + u.credits, 0);
        }

        function connectToServer() {
            if (!isLoggedIn) return;
            try {
                socket = new WebSocket(serverUrl);
                socket.onopen = () => {
                    updateStatus('connected');
                    socket.send(JSON.stringify({ type: 'register', userId: originalAdminId, name: currentAdmin.username || 'Admin', userType: 'admin' }));
                };
                socket.onclose = () => { updateStatus('disconnected'); if (isLoggedIn) setTimeout(connectToServer, 3000); };
                socket.onmessage = e => handleMessage(JSON.parse(e.data));
            } catch (e) { updateStatus('error'); }
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'admin-registered': adminUniqueId = msg.uniqueId; break;
                case 'call-queue-update': updateCallQueue(msg.queue); break;
                case 'user-list-update': connectedUsers = msg.users || []; updateStats(); renderUsers(); break;
                case 'call-taken': 
                    if (msg.takenBy !== (adminUniqueId || originalAdminId)) {
                        currentCallQueue = currentCallQueue.filter(call => call.callId !== msg.callId);
                        updateCallQueue(currentCallQueue);
                    }
                    break;
            }
        }

        function updateStatus(status) {
            document.getElementById('statusDot').className = 'status-dot ' + (status === 'connected' ? 'connected' : 'disconnected');
            document.getElementById('statusText').textContent = status === 'connected' ? 'Bağlı' : 'Bağlantı Yok';
        }

        function startTimer() {
            callDuration = 0;
            callTimer = setInterval(() => {
                callDuration++;
                const mins = Math.floor(callDuration / 60), secs = callDuration % 60;
                document.getElementById('callTimer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function endCall() {
            if (callTimer) { clearInterval(callTimer); callTimer = null; }
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            if (currentCall && socket) socket.send(JSON.stringify({ type: 'end-call', userId: adminUniqueId || originalAdminId, targetId: currentCall.userId, duration: callDuration, userType: 'admin', endedBy: 'admin' }));
            document.getElementById('activeCall').classList.add('hidden');
            document.getElementById('callQueueContainer').style.display = 'block';
            currentCall = null; callDuration = 0;
        }

        function searchUsers() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            filteredUsers = term === '' ? [] : approvedUsers.filter(u => u.name.toLowerCase().includes(term) || u.id.includes(term));
            renderUsers();
        }

        function callUser(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user || !connectedUsers.find(u => u.id === userId && u.userType === 'customer')) return alert('Kullanıcı bulunamadı veya çevrimdışı!');
            if (currentCall || outgoingCallInfo) return alert('Zaten bir aramada bulunuyorsunuz!');
            // Basit implementasyon - giden arama gösterimi
            outgoingCallInfo = { userId, userName: user.name, credits: user.credits };
            document.getElementById('outgoingName').textContent = user.name;
            document.getElementById('outgoingId').textContent = userId;
            document.getElementById('outgoingCall').classList.remove('hidden');
            document.getElementById('callQueueContainer').style.display = 'none';
        }

        function cancelOutgoingCall() {
            document.getElementById('outgoingCall').classList.add('hidden');
            document.getElementById('callQueueContainer').style.display = 'block';
            outgoingCallInfo = null;
        }

        function dismissCancelledCall() { document.getElementById('callCancelled').classList.add('hidden'); }
        function dismissTakenCall() { document.getElementById('callTaken').classList.add('hidden'); }
        function refreshData() { loadUsers(); }
    </script>
</body>
</html>
